<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - MediCare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js';
      document.head.appendChild(script);
    }
  </script>
 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
  
    .flatpickr-calendar {
      border-radius: 16px !important;
      box-shadow: 0 2px 16px rgba(0,0,0,0.08) !important;
      border: none !important;
      width: 320px !important;
      background: #fff !important;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .flatpickr-months {
      background: #fff !important;
      color: #222 !important;
      border-radius: 16px 16px 0 0 !important;
      padding: 12px 0 0 0 !important;
      margin-bottom: 0 !important;
    }
    .flatpickr-current-month {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 1.3em !important;
      font-weight: 700 !important;
      color: #222 !important;
      height: 40px !important;
      margin-bottom: 0 !important;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month .numInputWrapper {
      color: #222 !important;
      font-weight: 700 !important;
    }
    .flatpickr-day {
      color: #222 !important;
      font-weight: 500 !important;
      background: transparent !important;
      border-radius: 50% !important;
      border: none !important;
      transition: background 0.2s, color 0.2s;
      margin: 2px 0 !important;
    }
    .flatpickr-day.selected, .flatpickr-day.today {
      background: #1677ff !important;
      color: #fff !important;
      border-radius: 50% !important;
    }
    .flatpickr-day:hover, .flatpickr-day:focus {
      background: #e6f0ff !important;
      color: #1677ff !important;
    }
    .flatpickr-weekdays {
      background: #fff !important;
      color: #bdbdbd !important;
      font-weight: 600 !important;
      border: none !important;
    }
    .flatpickr-weekday {
      color: #bdbdbd !important;
      font-weight: 600 !important;
      border: none !important;
    }
    .flatpickr-day.disabled, .flatpickr-day.nextMonthDay, .flatpickr-day.prevMonthDay {
      color: #e0e0e0 !important;
      background: transparent !important;
      cursor: not-allowed !important;
    }
    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
      color: #bdbdbd !important;
      fill: #bdbdbd !important;
      top: 16px !important;
    }

    .tab-active {
      background-color: white;
      color: #1f2937;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem;
    }
    .tab-inactive {
      background-color: transparent;
      color: #4b5563;
    }
    .tab-inactive:hover {
      color: #1f2937;
      background-color: rgba(255, 255, 255, 0.6);
      border-radius: 0.375rem;
    }
    .doctor-row {
      cursor: pointer;
      background-color: white;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
    }
    .doctor-row.active {
      background-color: #f3f4f6;
      color: black;
    }
    .blurred-bg {
      position: relative;
    }
    .blurred-bg::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 40;
      backdrop-filter: blur(6px);
    }
    .blurred-bg > *:not(#viewDetailsModalOverlay):not(#appointmentDetailsModalOverlay):not(#availabilityModalOverlay):not(#rescheduleModalOverlay):not(#cancelModalOverlay):not(#addDoctorModalOverlay):not(#patientDetailsModalOverlay) {
      filter: blur(4px);
      pointer-events: none;
      user-select: none;
    }
    #viewDetailsModalOverlay,
    #appointmentDetailsModalOverlay,
    #availabilityModalOverlay,
    #rescheduleModalOverlay,
    #cancelModalOverlay,
    #addDoctorModalOverlay,
    #patientDetailsModalOverlay {
      z-index: 50;
    }
    body {
      overflow-y: hidden;
    }
    #patientDetailsModal .grid {
      background: #f9fafb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    #patientDetailsModal .font-semibold {
      color: #6b7280;
    }
    #patientDetailsModal .text-gray-900 {
      font-weight: 500;
    }
    
    .blurred-bg .flatpickr-calendar {
      filter: none !important;
      backdrop-filter: none !important;
      pointer-events: auto !important;
      user-select: auto !important;
    }
  
    .flatpickr-day.today:not(.selected) {
      background: #f3f4f6 !important;
      color: #222 !important;
      border-radius: 50% !important;
      border: none !important;
    }

    .flatpickr-day.selected {
      background: #1677ff !important;
      color: #fff !important;
      border-radius: 50% !important;
    }
    
    .flatpickr-current-month .numInputWrapper,
    .flatpickr-current-month .flatpickr-year {
      display: none !important;
    }
    .flatpickr-current-month {
      justify-content: center !important;
    }

    #availabilityModal {
      border-radius: 1.25rem !important;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12) !important;
      padding: 2rem !important;
      background: #fff !important;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #availabilityModal h2 {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 1.5rem;
    }
    #availabilityModal input[type="text"] {
      font-size: 1.125rem;
      border-radius: 0.75rem;
    }
    #availabilityModal button[type="submit"] {
      background: #2563eb;
      color: #fff;
      font-size: 1.125rem;
      border-radius: 0.75rem;
    }
    #availabilityModal button[type="button"] {
      font-size: 1.125rem;
      border-radius: 0.75rem;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
<script>
  if (!localStorage.getItem('admin_jwt')) {
    window.location.href = 'login.html';
  }
</script>

<nav class="bg-white shadow py-2 px-[110px]">
  <div class="flex justify-between items-center w-full">
    <div class="text-blue-600 font-bold text-xl">MediCare</div>
    <button id="signOutBtn" title="Sign Out" class="bg-red-500 hover:bg-red-600 text-white rounded-full p-2 flex items-center justify-center transition-colors duration-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 17l5-5m0 0l-5-5m5 5H9m4 5v1a2 2 0 01-2 2H7a2 2 0 01-2-2V6a2 2 0 012-2h4a2 2 0 012 2v1" />
      </svg>
    </button>
  </div>
</nav>

<div class="p-8">
  <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
    <div>
      <h2 class="text-2xl font-semibold px-20">Admin Dashboard</h2>
      <p class="text-gray-500 px-20">Manage appointments, doctors, and patients</p>
    </div>
    <div class="flex items-center gap-4 px-20 ">
   
      <div class="relative w-60 ">
        <img src="/search.webp" alt="Search" class="absolute left-2 top-1/2 transform -translate-y-1/2 w-5 h-5 pointer-events-none" />
        <input type="text" id="searchInput" placeholder="Search" class="pl-8 py-[20px] h-12 rounded w-full bg-gray-100 border border-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400" />
      </div>
     
      <div class="relative w-60 mt-5">
        <div id="datePickerDisplay" class="flex items-center justify-center w-full py-[20px] h-12 rounded bg-gray-100 border border-gray-800 cursor-pointer focus:ring-2 focus:ring-gray-400 select-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <rect x="3" y="4" width="18" height="18" rx="2" fill="#e5e7eb"/>
            <path stroke="#9ca3af" stroke-width="2" d="M8 2v4M16 2v4M3 10h18"/>
          </svg>
          <span id="datePickerText" class="text-gray-700">2025-06-23</span>
        </div>
        <input type="text" id="datePicker" style="position:absolute; left:-9999px;" readonly autocomplete="off" />
      </div>
    </div>
  </div>


  <div class="px-20 mt-4">
    <div class="bg-gray-200 p-1 rounded-lg flex items-center mb-6">
      <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-active" data-tab="appointmentsTab">Appointments</button>
      <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-inactive" data-tab="doctorsTab">Doctors</button>
      <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-inactive" data-tab="patientsTab">Patients</button>
    </div>
  </div>


  <div class="px-20">
    <div class="bg-white p-6 rounded-lg shadow">
     
      <div id="appointmentsTab" class="tab-content">
       
        <div class="flex items-center gap-2 mb-4" id="appointmentsFilterBar">
          <label for="appointmentStatusFilter" class="font-medium text-gray-700">Show:</label>
          <select id="appointmentStatusFilter" class="border rounded px-2 py-1">
            <option value="all">All Appointments</option>
            <option value="confirmed">Confirmed</option>
            <option value="rescheduled">Rescheduled</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-xl font-semibold" id="appointmentsTitle">Today's Appointments</h3>
            <p class="text-gray-500" id="selectedDate">No date selected</p>
          </div>
          <a href="appointment.html"><button id="addBtn" class="bg-black text-white px-4 py-1 rounded font-semibold">+ Add Appointment</button></a>
        </div>
        <div id="appointmentsList">
        </div>
      </div>

      
      <div id="doctorsTab" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-xl font-semibold">Doctors</h3>
            <p class="text-gray-500">Manage doctor profiles and schedules</p>
          </div>
          <button id="addDoctorBtn" class="bg-black text-white px-4 py-1 rounded font-semibold">+ Add Doctor</button>
        </div>
       
        <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-3 text-left text-sm font-bold bg-gray-50 text-gray-800 border-b">
          <div class="col-span-3">Doctor</div>
          <div class="col-span-2">Specialty</div>
          <div class="col-span-2">Today's Appointments</div>
          <div class="col-span-3">Availability</div>
          <div class="col-span-2">Actions</div>
        </div>
        
        <div id="doctorsList" class="space-y-2 mt-2"></div>
        
       
        <div id="doctorsPagination" class="flex justify-center items-center space-x-2 mt-4 hidden">
          <button id="prevDoctorsPage" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
            Previous
          </button>
          <span id="doctorsPageInfo" class="text-sm text-gray-600"></span>
          <button id="nextDoctorsPage" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
            Next
          </button>
        </div>
      </div>

      
      <div id="patientsTab" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-xl font-semibold">Patients List</h3>
            <p class="text-gray-500">View and manage patient records</p>
          </div>
        </div>
        
        <div id="patientsHeader" class="grid grid-cols-12 gap-4 px-4 py-3 text-left text-sm font-bold bg-gray-50 text-gray-800 border-b" style="display: none;">
          <div class="col-span-3">Patient</div>
          <div class="col-span-2">Age/Gender</div>
          <div class="col-span-1">Blood</div>
          <div class="col-span-2">Contact</div>
          <div class="col-span-2">Upcoming Date</div>
          <div class="col-span-2">Last Visit</div>
        </div>
       
        <div id="patientsList" class="space-y-2 mt-2">
          
        </div>
      </div>
    </div>
  </div>
</div>
<div id="availabilityModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="availabilityModal" class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md relative">
    <h2 class="text-3xl font-bold mb-6">Manage Availability</h2>
    <form id="availabilityForm" class="space-y-6">
      <div>
        <label class="block text-lg font-semibold mb-2">Date</label>
        <div class="relative">
          <input type="text" id="availabilityDate" name="date" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg pr-12 focus:ring-2 focus:ring-blue-200" placeholder="MM/DD/YYYY" required readonly />
          <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <rect x="3" y="4" width="18" height="18" rx="2" fill="#e5e7eb"/>
              <path stroke="#9ca3af" stroke-width="2" d="M8 2v4M16 2v4M3 10h18"/>
            </svg>
          </span>
        </div>
      </div>
      <div>
        <label class="block text-lg font-semibold mb-2">Time</label>
        <div class="flex gap-2">
          <input type="text" id="availabilityStart" name="start" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg text-center" placeholder="10:00 AM" required />
          <span class="flex items-center text-lg font-semibold">-</span>
          <input type="text" id="availabilityEnd" name="end" class="w-full border border-gray-300 rounded-lg px-4 py-3 text-lg text-center" placeholder="05:00 PM" required />
        </div>
      </div>
      <div class="flex justify-between gap-4 pt-2">
        <button type="button" id="cancelAvailability" class="w-1/2 px-4 py-3 rounded-lg border border-gray-300 bg-white text-black text-lg font-semibold hover:bg-gray-100">Cancel</button>
        <button type="submit" class="w-1/2 px-4 py-3 rounded-lg bg-blue-600 text-white text-lg font-semibold hover:bg-blue-700">Save</button>
      </div>
    </form>
    <button id="closeAvailabilityModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
  </div>
</div>


<div id="appointmentDetailsModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="appointmentDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeAppointmentDetailsModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    
  
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Viewing Details</h2>
      <div class="mt-4 text-lg font-semibold text-blue-600" id="modalAppointmentPatientName"></div>
      <div class="mt-2 text-md font-medium text-gray-600" id="modalDoctorName"></div>
      <div class="mt-2 text-sm text-gray-500" id="modalDateTime"></div>
    </div>

    
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Age:</span>
          <span id="modalAge" class="font-medium text-gray-900"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Gender:</span>
          <span id="modalGender" class="font-medium text-gray-900"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Blood Group:</span>
          <span id="modalBlood" class="font-medium text-gray-900"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Contact:</span>
          <span id="modalContact" class="font-medium text-gray-900"></span>
        </div>
      </div>
    </div>

   
    <div class="flex justify-end mt-6">
      <button id="closeAppointmentDetailsBtn" class="px-4 py-2 rounded border border-gray-300 bg-white text-gray-700 font-semibold hover:bg-gray-50">
        Close
      </button>
    </div>
  </div>
</div>


<div id="assignDoctorModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="assignDoctorModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeAssignDoctorModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Assign Doctor</h2>
    <div class="mb-4">
      <p class="text-gray-600 mb-2">Patient: <span id="assignPatientName" class="font-semibold"></span></p>
      <p class="text-gray-600 mb-4">Appointment: <span id="assignDateTime" class="font-semibold"></span></p>
    </div>
    <form id="assignDoctorForm">
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Select Doctor</label>
        <select id="doctorSelect" class="w-full border border-gray-300 rounded px-3 py-2" required>
          <option value="">Choose a doctor...</option>
         
        </select>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" id="cancelAssignDoctor" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Assign Doctor</button>
      </div>
    </form>
  </div>
</div>


<div id="viewDetailsModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="viewDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-2xl relative">
    <button id="closeViewDetailsModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    
 
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Appointment Details</h2>
      <div class="mt-4 text-lg font-semibold text-blue-600" id="viewDetailsPatient"></div>
      <div class="mt-2 text-md font-medium text-gray-600" id="viewDetailsDoctor"></div>
      <div class="mt-2 text-sm text-gray-500" id="viewDetailsDateTime"></div>
    </div>


    <div class="bg-gray-50 rounded-lg p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Doctor Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Name:</span>
              <span id="viewDetailsDoctorName" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Specialty:</span>
              <span id="viewDetailsDoctorSpecialty" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>

        
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Appointment Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Date:</span>
              <span id="viewDetailsDate" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Time:</span>
              <span id="viewDetailsTime" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Status:</span>
              <span id="viewDetailsStatus" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>

       
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Personal Details</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Name:</span>
              <span id="viewDetailsPatientName" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Age:</span>
              <span id="viewDetailsAge" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Gender:</span>
              <span id="viewDetailsGender" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>

   
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Contact Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Phone:</span>
              <span id="viewDetailsContact" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Blood Group:</span>
              <span id="viewDetailsBlood" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

 
    <div class="flex justify-end mt-6">
      <button id="okViewDetailsModal" class="px-6 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-200">
        Close
      </button>
    </div>
  </div>
</div>


<div id="rescheduleModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="rescheduleModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeRescheduleModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-xl font-bold mb-2">Reschedule Appointment</h2>
    <div class="mb-4 text-gray-600" id="reschedulePatientName"></div>
    <form id="rescheduleForm">
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">New Date</label>
        <input
          type="text"
          id="rescheduleDate"
          class="text-center py-2 rounded w-full bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-200"
          placeholder="Select new date"
          readonly
          autocomplete="off"
        />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">New Time</label>
        <input type="time" id="rescheduleTime" class="w-full border border-gray-300 rounded px-3 py-2" required />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Reason for Rescheduling</label>
        <textarea id="rescheduleReason" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional reason for rescheduling"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" id="cancelRescheduleBtn" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Reschedule</button>
      </div>
    </form>
  </div>
</div>


<div id="cancelModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="cancelModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeCancelModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-red-600">Cancel Appointment</h2>
    <div class="mb-6 text-gray-700">Are you sure you want to cancel this appointment?</div>
    <div class="flex justify-end gap-2">
      <button id="cancelCancelBtn" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">No</button>
      <button id="confirmCancelBtn" class="px-4 py-2 rounded bg-red-600 text-white font-semibold">Yes, Cancel</button>
    </div>
  </div>
</div>


<div id="addDoctorModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="addDoctorModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeAddDoctorModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-6 text-gray-800">Add Doctor</h2>
    <form id="addDoctorForm">
      <div class="mb-4">
        <label for="doctorName" class="block text-gray-700 text-sm font-semibold mb-2">Doctor</label>
        <input type="text" id="doctorName" name="name" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="mb-4">
          <label for="doctorSpecialty" class="block text-gray-700 text-sm font-semibold mb-2">Specialty</label>
          <input type="text" id="doctorSpecialty" name="specialty" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
        </div>
        <div class="mb-4">
          <label for="doctorExperience" class="block text-gray-700 text-sm font-semibold mb-2">Experience</label>
          <input type="text" id="doctorExperience" name="experience" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div class="mb-4">
          <label for="doctorQualification" class="block text-gray-700 text-sm font-semibold mb-2">Qualification</label>
          <input type="text" id="doctorQualification" name="qualification" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        <div class="mb-4">
          <label for="doctorAvailability" class="block text-gray-700 text-sm font-semibold mb-2">Availability</label>
          <input type="text" id="doctorAvailability" name="availability" placeholder="e.g., 9:00 AM - 5:00 PM" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
        </div>
      </div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-8 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-200">Add</button>
      </div>
    </form>
  </div>
</div>


<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
    <p id="alertMessage" class="text-center text-lg"></p>
    <div class="mt-4 flex justify-center">
      <button onclick="hideAlert()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">OK</button>
    </div>
  </div>
</div>


<div id="patientDetailsModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="patientDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closePatientDetailsModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Patient Details</h2>
    <div class="grid grid-cols-2 gap-4">
      <div class="font-semibold text-gray-600">Name</div>
      <div id="modalPatientName" class="text-gray-900"></div>
      <div class="font-semibold text-gray-600">Age/Gender</div>
      <div id="modalPatientAgeGender" class="text-gray-900"></div>
      <div class="font-semibold text-gray-600">Blood</div>
      <div id="modalPatientBlood" class="text-gray-900"></div>
      <div class="font-semibold text-gray-600">Contact</div>
      <div id="modalPatientContact" class="text-gray-900"></div>
      <div class="font-semibold text-gray-600">Upcoming Date</div>
      <div id="modalPatientUpcoming" class="text-gray-900"></div>
      <div class="font-semibold text-gray-600">Last Visit</div>
      <div id="modalPatientLastVisit" class="text-gray-900"></div>
    </div>
    <div class="flex justify-end mt-6">
      <button id="closePatientDetailsBtn" class="px-4 py-2 rounded border border-gray-300 bg-white text-gray-700 font-semibold hover:bg-gray-50">
        Close
      </button>
    </div>
  </div>
</div>

<div id="editDoctorModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="editDoctorModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeEditDoctorModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Edit Doctor Profile</h2>
    <form id="editDoctorForm">
      <div class="mb-4">
        <label for="editDoctorName" class="block text-gray-700 text-sm font-semibold mb-2">Doctor</label>
        <input type="text" id="editDoctorName" name="name" class="w-full border border-gray-300 rounded px-3 py-2" required />
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="mb-4">
          <label for="editDoctorSpecialty" class="block text-gray-700 text-sm font-semibold mb-2">Specialty</label>
          <input type="text" id="editDoctorSpecialty" name="specialty" class="w-full border border-gray-300 rounded px-3 py-2" required />
        </div>
        <div class="mb-4">
          <label for="editDoctorExperience" class="block text-gray-700 text-sm font-semibold mb-2">Experience</label>
          <input type="text" id="editDoctorExperience" name="experience" class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>
        <div class="mb-4">
          <label for="editDoctorQualification" class="block text-gray-700 text-sm font-semibold mb-2">Qualification</label>
          <input type="text" id="editDoctorQualification" name="qualification" class="w-full border border-gray-300 rounded px-3 py-2" />
        </div>
        <div class="mb-4">
          <label for="editDoctorAvailability" class="block text-gray-700 text-sm font-semibold mb-2">Availability</label>
          <input type="text" id="editDoctorAvailability" name="availability" class="w-full border border-gray-300 rounded px-3 py-2" required />
        </div>
      </div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-8 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-200">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  const datePicker = document.getElementById("datePicker");
  const selectedDate = document.getElementById("selectedDate");
  const appointmentsList = document.getElementById("appointmentsList");
  const addBtn = document.getElementById("addBtn");
  const searchInput = document.getElementById("searchInput");

 
  flatpickr("#datePicker", {
    dateFormat: "Y-m-d",
    allowInput: false,
    defaultDate: new Date(),

  static: true,
    onReady: function(selectedDates, dateStr, instance) {
      
      const monthElem = instance.calendarContainer.querySelector('.flatpickr-current-month');
      if (monthElem) {
       
        const yearInput = monthElem.querySelector('.numInputWrapper');
        if (yearInput) yearInput.style.display = 'none';
        
        const yearDropdown = monthElem.querySelector('.flatpickr-yearDropdown-years');
        if (yearDropdown) yearDropdown.style.display = 'none';
        
        const yearSpan = monthElem.querySelector('.flatpickr-year');
        if (yearSpan) yearSpan.style.display = 'none';
        
        monthElem.style.justifyContent = 'center';
      
        const monthName = monthElem.querySelector('.cur-month');
        if (monthName) {
          monthName.style.fontWeight = 'bold';
          monthName.style.fontSize = '1.3em';
        }
      }
    },
    onChange: function(selectedDates, dateStr, instance) {
     
      const displayText = selectedDates[0]?.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) || '';
      document.getElementById('datePickerText').textContent = displayText;
      document.getElementById('datePicker').value = dateStr;
    
      if (document.getElementById('selectedDate')) {
        document.getElementById('selectedDate').textContent = displayText;
      }
    
      const activeTab = document.querySelector('.tab.tab-active').getAttribute('data-tab');
      if (activeTab === 'doctorsTab') {
        fetchAndDisplayDoctors(dateStr);
      }
     
      if (activeTab === 'appointmentsTab') {
        renderAppointmentsList(dateStr, searchInput.value.trim());
      }

      if (activeTab === 'patientsTab') {
        fetchAndDisplayPatients(dateStr, searchInput.value.trim());
      }
    }
  });
  document.getElementById('datePickerDisplay').addEventListener('click', function() {
    console.log('[Flatpickr] datePickerDisplay clicked');
    if (document.getElementById('datePicker')._flatpickr) {
      document.getElementById('datePicker')._flatpickr.open();
      console.log('[Flatpickr] Calendar opened');
    } else {
      console.error('[Flatpickr] Flatpickr instance not found!');
    }
  });

  
  const style = document.createElement('style');
  style.innerHTML = `
  .flatpickr-calendar {
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: none;
    width: 320px;
    background: #18141f;
  }
  .flatpickr-months {
    background: #18141f;
    color: #fff;
    border-radius: 12px 12px 0 0;
    padding: 12px;
  }
  .flatpickr-current-month .flatpickr-monthDropdown-months,
  .flatpickr-current-month .numInputWrapper {
    color: #fff;
    font-weight: 500;
  }
  .flatpickr-day {
    color: #bdb6d7;
    font-weight: 500;
  }
  .flatpickr-day.selected, .flatpickr-day.today {
    background: #a084e8;
    color: #fff;
    border-radius: 50%;
  }
  .flatpickr-day:hover {
    background: #e0d7fa;
    color: #18141f;
  }
  .flatpickr-weekdays {
    background: #18141f;
    color: #bdb6d7;
    font-weight: 600;
  }
  .flatpickr-weekday {
    color: #bdb6d7;
  }
  .flatpickr-months .flatpickr-prev-month,
  .flatpickr-months .flatpickr-next-month {
    color: #fff;
    fill: #fff;y
  }
  `;
  document.head.appendChild(style);

  
  document.getElementById('datePicker').style.color = 'transparent';

  
  const today = new Date();
  document.getElementById('datePicker').value = today.toISOString().split('T')[0];
  document.getElementById('selectedDate').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('datePickerText').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

  async function fetchAppointments(date, searchDoctorName = '', status = 'all') {
    try {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      });

      let url = '/api/confirmations';
      if (status && status !== 'all') {
        url += `?status=${encodeURIComponent(status)}`;
      }
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Failed to fetch appointments: ${response.status}`);
      }
      const data = await response.json();
      
      if (data.length > 0) {
        console.log('First appointment details:', JSON.stringify(data[0], null, 2));
      }


      const filteredAppointments = data.filter(app => {
        if (!app.dateData?.date) {
          console.log('Appointment missing date data:', app);
          return false;
        }
        
        const appointmentDate = app.dateData.date.trim();
        const matchesDate = appointmentDate === formattedDate;
        
       
        const appointmentDoctorName = app.doctorData?.name || app.doctorName || '';
        const matchesDoctor = !searchDoctorName || 
          (appointmentDoctorName && appointmentDoctorName.toLowerCase().includes(searchDoctorName.toLowerCase()));
        
        if (searchDoctorName && appointmentDoctorName) {
          console.log(`Checking doctor: "${appointmentDoctorName}" against search: "${searchDoctorName}" - matches: ${matchesDoctor}`);
        }
        
        return matchesDate && matchesDoctor;
      });

      console.log('Filtered appointments count:', filteredAppointments.length);
      console.log('Filtered appointments:', filteredAppointments);
      return filteredAppointments;
    } catch (error) {
      console.error('Error in fetchAppointments:', error);
      throw error;
    }
  }
  let currentAppointmentsPage = 1;
  const appointmentsPerPage = 5;
  let allAppointmentsData = [];
  let currentPatientsPage = 1;
  const patientsPerPage = 5;
  let allPatientsData = [];

  async function renderAppointmentsList(date, filterDoctor = "", statusFilter = "all") {
    try {
      appointmentsList.innerHTML = `
        <div class=\"flex justify-center items-center p-4\">
          <div class=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500\"></div>
          <span class=\"ml-2 text-gray-600\">Loading appointments...</span>
        </div>
      `;

      const appointments = await fetchAppointments(date, filterDoctor, statusFilter);
      let filteredAppointments = appointments;
      
      
      const uniqueStatuses = [...new Set(appointments.map(app => app.status))];
      console.log('All unique status values in appointments:', uniqueStatuses);
      console.log('Status filter selected:', statusFilter);
      
      if (statusFilter !== "all") {
        filteredAppointments = appointments.filter(app => {
          const appointmentStatus = app.status || 'confirmed'; 
          
          
          let matches = false;
          if (statusFilter.toLowerCase() === 'cancelled') {
            matches = appointmentStatus.toLowerCase() === 'cancelled' || appointmentStatus.toLowerCase() === 'canceled';
          } else {
            matches = appointmentStatus.toLowerCase() === statusFilter.toLowerCase();
          }
          
          console.log(`Appointment status: "${appointmentStatus}" vs filter: "${statusFilter}" - matches: ${matches}`);
          return matches;
        });
        console.log(`Filtered appointments for status "${statusFilter}":`, filteredAppointments.length);
      }
      allAppointmentsData = filteredAppointments; 
      const totalPages = Math.ceil(filteredAppointments.length / appointmentsPerPage);
      if (currentAppointmentsPage > totalPages && totalPages > 0) {
        currentAppointmentsPage = totalPages;
      } else if (totalPages === 0) {
        currentAppointmentsPage = 1;
      }

      if (!filteredAppointments || filteredAppointments.length === 0) {
        const formattedDate = new Date(date).toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        appointmentsList.innerHTML = `
          <div class=\"p-4 text-center text-gray-500\">
            <div class=\"mb-4\">
              <svg class=\"w-12 h-12 mx-auto text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />
              </svg>
            </div>
            <p class=\"text-lg font-medium mb-2\">No appointments found</p>
            <p class=\"text-sm\">${formattedDate}</p>
            ${filterDoctor ? `<p class=\"text-sm mt-1\">for Dr. ${filterDoctor}</p>` : ''}
          </div>
        `;
        return;
      }

      
      filteredAppointments = filteredAppointments.slice().sort((a, b) => {
        const parseTime = t => {
          if (!t) return 0;
          
          const [time, modifier] = t.split(' ');
          let [hours, minutes] = time.split(':').map(Number);
          if (modifier && modifier.toUpperCase() === 'PM' && hours !== 12) hours += 12;
          if (modifier && modifier.toUpperCase() === 'AM' && hours === 12) hours = 0;
          return hours * 60 + minutes;
        };
        return parseTime(a.dateData?.time) - parseTime(b.dateData?.time);
      });

     
      const startIndex = (currentAppointmentsPage - 1) * appointmentsPerPage;
      const endIndex = startIndex + appointmentsPerPage;
      const currentPageAppointments = filteredAppointments.slice(startIndex, endIndex);

     
      let tableHTML = `
        <div class=\"overflow-x-auto\">
          <table class=\"min-w-full bg-white rounded-lg shadow-sm\">
            <thead>
              <tr class=\"bg-gray-50 text-gray-700 text-left\">
                <th class=\"px-4 py-3\">Patient</th>
                <th class=\"px-4 py-3\">Doctor</th>
                <th class=\"px-4 py-3\">Time</th>
                <th class=\"px-4 py-3\">Status</th>
                <th class=\"px-4 py-3\">Actions</th>
              </tr>
            </thead>
            <tbody>
    `;

     
      tableHTML += currentPageAppointments.map((app, idx) => {
        const doctorName = app.doctorData?.name || '';
        const isCanceled = app.status === 'canceled' || app.status === 'cancelled';
        const isRescheduled = app.status === 'rescheduled';
        
        let statusLabel = `<span class=\"inline-block px-3 py-1 rounded-full text-xs font-semibold bg-green-200 text-green-700\">confirmed</span>`;
        if (isRescheduled) {
          statusLabel = `<span class=\"inline-block px-3 py-1 rounded-full text-xs font-semibold bg-yellow-200 text-yellow-800\">rescheduled</span>`;
        } else if (isCanceled) {
          statusLabel = `<span class=\"inline-block px-3 py-1 rounded-full text-xs font-semibold bg-red-200 text-red-700\">canceled</span>`;
        }
        return `
          <tr class=\"border-b hover:bg-gray-50 transition-colors\">
            <td class=\"px-4 py-3\">
              <div class=\"font-semibold text-gray-900\">${app.patientData?.name || 'N/A'}</div>
              <div class=\"text-xs text-gray-500\">${app.patientData?.contact || ''}</div>
            </td>
            <td class=\"px-4 py-3\">
              <div class=\"font-semibold text-blue-700\">${doctorName}</div>
              <div class=\"text-xs text-gray-500\">${app.doctorData?.specialty || ''}</div>
            </td>
            <td class=\"px-4 py-3\">
              <div class=\"flex items-center gap-1\">
                <svg class=\"w-4 h-4 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" /></svg>
                <span>${app.dateData?.time || 'N/A'}</span>
              </div>
            </td>
            <td class=\"px-4 py-3\">
              ${statusLabel}
            </td>
            <td class=\"px-4 py-3 relative\">
              <button class=\"action-btn text-xl focus:outline-none\">...</button>
              <div class=\"action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20\">
                <a href=\"#\" class=\"view-details-btn block px-4 py-2 hover:bg-gray-100 text-gray-700\" data-appointment='${JSON.stringify(app)}'>View Details</a>
                ${!isCanceled ? `<a href=\"#\" class=\"edit-appointment-btn block px-4 py-2 hover:bg-gray-100 text-gray-700\" data-appointment='${JSON.stringify(app)}'>Edit Appointment</a>` : ''}
                ${!isCanceled ? `<a href=\"#\" class=\"reschedule-btn block px-4 py-2 hover:bg-gray-100 text-gray-700\" data-appointment='${JSON.stringify(app)}'>Reschedule</a>` : ''}
                ${!isCanceled ? `<a href=\"#\" class=\"cancel-btn block px-4 py-2 hover:bg-gray-100 text-red-600\" data-appointment='${JSON.stringify(app)}'>Cancel Appointment</a>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tableHTML += `</tbody></table></div>`;

      
      if (totalPages > 1) {
        tableHTML += `
          <div class=\"flex justify-between items-center mt-6 px-4\">
            <div class=\"text-sm text-gray-600\">
              Showing ${startIndex + 1} to ${Math.min(endIndex, filteredAppointments.length)} of ${filteredAppointments.length} appointments
            </div>
            <div class=\"flex items-center space-x-2\">
              <button onclick=\"changeAppointmentsPage(${currentAppointmentsPage - 1})\" 
                class=\"px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200\"
                ${currentAppointmentsPage === 1 ? 'disabled' : ''}>
                Previous
              </button>
              <span class=\"text-sm text-gray-600\">
                Page ${currentAppointmentsPage} of ${totalPages}
              </span>
              <button onclick=\"changeAppointmentsPage(${currentAppointmentsPage + 1})\" 
                class=\"px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200\"
                ${currentAppointmentsPage === totalPages ? 'disabled' : ''}>
                Next
              </button>
            </div>
          </div>
        `;
      }

      appointmentsList.innerHTML = tableHTML;
    } catch (error) {
      console.error('Error in renderAppointmentsList:', error);
      appointmentsList.innerHTML = `
        <div class=\"p-4 text-center text-red-500\">
          <p class=\"font-semibold\">Error loading appointments</p>
          <p class=\"text-sm mt-2\">${error.message || 'Please try again later'}</p>
          <button onclick=\"renderAppointmentsList('${date}', '${filterDoctor}', '${statusFilter}')\" class=\"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600\">
            Retry
          </button>
        </div>
      `;
    }
  }

  
  function changeAppointmentsPage(newPage) {
    const totalPages = Math.ceil(allAppointmentsData.length / appointmentsPerPage);
    if (newPage < 1 || newPage > totalPages) return;
    currentAppointmentsPage = newPage;
    
    const date = document.getElementById('datePicker').value;
    const searchTerm = document.getElementById('searchInput').value.trim();
    renderAppointmentsList(date, searchTerm);
  }

  
  let searchTimeout;
  searchInput.addEventListener("input", () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const currentDate = datePicker.value;
      const searchTerm = searchInput.value.trim();
      console.log('Search term changed:', searchTerm);
      
     
      currentAppointmentsPage = 1;
      currentPatientsPage = 1;
      
      
      const activeTab = document.querySelector('.tab.tab-active').getAttribute('data-tab');
      
      if (activeTab === 'appointmentsTab') {
        renderAppointmentsList(currentDate, searchTerm);
      } else if (activeTab === 'patientsTab') {
        fetchAndDisplayPatients(currentDate, searchTerm);
      }
    }, 300); 
  });

  
  searchInput.addEventListener("keyup", (e) => {
    if (e.key === "Escape") {
      searchInput.value = "";
      const currentDate = datePicker.value;
      const activeTab = document.querySelector('.tab.tab-active').getAttribute('data-tab');
      
      if (activeTab === 'appointmentsTab') {
        renderAppointmentsList(currentDate, "");
      } else if (activeTab === 'patientsTab') {
        fetchAndDisplayPatients(currentDate, "");
      }
    }
  });

  
  renderAppointmentsList(today);

  
const tabs = document.querySelectorAll(".tab");
const tabContents = document.querySelectorAll(".tab-content");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("tab-active", "tab-inactive"));
      tabs.forEach(t => t.classList.add("tab-inactive"));
      tab.classList.remove("tab-inactive");
      tab.classList.add("tab-active");

      const targetId = tab.getAttribute("data-tab");
      tabContents.forEach(c => c.classList.add("hidden"));
      document.getElementById(targetId).classList.remove("hidden");

      
      if (targetId === 'appointmentsTab') {
        currentAppointmentsPage = 1;
      } else if (targetId === 'patientsTab') {
        currentPatientsPage = 1;
      }

      
      const date = datePicker.value;
      const searchTerm = searchInput.value.trim();

      
      if (targetId === 'appointmentsTab') {
        renderAppointmentsList(date, searchTerm);
      } else if (targetId === 'patientsTab') {
        fetchAndDisplayPatients(date, searchTerm);
      } else if (targetId === 'doctorsTab') {
        fetchAndDisplayDoctors(date);
      }
    });
  });

  
  async function fetchAndDisplayPatients(date = null, searchTerm = '') {
    try {
      const response = await fetch('/api/confirmations');
      if (!response.ok) throw new Error('Failed to fetch patient data');
      
      const allAppointments = await response.json();
      const patientsListContainer = document.getElementById('patientsList');
      const patientsHeader = document.getElementById('patientsHeader');
      patientsListContainer.innerHTML = '<div class="text-center p-4">Loading patients...</div>';

      const formattedSelectedDate = date ? new Date(date).toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      }) : null;
      
      
      const patientsMap = new Map();
      allAppointments.forEach(app => {
       
        if (!app.patientData || !app.patientData.name) {
          return;
        }
        const patientKey = `${app.patientData.name}-${app.patientData.contact}`;
        if (!patientsMap.has(patientKey)) {
          patientsMap.set(patientKey, {
            details: app.patientData,
            appointments: []
          });
        }
        if (app.dateData && app.dateData.date) {
          patientsMap.get(patientKey).appointments.push({
            date: app.dateData.date,
            status: app.status || 'confirmed'
          });
        }
      });
      
     
      const finalPatientList = [];
      for (const [patientKey, patientData] of patientsMap.entries()) {
        const patientName = patientData.details.name || '';
        const matchesSearch = !searchTerm || patientName.toLowerCase().includes(searchTerm.toLowerCase());

        
        const hasAppointmentOnDate = formattedSelectedDate 
          ? patientData.appointments.some(a => a.date === formattedSelectedDate)
          : true; 
        
        if (matchesSearch && hasAppointmentOnDate) {
          finalPatientList.push(patientData);
        }
      }

    
      allPatientsData = finalPatientList;
      
      
      currentPatientsPage = 1;

      if (finalPatientList.length === 0) {
       
        if (patientsHeader) {
          patientsHeader.style.display = 'none';
        }
        
        let message = 'No patients found';
        if (searchTerm) message += ` for "${searchTerm}"`;
        if (formattedSelectedDate) message += ` with appointments on ${new Date(date).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`;
        patientsListContainer.innerHTML = `
          <div class="p-4 text-center text-gray-500">
            <div class="mb-4">
              <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
            <p class="text-lg font-medium mb-2">No patients found</p>
            <p class="text-sm">${message}</p>
          </div>
        `;
        return;
      }

      
      if (patientsHeader) {
        patientsHeader.style.display = 'grid';
      }

      
      renderPatientsListWithPagination();

    } catch (error) {
      console.error('Error fetching patient data:', error);
      
      const patientsHeader = document.getElementById('patientsHeader');
      if (patientsHeader) {
        patientsHeader.style.display = 'none';
      }
      document.getElementById('patientsList').innerHTML = `
        <div class="p-4 text-center text-red-500">
          <p class="font-semibold">Error loading patient data</p>
          <p class="text-sm mt-2">${error.message || 'Please try again later'}</p>
          <button onclick="fetchAndDisplayPatients('${date}', '${searchTerm}')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
            Retry
          </button>
        </div>
      `;
    }
  }

  
  function renderPatientsListWithPagination() {
    const patientsListContainer = document.getElementById('patientsList');
    const patientsHeader = document.getElementById('patientsHeader');
    
    if (patientsHeader) {
      patientsHeader.style.display = 'none';
    }
    if (!allPatientsData || allPatientsData.length === 0) {
      patientsListContainer.innerHTML = '<div class="p-4 text-center text-gray-500">No patients found</div>';
      return;
    }
    
    if (patientsHeader) {
      patientsHeader.style.display = 'grid';
    }
    
   
    const totalPages = Math.ceil(allPatientsData.length / patientsPerPage);
    const startIndex = (currentPatientsPage - 1) * patientsPerPage;
    const endIndex = startIndex + patientsPerPage;
    const currentPagePatients = allPatientsData.slice(startIndex, endIndex);

   
    let patientsHTML = '';
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    currentPagePatients.forEach(patient => {
      const sortedAppointments = patient.appointments
        .map(a => new Date(a.date))
        .sort((a, b) => a - b);
      
      const futureAppointments = sortedAppointments.filter(d => d >= today);
      const pastAppointments = sortedAppointments.filter(d => d < today);

      const upcomingDate = futureAppointments.length > 0
        ? futureAppointments[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
        : '<span class="text-gray-400">N/A</span>';
      
      const lastVisit = pastAppointments.length > 0
        ? pastAppointments[pastAppointments.length - 1].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
        : '<span class="text-gray-400">N/A</span>';

      // Check if all appointments are cancelled
      const allCancelled = patient.appointments.length > 0 && patient.appointments.every(a => (a.status || '').toLowerCase() === 'canceled' || (a.status || '').toLowerCase() === 'cancelled');

      patientsHTML += `
        <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
          <!-- Patient -->
          <div class="col-span-3 flex items-center">
            <div class="w-8 h-8 bg-gray-200 rounded-full mr-4 flex-shrink-0 cursor-pointer patient-placeholder" 
              data-patient='${JSON.stringify({
                name: patient.details.name || 'N/A',
                age: patient.details.age || 'N/A',
                gender: patient.details.gender || 'N/A',
                blood: patient.details.blood || 'N/A',
                contact: patient.details.contact || 'N/A',
                upcomingDate: upcomingDate.replace(/<[^>]+>/g, ''),
                lastVisit: lastVisit.replace(/<[^>]+>/g, '')
              })}'
            ></div>
            <div>
              <div class="font-semibold ${allCancelled ? 'text-red-600' : 'text-gray-800'}">${patient.details.name || 'N/A'}</div>
              <div class="text-xs text-gray-500">PAT-${patient.details.contact ? String(patient.details.contact).slice(-4) : '0000'}</div>
            </div>
          </div>
          <!-- Age/Gender -->
          <div class="col-span-2 text-gray-600">${patient.details.age || 'N/A'} / ${patient.details.gender ? patient.details.gender.charAt(0) : 'N/A'}</div>
          <!-- Blood Group -->
          <div class="col-span-1 text-gray-600">${patient.details.blood || 'N/A'}</div>
          <!-- Contact -->
          <div class="col-span-2 text-gray-600">${patient.details.contact || 'N/A'}</div>
          <!-- Upcoming Date -->
          <div class="col-span-2 text-gray-600">${upcomingDate}</div>
          <!-- Last Visit -->
          <div class="col-span-2 text-gray-600">${lastVisit}</div>
        </div>
      `;
    });

    
    if (totalPages > 1) {
      patientsHTML += `
        <div class="flex justify-between items-center mt-6 px-4">
          <div class="text-sm text-gray-600">
            Showing ${startIndex + 1} to ${Math.min(endIndex, allPatientsData.length)} of ${allPatientsData.length} patients
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="changePatientsPage(${currentPatientsPage - 1})" 
              class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200"
              ${currentPatientsPage === 1 ? 'disabled' : ''}>
              Previous
            </button>
            <span class="text-sm text-gray-600">
              Page ${currentPatientsPage} of ${totalPages}
            </span>
            <button onclick="changePatientsPage(${currentPatientsPage + 1})" 
              class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200"
              ${currentPatientsPage === totalPages ? 'disabled' : ''}>
              Next
            </button>
          </div>
        </div>
      `;
    }

    patientsListContainer.innerHTML = patientsHTML;
  }

 
  function changePatientsPage(newPage) {
    if (newPage < 1 || newPage > Math.ceil(allPatientsData.length / patientsPerPage)) {
      return;
    }
    
    currentPatientsPage = newPage;
    renderPatientsListWithPagination();
  }
  window.changePatientsPage = changePatientsPage;

  let currentDoctor = null;

  
  function openAvailabilityModal(doctorName) {
    currentDoctor = doctorName;
    document.getElementById('availabilityModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
   
    document.getElementById('availabilityForm').reset();
  }

  
  function closeAvailabilityModal() {
    document.getElementById('availabilityModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    currentDoctor = null;
  }

  document.getElementById('cancelAvailability').onclick = closeAvailabilityModal;
  document.getElementById('closeAvailabilityModal').onclick = closeAvailabilityModal;
  document.getElementById('availabilityModalOverlay').onclick = function(e) {
    if (e.target === this) closeAvailabilityModal();
  };

  document.getElementById('availabilityForm').onsubmit = async function(e) {
    e.preventDefault();
    const date = document.getElementById('availabilityDate').value;
    const start = document.getElementById('availabilityStart').value;
    const end = document.getElementById('availabilityEnd').value;
    if (!currentDoctor) return;
    
    const payload = {
      doctor: currentDoctor,
      date,
      start,
      end
    };
    try {
      
      const response = await fetch('/api/doctor-availability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('Failed to save availability');
      
      closeAvailabilityModal();
     
    } catch (err) {
      alert('Error saving availability: ' + err.message);
    }
  };

  
  function attachManageAvailabilityListeners() {
    document.querySelectorAll('.action-menu a').forEach(link => {
      if (link.textContent.trim() === 'Manage Availability') {
        link.onclick = function(e) {
          e.preventDefault();
          
          const row = link.closest('tr');
          let doctorName = row ? row.querySelector('td.font-semibold, td.font-medium')?.textContent.trim() : '';
          openAvailabilityModal(doctorName);
        };
      }
    });
  }
  
  attachManageAvailabilityListeners();
  

  function openAppointmentDetailsModal(app) {
    
    const doctorName = 
      app.doctorData?.name || 
      app.doctor?.name || 
      app.doctorName || 
      app.assignedDoctor?.name ||
      app.assigned_doctor?.name ||
      'Not Assigned';
    
    
    document.getElementById('viewDetailsPatient').textContent = app.patientData?.name || 'N/A';
    document.getElementById('viewDetailsDoctor').textContent = doctorName;
    document.getElementById('viewDetailsDateTime').textContent = `${app.dateData?.date || 'N/A'} at ${app.dateData?.time || 'N/A'}`;
    
    
    document.getElementById('viewDetailsDoctorName').textContent = doctorName;
    document.getElementById('viewDetailsDoctorSpecialty').textContent = app.doctorData?.specialty || 'N/A';
    
  
    document.getElementById('viewDetailsDate').textContent = app.dateData?.date || 'N/A';
    document.getElementById('viewDetailsTime').textContent = app.dateData?.time || 'N/A';
    document.getElementById('viewDetailsStatus').textContent = app.status || 'confirmed';
    
  
    document.getElementById('viewDetailsPatientName').textContent = app.patientData?.name || 'N/A';
    document.getElementById('viewDetailsAge').textContent = app.patientData?.age || 'N/A';
    document.getElementById('viewDetailsGender').textContent = app.patientData?.gender || 'N/A';
    
   
    document.getElementById('viewDetailsContact').textContent = app.patientData?.contact || 'N/A';
    document.getElementById('viewDetailsBlood').textContent = app.patientData?.blood || 'N/A';
    
    document.getElementById('viewDetailsModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }

  
  document.getElementById('closeViewDetailsModal').onclick = function() {
    document.getElementById('viewDetailsModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
  };

  document.getElementById('okViewDetailsModal').onclick = function() {
    document.getElementById('viewDetailsModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
  };

  document.getElementById('viewDetailsModalOverlay').onclick = function(e) {
    if (e.target === this) {
      document.getElementById('viewDetailsModalOverlay').classList.add('hidden');
      document.body.classList.remove('blurred-bg');
    }
  };

  
  let currentAppointmentForAssignment = null;

  async function loadDoctors() {
    try {
      const response = await fetch('/api/doctors');
      if (!response.ok) throw new Error('Failed to fetch doctors');
      const doctors = await response.json();
      
      const select = document.getElementById('doctorSelect');
      select.innerHTML = '<option value="">Choose a doctor...</option>' +
        doctors.map(doctor => `
          <option value="${doctor._id}">
            Dr. ${doctor.name} - ${doctor.specialty}
          </option>
        `).join('');
    } catch (error) {
      console.error('Error loading doctors:', error);
      alert('Failed to load doctors. Please try again.');
    }
  }

  function openAssignDoctorModal(appointment) {
    currentAppointmentForAssignment = appointment;
    document.getElementById('assignPatientName').textContent = appointment.patientData?.name || 'N/A';
    document.getElementById('assignDateTime').textContent = 
      `${appointment.dateData?.date || 'N/A'} at ${appointment.dateData?.time || 'N/A'}`;
    
    loadDoctors();
    document.getElementById('assignDoctorModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }

  function closeAssignDoctorModal() {
    document.getElementById('assignDoctorModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    currentAppointmentForAssignment = null;
  }

  
  document.getElementById('closeAssignDoctorModal').onclick = closeAssignDoctorModal;
  document.getElementById('cancelAssignDoctor').onclick = closeAssignDoctorModal;
  document.getElementById('assignDoctorModalOverlay').onclick = function(e) {
    if (e.target === this) closeAssignDoctorModal();
  };

  document.getElementById('assignDoctorForm').onsubmit = async function(e) {
    e.preventDefault();
    if (!currentAppointmentForAssignment) return;

    const doctorId = document.getElementById('doctorSelect').value;
    if (!doctorId) {
      alert('Please select a doctor');
      return;
    }

    try {
      const response = await fetch(`/api/appointments/${currentAppointmentForAssignment._id}/assign-doctor`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ doctorId })
      });

      if (!response.ok) throw new Error('Failed to assign doctor');

      
      const currentDate = datePicker.value;
      const searchTerm = searchInput.value.trim();
      await renderAppointmentsList(currentDate, searchTerm);

      closeAssignDoctorModal();
      alert('Doctor assigned successfully!');
    } catch (error) {
      console.error('Error assigning doctor:', error);
      alert('Failed to assign doctor. Please try again.');
    }
  };


  document.addEventListener('DOMContentLoaded', function() {
 
    const oldClickHandler = document.onclick;
    document.onclick = null;

    
    const activeTab = document.querySelector('.tab.tab-active').getAttribute('data-tab');
    const currentDate = datePicker.value;
    const searchTerm = searchInput.value.trim();
    
    if (activeTab === 'doctorsTab') {
      fetchAndDisplayDoctors(currentDate);
    }

    
    document.addEventListener('click', function(e) {
      
      if (e.target.classList.contains('action-btn')) {
        e.stopPropagation();
        const menus = document.querySelectorAll('.action-menu');
        menus.forEach(menu => menu.classList.add('hidden'));
        const menu = e.target.nextElementSibling;
        menu.classList.toggle('hidden');
      }
      
      
      if (e.target.classList.contains('view-details-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        openAppointmentDetailsModal(appointmentData);
        e.target.closest('.action-menu').classList.add('hidden');
      }
      
      
      if (e.target.classList.contains('edit-appointment-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        
        if (!appointmentData._id) {
          alert('Error: Appointment ID missing. Cannot edit this appointment.');
          return;
        }
        
        if (appointmentData.doctorData) delete appointmentData.doctorData._id;
        if (appointmentData.patientData) delete appointmentData.patientData._id;
        if (appointmentData.dateData) delete appointmentData.dateData._id;
        
        localStorage.setItem('editAppointment', JSON.stringify(appointmentData));
        window.location.href = `appointment.html?edit=1&id=${appointmentData._id}`;
        e.target.closest('.action-menu').classList.add('hidden');
      }
      
      
      if (e.target.classList.contains('reschedule-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        openRescheduleModal(appointmentData);
        e.target.closest('.action-menu').classList.add('hidden');
      }
      
      
      if (e.target.classList.contains('cancel-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        openCancelModal(appointmentData);
        e.target.closest('.action-menu').classList.add('hidden');
      }

      
      if (!e.target.closest('.action-menu') && !e.target.classList.contains('action-btn')) {
        document.querySelectorAll('.action-menu').forEach(menu => menu.classList.add('hidden'));
      }
    });
  });

  let rescheduleAppointmentData = null;
  let cancelAppointmentData = null;

  
  function openRescheduleModal(app) {
    rescheduleAppointmentData = app;
    document.getElementById('reschedulePatientName').textContent = `Reschedule appointment for ${app.patientData?.name || ''}`;
    
    document.getElementById('rescheduleDate').value = app.dateData?.date ? new Date(app.dateData.date).toISOString().split('T')[0] : '';
    document.getElementById('rescheduleTime').value = app.dateData?.time || '';
    document.getElementById('rescheduleReason').value = '';
    document.getElementById('rescheduleModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }

  
  document.getElementById('rescheduleForm').onsubmit = async function(e) {
    e.preventDefault();
    if (!rescheduleAppointmentData || !rescheduleAppointmentData._id) {
      alert('Error: Missing appointment ID.');
      return;
    }
    const newDate = document.getElementById('rescheduleDate').value;
    const newTime = document.getElementById('rescheduleTime').value;
    if (!newDate || !newTime) {
      alert('Please select both date and time.');
      return;
    }
    try {
      
      const formattedDate = new Date(newDate).toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      });
      const response = await fetch(`/api/confirmations/${rescheduleAppointmentData._id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'reschedule',
          date: formattedDate,
          time: newTime
        })
      });
      if (!response.ok) throw new Error('Failed to reschedule appointment');
      closeRescheduleModal();
      showAlert('Appointment rescheduled successfully!');
      
      
      try {
        const currentDate = datePicker.value;
        const searchTerm = searchInput.value.trim();
        console.log('Refreshing appointments list after reschedule...');
        await renderAppointmentsList(currentDate, searchTerm);
        console.log('Appointments list refreshed successfully');
      } catch (refreshError) {
        console.error('Error refreshing appointments list:', refreshError);
       
        window.location.reload();
      }
    } catch (err) {
      alert('Error rescheduling appointment: ' + err.message);
    }
  };

  function closeRescheduleModal() {
    document.getElementById('rescheduleModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    rescheduleAppointmentData = null;
  }
  document.getElementById('closeRescheduleModal').onclick = closeRescheduleModal;
  document.getElementById('cancelRescheduleBtn').onclick = closeRescheduleModal;
  document.getElementById('rescheduleModalOverlay').onclick = function(e) {
    if (e.target === this) closeRescheduleModal();
  };


  function openCancelModal(app) {
    cancelAppointmentData = app;
    document.getElementById('cancelModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
    
    
    const confirmButton = document.getElementById('confirmCancelBtn');
    confirmButton.disabled = false;
    confirmButton.textContent = 'Yes, Cancel';
    confirmButton.classList.remove('opacity-75');
  }
  
  function closeCancelModal() {
    document.getElementById('cancelModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    cancelAppointmentData = null;
    
  
    const confirmButton = document.getElementById('confirmCancelBtn');
    confirmButton.disabled = false;
    confirmButton.textContent = 'Yes, Cancel';
    confirmButton.classList.remove('opacity-75');
  }
  
  document.getElementById('closeCancelModal').onclick = closeCancelModal;
  document.getElementById('cancelCancelBtn').onclick = closeCancelModal;
  document.getElementById('cancelModalOverlay').onclick = function(e) {
    if (e.target === this) closeCancelModal();
  };
  
  document.getElementById('confirmCancelBtn').onclick = async function() {
    if (!cancelAppointmentData || !cancelAppointmentData._id) {
      alert('Error: Missing appointment ID.');
      return;
    }
    
   
    const confirmButton = document.getElementById('confirmCancelBtn');
    confirmButton.disabled = true;
    confirmButton.textContent = 'Canceling...';
    confirmButton.classList.add('opacity-75');
    
    try {
    
      const response = await fetch(`/api/confirmations/${cancelAppointmentData._id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: 'cancel'
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to cancel appointment');
      }

      
      closeCancelModal();

      
      showAlert('Appointment cancelled successfully!');

     
      try {
        const currentDate = datePicker.value;
        const searchTerm = searchInput.value.trim();
        console.log('Refreshing appointments list after cancellation...');
        await renderAppointmentsList(currentDate, searchTerm);
        console.log('Appointments list refreshed successfully');
      } catch (refreshError) {
        console.error('Error refreshing appointments list:', refreshError);
       
        window.location.reload();
      }

    } catch (error) {
      console.error('Error cancelling appointment:', error);
      alert('Error cancelling appointment: ' + error.message);
      
      
      confirmButton.disabled = false;
      confirmButton.textContent = 'Yes, Cancel';
      confirmButton.classList.remove('opacity-75');
    }
  };

  
  const addDoctorBtn = document.getElementById('addDoctorBtn');
  const addDoctorModalOverlay = document.getElementById('addDoctorModalOverlay');
  
  if (addDoctorModalOverlay) {
      const closeAddDoctorModal = document.getElementById('closeAddDoctorModal');

      const openModal = () => {
        addDoctorModalOverlay.classList.remove('hidden');
        document.body.classList.add('blurred-bg');
      };

      const closeModal = () => {
        addDoctorModalOverlay.classList.add('hidden');
        document.body.classList.remove('blurred-bg');
        const form = document.getElementById('addDoctorForm');
        if(form) form.reset();
      };
      
      if(addDoctorBtn) {
          addDoctorBtn.addEventListener('click', openModal);
      }

      if(closeAddDoctorModal) {
          closeAddDoctorModal.addEventListener('click', closeModal);
      }

      addDoctorModalOverlay.addEventListener('click', (e) => {
        if (e.target === addDoctorModalOverlay) {
          closeModal();
        }
      });
      
      const addDoctorForm = document.getElementById('addDoctorForm');
      if(addDoctorForm) {
          addDoctorForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const formData = new FormData(addDoctorForm);
              const doctorData = {
                  name: formData.get('name'),
                  specialty: formData.get('specialty'),
                  experience: formData.get('experience'),
                  qualification: formData.get('qualification'),
                  availability: formData.get('availability')
              };

              try {
                  const response = await fetch('/api/doctors', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(doctorData)
                  });

                  if (!response.ok) {
                      const errorData = await response.json();
                      throw new Error(errorData.error || 'Failed to add doctor');
                  }

                  showAlert('Doctor added successfully!');
                  closeModal();

                 
                  await fetchAndDisplayDoctors();

              } catch (error) {
                  console.error('Error adding doctor:', error);
                  alert('Error adding doctor: ' + error.message);
              }
          });
      }
  }

  
  function showAlert(message) {
    document.getElementById('alertMessage').textContent = message;
    document.getElementById('overlay').style.display = 'flex';
  }

  function hideAlert() {
    document.getElementById('overlay').style.display = 'none';
  }

  document.getElementById('signOutBtn').onclick = function() {
    if (confirm('Are you sure you want to sign out?')) {
      
      window.location.href = 'login.html';
    }
  };

 
  function openPatientDetailsModal(patient) {
    
    let name = patient.name || (patient.details && patient.details.name) || 'N/A';
    let age = patient.age || (patient.details && patient.details.age) || 'N/A';
    let gender = patient.gender || (patient.details && patient.details.gender) || 'N/A';
    let blood = patient.blood || (patient.details && patient.details.blood) || 'N/A';
    let contact = patient.contact || (patient.details && patient.details.contact) || 'N/A';
    document.getElementById('modalPatientName').textContent = name;
    document.getElementById('modalPatientAgeGender').textContent = `${age} / ${gender}`;
    document.getElementById('modalPatientBlood').textContent = blood;
    document.getElementById('modalPatientContact').textContent = contact;
    document.getElementById('modalPatientUpcoming').textContent = patient.upcomingDate || 'N/A';
    document.getElementById('modalPatientLastVisit').textContent = patient.lastVisit || 'N/A';
    document.getElementById('patientDetailsModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }

  function closePatientDetailsModal() {
    document.getElementById('patientDetailsModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
  }

  document.getElementById('patientDetailsModalOverlay').onclick = function(e) {
    if (e.target === this) closePatientDetailsModal();
  };
  document.getElementById('closePatientDetailsModal').onclick = closePatientDetailsModal;
  document.getElementById('closePatientDetailsBtn').onclick = closePatientDetailsModal;

  document.getElementById('patientsList').addEventListener('click', function(e) {
    if (e.target.classList.contains('patient-placeholder')) {
      const patientData = JSON.parse(e.target.getAttribute('data-patient'));
      console.log('Patient data for modal:', patientData); // Debug log
      openPatientDetailsModal(patientData);
    }
  });

  
  let allDoctors = [];
  let currentDoctorsPage = 1;
  const doctorsPerPage = 5;
  let todaysAppointmentsCountMap = {};

  async function fetchAndDisplayDoctors(currentDate) {
    try {
      
      const response = await fetch('/api/doctors');
      if (!response.ok) {
        throw new Error('Failed to fetch doctors');
      }
      allDoctors = await response.json();
      
      allDoctors.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      currentDoctorsPage = 1;
      
     
      const appointmentsRes = await fetch('/api/confirmations');
      const allAppointments = appointmentsRes.ok ? await appointmentsRes.json() : [];
      
      const formattedDate = new Date(currentDate).toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      });
      
      todaysAppointmentsCountMap = {};
      allAppointments.forEach(app => {
        if (
          app.dateData && app.dateData.date === formattedDate &&
          app.status !== 'canceled' && app.status !== 'cancelled'
        ) {
         
          const doctorName = app.doctorData?.name || app.doctorName || '';
          if (doctorName) {
            todaysAppointmentsCountMap[doctorName] = (todaysAppointmentsCountMap[doctorName] || 0) + 1;
          }
        }
      });
      renderDoctorsPage();
    } catch (error) {
      console.error('Error fetching doctors:', error);
    }
  }
  function addDoctorToList(newDoctor) {
    allDoctors.unshift(newDoctor);
    currentDoctorsPage = 1;
    
   
    renderDoctorsPage();
  }
  function renderDoctorsPage() {
    const doctorsList = document.getElementById('doctorsList');
    const paginationContainer = document.getElementById('doctorsPagination');
    if (!doctorsList) return;
    const totalPages = Math.ceil(allDoctors.length / doctorsPerPage);
    const startIndex = (currentDoctorsPage - 1) * doctorsPerPage;
    const endIndex = startIndex + doctorsPerPage;
    const currentDoctors = allDoctors.slice(startIndex, endIndex);
    doctorsList.innerHTML = '';
    currentDoctors.forEach((doctor, idx) => {
      let infoLine = '';
      if (doctor.experience && doctor.qualification) {
        infoLine = `${doctor.experience} yrs exp. · ${doctor.qualification}`;
      } else if (doctor.experience) {
        infoLine = `${doctor.experience} yrs exp.`;
      } else if (doctor.qualification) {
        infoLine = `${doctor.qualification}`;
      }
      let count = 0;
      const doctorName = doctor.name;
      if (todaysAppointmentsCountMap && doctorName in todaysAppointmentsCountMap) {
        count = todaysAppointmentsCountMap[doctorName];
      }
      
      doctorsList.innerHTML += `
        <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
          <div class="col-span-3 flex items-center">
            <div class="w-8 h-8 bg-gray-200 rounded-full mr-4 flex-shrink-0"></div>
            <div>
              <div class="font-semibold text-gray-800">${doctor.name}</div>
              <div class="text-xs text-gray-500">${infoLine}</div>
            </div>
          </div>
          <div class="col-span-2 text-gray-600">${doctor.specialty || 'General Medicine'}</div>
          <div class="col-span-2 text-gray-600">${count}</div>
          <div class="col-span-3 text-gray-600">${doctor.availability || 'Available'}</div>
          <div class="col-span-2 relative">
            <button class="action-btn text-xl">...</button>
            <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
              <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Profile</a>
              <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Edit Profile</a>
              <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Availability</a>
              <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Manage Availability</a>
            </div>
          </div>
        </div>
      `;
    });
    updateDoctorsPagination(totalPages);
  } 

  function updateDoctorsPagination(totalPages) {
    const paginationContainer = document.getElementById('doctorsPagination');
    const prevButton = document.getElementById('prevDoctorsPage');
    const nextButton = document.getElementById('nextDoctorsPage');
    const pageInfo = document.getElementById('doctorsPageInfo');
    if (!paginationContainer) return;
    if (totalPages > 1) {
      paginationContainer.classList.remove('hidden');
    } else {
      paginationContainer.classList.add('hidden');
    }
    pageInfo.textContent = `Page ${currentDoctorsPage} of ${totalPages}`;
    prevButton.disabled = currentDoctorsPage === 1;
    nextButton.disabled = currentDoctorsPage === totalPages;
  }
  document.addEventListener('DOMContentLoaded', function() {
    const prevButton = document.getElementById('prevDoctorsPage');
    const nextButton = document.getElementById('nextDoctorsPage');
    
    if (prevButton) {
      prevButton.addEventListener('click', () => {
        if (currentDoctorsPage > 1) {
          currentDoctorsPage--;
          renderDoctorsPage();
        }
      });
    }
    
    if (nextButton) {
      nextButton.addEventListener('click', () => {
        const totalPages = Math.ceil(allDoctors.length / doctorsPerPage);
        if (currentDoctorsPage < totalPages) {
          currentDoctorsPage++;
          renderDoctorsPage();
        }
      });
    }
  });

  flatpickr("#rescheduleDate", {
    dateFormat: "Y-m-d", 
    
  });

  function renderPatientsListFromData(patients) {
    if (!patients || patients.length === 0) {
      patientsList.innerHTML = `
        <div class="p-4 text-center text-gray-500">
          <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="text-lg font-medium mb-2">No patients found</p>
          <p class="text-sm">No patients found with appointments on ${formattedDate}</p>
        </div>
      `;
      return;
    }

   
    let tableHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-700 text-left">
              <th class="px-4 py-3">Patient</th>
              <th class="px-4 py-3">Age/Gender</th>
              <th class="px-4 py-3">Blood</th>
              <th class="px-4 py-3">Contact</th>
              <th class="px-4 py-3">Upcoming Date</th>
              <th class="px-4 py-3">Last Visit</th>
            </tr>
          </thead>
          <tbody>
         
          </tbody>
        </table>
      </div>
    `;

    patientsList.innerHTML = tableHTML;
  }

  testPatientsPagination();

 
  if (document.getElementById('appointmentStatusFilter')) {
    document.getElementById('appointmentStatusFilter').addEventListener('change', function() {
      const status = this.value;
      const currentDate = datePicker.value;
      const searchTerm = searchInput.value.trim();
      renderAppointmentsList(currentDate, searchTerm, status);
    });
  }

  let currentDoctorForEdit = null;

function openEditDoctorModal(doctor) {
  currentDoctorForEdit = doctor;
  document.getElementById('editDoctorName').value = doctor.name || '';
  document.getElementById('editDoctorSpecialty').value = doctor.specialty || '';
  document.getElementById('editDoctorExperience').value = doctor.experience || '';
  document.getElementById('editDoctorQualification').value = doctor.qualification || '';
  document.getElementById('editDoctorAvailability').value = doctor.availability || '';
  document.getElementById('editDoctorModalOverlay').classList.remove('hidden');
  document.body.classList.add('blurred-bg');
}

function closeEditDoctorModal() {
  document.getElementById('editDoctorModalOverlay').classList.add('hidden');
  document.body.classList.remove('blurred-bg');
  currentDoctorForEdit = null;
}

document.getElementById('closeEditDoctorModal').onclick = closeEditDoctorModal;
document.getElementById('editDoctorModalOverlay').onclick = function(e) {
  if (e.target === this) closeEditDoctorModal();
};

document.getElementById('doctorsList').addEventListener('click', function(e) {
  if (e.target.classList.contains('edit-doctor-profile-btn')) {
    e.preventDefault();
    const doctor = JSON.parse(e.target.getAttribute('data-doctor'));
    openEditDoctorModal(doctor);
    e.target.closest('.action-menu').classList.add('hidden');
  }
});

// Add after renderDoctorsPage and after DOMContentLoaded
if (document.getElementById('doctorsList')) {
  document.getElementById('doctorsList').addEventListener('click', function(e) {
    if (e.target.classList.contains('doctor-photo-placeholder')) {
      const idx = e.target.getAttribute('data-doctor-index');
      const input = document.querySelector(`.doctor-photo-input[data-doctor-index="${idx}"]`);
      if (input) input.click();
    }
  });
  document.getElementById('doctorsList').addEventListener('change', function(e) {
    if (e.target.classList.contains('doctor-photo-input')) {
      const idx = e.target.getAttribute('data-doctor-index');
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          allDoctors[idx].photoUrl = ev.target.result;
          renderDoctorsPage();
        };
        reader.readAsDataURL(file);
      }
    }
  });
}

flatpickr("#availabilityDate", {
  dateFormat: "m/d/Y",
  allowInput: false,
  static: true,
});
flatpickr("#availabilityStart", {
  enableTime: true,
  noCalendar: true,
  dateFormat: "h:i K",
  time_24hr: false,
  allowInput: false,
  static: true,
});
flatpickr("#availabilityEnd", {
  enableTime: true,
  noCalendar: true,
  dateFormat: "h:i K",
  time_24hr: false,
  allowInput: false,
  static: true,
});
</script>


</body>
</html>