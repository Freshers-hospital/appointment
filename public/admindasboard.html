<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - MediCare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js';
      document.head.appendChild(script);
    }
  </script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* New styles for the modern Flatpickr calendar */
    

    .flatpickr-calendar {
      background: #f3f5f7;
      border-radius: 8px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      border: none;
      width: 320px;
    }
    .flatpickr-months {
      background: linear-gradient(45deg, #f1f4f5, #ffffff);
      color: rgb(255, 254, 254);
      border-radius: 8px 8px 0 0;
      padding: 12px;
    }
    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month .numInputWrapper {
      color: white;
      font-weight: 500;
    }
    .flatpickr-current-month .numInputWrapper {
      font-size: 1rem;
    }
    .flatpickr-month, .flatpickr-current-month {
      height: 40px;
    }
    span.cur-month, span.cur-year, .numInput.cur-year {
      font-size: 1.25rem !important;
      font-weight: bold !important;
      color: rgb(22, 21, 21) !important;
    }
    .numInput.cur-year {
        background: transparent;
        border: none;
        pointer-events: none;
        -moz-appearance: textfield;
        appearance: textfield;
    }
    .numInput.cur-year::-webkit-outer-spin-button,
    .numInput.cur-year::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .flatpickr-prev-month, .flatpickr-next-month {
      top: 20px;
      color: white;
      fill: white;
    }
    .flatpickr-prev-month:hover, .flatpickr-next-month:hover {
      color: #eeeeee;
      fill: #eeeeee;
    }
    .flatpickr-weekdays {
      padding: 8px 0;
      background: white;
    }
    span.flatpickr-weekday {
      color: #9ca3af; /* text-gray-400 */
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .dayContainer {
      padding: 0 12px 12px;
    }
    .flatpickr-day {
      color: #374151; /* text-gray-700 */
      font-weight: 500;
      border-radius: 50%;
      height: 36px;
      line-height: 36px;
      margin: 2px 0;
    }
    .flatpickr-day:hover {
      background: #f3f4f6; /* bg-gray-100 */
    }
    .flatpickr-day.today {
      border-color: #4670e4;
      
    }
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
      background: transparent;
      /* border: 2px solid #e8a0bf; */
      color: #374151;
      box-shadow: none;
    }
    .flatpickr-day.disabled, .flatpickr-day.disabled:hover {
      color: #d1d5db; /* text-gray-300 */
      background: transparent;
    }

    .tab-active {
      background-color: white;
      color: #1f2937; /* text-gray-800 */
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      border-radius: 0.375rem; /* .rounded-md */
    }
    .tab-inactive {
      background-color: transparent;
      color: #4b5563; /* text-gray-600 */
    }
    .tab-inactive:hover {
      color: #1f2937; /* text-gray-800 */
      background-color: rgba(229, 231, 235, 0.5); /* bg-gray-200/50 */
      border-radius: 0.375rem; /* .rounded-md */
    }
    .doctor-row {
      cursor: pointer;
      background-color: white;
      color: #4b5563;
      border-bottom: 1px solid #e5e7eb;
    }
    .doctor-row.active {
      background-color: #f3f4f6;
      color: black;
    }
    .blurred-bg {
      position: relative;
    }
    .blurred-bg::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 40;
    }
    .blurred-bg > *:not(#viewDetailsModalOverlay):not(#appointmentDetailsModalOverlay):not(#availabilityModalOverlay):not(#rescheduleModalOverlay):not(#cancelModalOverlay):not(#addDoctorModalOverlay) {
      filter: blur(4px);
      pointer-events: none;
      user-select: none;
    }
    #viewDetailsModalOverlay,
    #appointmentDetailsModalOverlay,
    #availabilityModalOverlay,
    #rescheduleModalOverlay,
    #cancelModalOverlay,
    #addDoctorModalOverlay {
      z-index: 50;
    }
    body {
      overflow-y: hidden;
    }
    /* Only blur the background for doctor profile modal */
    .doctor-profile-blur-bg > #doctorProfileModalOverlay {
      z-index: 60;
    }
    .doctor-profile-blur-bg > *:not(#doctorProfileModalOverlay) {
      filter: blur(4px) !important;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

<nav class="bg-white shadow py-4 px-8">
  <div class="flex justify-between items-center w-full">
    <div class="text-blue-600 font-bold text-xl">MediCare</div>
    <button id="signOutBtn" class="bg-red-500 hover:bg-red-600 text-white rounded px-4 py-2 rounded">Sign Out</button>
  </div>
</nav>

<div class="p-8">
  <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
    <div>
      <h2 class="text-2xl font-semibold px-20">Admin Dashboard</h2>
      <p class="text-gray-500 px-20">Manage appointments, doctors, and patients</p>
    </div>
    <div class="flex items-center gap-4 px-20">
      <div class="relative">
        <img src="/search.webp" alt="Search" class="absolute left-2 top-1/2 transform -translate-y-1/2 w-6 h-6 pointer-events-none" />
        <input type="text" id="searchInput" placeholder="Search " class="pl-8 pr-4 py-0 border border-gray-300 w-48 rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-400 text-gray-700" />
      </div>
      <div class="flex items-center gap-2">
        <label for="datePicker" class="font-semibold"></label>
        <input type="text" id="datePicker" class="border border-gray-300 rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-400 text-gray-700" readonly />
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="px-20 mt-6">
    <div class="bg-gray-100 p-1 rounded-lg flex items-center mb-6">
      <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-active" data-tab="appointmentsTab">Appointments</button>
      <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-inactive" data-tab="doctorsTab">Doctors</button>
      <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-inactive" data-tab="patientsTab">Patients</button>
    </div>
  </div>

  <!-- Main Content Container -->
  <div class="px-20">
    <div class="bg-white p-6 rounded-lg shadow">
      <!-- Appointments Content -->
      <div id="appointmentsTab" class="tab-content">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-xl font-semibold">Today's Appointments</h3>
            <p class="text-gray-500" id="selectedDate">No date selected</p>
          </div>
          <a href="appointment.html"><button id="addBtn" class="bg-black text-white px-4 py-1 rounded font-semibold">+ Add Appointment</button></a>
        </div>
        <div id="appointmentsList">
        </div>
      </div>

      <!-- Doctors Content -->
      <div id="doctorsTab" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-xl font-semibold">Doctors</h3>
            <p class="text-gray-500">Manage doctor profiles and schedules</p>
          </div>
          <button id="addDoctorBtn" class="bg-black text-white px-4 py-1 rounded font-semibold">+ Add Doctor</button>
        </div>
        <!-- Header Row -->
        <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-left text-sm font-semibold text-gray-600 border-b">
          <div class="col-span-3">Doctor</div>
          <div class="col-span-2">Specialty</div>
          <div class="col-span-2">Today's Appointments</div>
          <div class="col-span-3">Availability</div>
          <div class="col-span-2">Actions</div>
        </div>
        <!-- Doctors List Container -->
        <div id="doctorsList" class="space-y-2 mt-2">
          <!-- Doctor items will be injected here by JavaScript -->
          <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
            <!-- Doctor -->
            <div class="col-span-3 flex items-center">
              <span class="font-semibold text-gray-800 px-3">Dr. Sarah Johnson</span>
            </div>
            <!-- Specialty -->
            <div class="col-span-2 text-gray-600">Cardiology</div>
            <!-- Today's Appointments -->
            <div class="col-span-2 text-gray-600">8</div>
            <!-- Availability -->
            <div class="col-span-3 text-gray-600">10:00 AM - 5:00 PM</div>
            <!-- Actions -->
            <div class="col-span-2 relative">
              <button class="action-btn text-xl">...</button>
              <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Edit Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Availability</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Manage Availability</a>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
            <!-- Doctor -->
            <div class="col-span-3 flex items-center">
              <span class="font-semibold text-gray-800 px-3">Dr. Kiran</span>
            </div>
            <!-- Specialty -->
            <div class="col-span-2 text-gray-600">Pediatrics</div>
            <!-- Today's Appointments -->
            <div class="col-span-2 text-gray-600">5</div>
            <!-- Availability -->
            <div class="col-span-3 text-gray-600">8:30 AM - 4:30 PM</div>
            <!-- Actions -->
            <div class="col-span-2 relative">
              <button class="action-btn text-xl">...</button>
              <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Edit Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Availability</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Manage Availability</a>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
            <!-- Doctor -->
            <div class="col-span-3 flex items-center">
              <span class="font-semibold text-gray-800 px-3">Dr. Akhila</span>
            </div>
            <!-- Specialty -->
            <div class="col-span-2 text-gray-600">Neurology</div>
            <!-- Today's Appointments -->
            <div class="col-span-2 text-gray-600">3</div>
            <!-- Availability -->
            <div class="col-span-3 text-gray-600">8:00 AM - 4:00 PM</div>
            <!-- Actions -->
            <div class="col-span-2 relative">
              <button class="action-btn text-xl">...</button>
              <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Edit Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Availability</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Manage Availability</a>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
            <!-- Doctor -->
            <div class="col-span-3 flex items-center">
              <span class="font-semibold text-gray-800 px-3">Dr. Vinod</span>
            </div>
            <!-- Specialty -->
            <div class="col-span-2 text-gray-600">Orthopedics</div>
            <!-- Today's Appointments -->
            <div class="col-span-2 text-gray-600">4</div>
            <!-- Availability -->
            <div class="col-span-3 text-gray-600">9:00 AM - 5:00 PM</div>
            <!-- Actions -->
            <div class="col-span-2 relative">
              <button class="action-btn text-xl">...</button>
              <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Edit Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Availability</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Manage Availability</a>
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
            <!-- Doctor -->
            <div class="col-span-3 flex items-center">
              <span class="font-semibold text-gray-800 px-3">Dr. Srivani</span>
            </div>
            <!-- Specialty -->
            <div class="col-span-2 text-gray-600">Gynecologist</div>
            <!-- Today's Appointments -->
            <div class="col-span-2 text-gray-600">4</div>
            <!-- Availability -->
            <div class="col-span-3 text-gray-600">9:00 AM - 5:00 PM</div>
            <!-- Actions -->
            <div class="col-span-2 relative">
              <button class="action-btn text-xl">...</button>
              <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Edit Profile</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">View Availability</a>
                <a href="#" class="block px-4 py-2 hover:bg-gray-100 text-gray-700">Manage Availability</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Patients Content -->
      <div id="patientsTab" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h3 class="text-xl font-semibold">Patients List</h3>
            <p class="text-gray-500">View and manage patient records</p>
          </div>
        </div>
        <!-- Header Row -->
        <div class="hidden md:grid grid-cols-12 gap-4 px-4 py-2 text-left text-sm font-semibold text-gray-600 border-b">
          <div class="col-span-3">Patient</div>
          <div class="col-span-2">Age/Gender</div>
          <div class="col-span-1">Blood</div>
          <div class="col-span-2">Contact</div>
          <div class="col-span-2">Upcoming Date</div>
          <div class="col-span-2">Last Visit</div>
        </div>
        <!-- Patients List Container -->
        <div id="patientsList" class="space-y-2 mt-2">
          <!-- Patient items will be injected here by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>
<div id="availabilityModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="availabilityModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <h2 class="text-2xl font-bold mb-4">Manage Availability</h2>
    <form id="availabilityForm">
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Date</label>
        <input type="date" id="availabilityDate" name="date" class="w-full border border-gray-300 rounded px-3 py-2" required />
      </div>
      <div class="mb-4 flex gap-2 items-center">
        <div class="flex-1">
          <label class="block text-gray-700 mb-2">Time</label>
          <input type="time" id="availabilityStart" name="start" class="w-full border border-gray-300 rounded px-3 py-2" required />
        </div>
        <span class="mx-2">-</span>
        <div class="flex-1">
          <label class="block text-gray-700 mb-2 invisible">End</label>
          <input type="time" id="availabilityEnd" name="end" class="w-full border border-gray-300 rounded px-3 py-2" required />
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" id="cancelAvailability" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Save</button>
      </div>
    </form>
    <button id="closeAvailabilityModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
  </div>
</div>

<!-- Appointment Details Modal -->
<div id="appointmentDetailsModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="appointmentDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeAppointmentDetailsModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    
    <!-- Card Header -->
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Viewing Details</h2>
      <div class="mt-4 text-lg font-semibold text-blue-600" id="modalPatientName"></div>
      <div class="mt-2 text-md font-medium text-gray-600" id="modalDoctorName"></div>
      <div class="mt-2 text-sm text-gray-500" id="modalDateTime"></div>
    </div>

    <!-- Card Content -->
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="space-y-4">
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Age:</span>
          <span id="modalAge" class="font-medium text-gray-900"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Gender:</span>
          <span id="modalGender" class="font-medium text-gray-900"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Blood Group:</span>
          <span id="modalBlood" class="font-medium text-gray-900"></span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-gray-500">Contact:</span>
          <span id="modalContact" class="font-medium text-gray-900"></span>
        </div>
      </div>
    </div>

    <!-- Card Footer -->
    <div class="flex justify-end mt-6">
      <button id="closeAppointmentDetailsBtn" class="px-4 py-2 rounded border border-gray-300 bg-white text-gray-700 font-semibold hover:bg-gray-50">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Assign Doctor Modal -->
<div id="assignDoctorModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="assignDoctorModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeAssignDoctorModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-4">Assign Doctor</h2>
    <div class="mb-4">
      <p class="text-gray-600 mb-2">Patient: <span id="assignPatientName" class="font-semibold"></span></p>
      <p class="text-gray-600 mb-4">Appointment: <span id="assignDateTime" class="font-semibold"></span></p>
    </div>
    <form id="assignDoctorForm">
      <div class="mb-4">
        <label class="block text-gray-700 mb-2">Select Doctor</label>
        <select id="doctorSelect" class="w-full border border-gray-300 rounded px-3 py-2" required>
          <option value="">Choose a doctor...</option>
          <!-- Will be populated dynamically -->
        </select>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" id="cancelAssignDoctor" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Assign Doctor</button>
      </div>
    </form>
  </div>
</div>

<!-- View Details Modal -->
<div id="viewDetailsModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="viewDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-2xl relative">
    <button id="closeViewDetailsModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    
    <!-- Card Header -->
    <div class="text-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800">Appointment Details</h2>
      <div class="mt-4 text-lg font-semibold text-blue-600" id="viewDetailsPatient"></div>
      <div class="mt-2 text-md font-medium text-gray-600" id="viewDetailsDoctor"></div>
      <div class="mt-2 text-sm text-gray-500" id="viewDetailsDateTime"></div>
    </div>

    <!-- Card Content -->
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Doctor Information -->
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Doctor Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Name:</span>
              <span id="viewDetailsDoctorName" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Specialty:</span>
              <span id="viewDetailsDoctorSpecialty" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>

        <!-- Appointment Information -->
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Appointment Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Date:</span>
              <span id="viewDetailsDate" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Time:</span>
              <span id="viewDetailsTime" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Status:</span>
              <span id="viewDetailsStatus" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>

        <!-- Personal Details -->
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Personal Details</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Name:</span>
              <span id="viewDetailsPatientName" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Age:</span>
              <span id="viewDetailsAge" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Gender:</span>
              <span id="viewDetailsGender" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="border rounded-lg p-4 bg-white">
          <h3 class="text-gray-800 font-semibold text-lg mb-3">Contact Information</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Phone:</span>
              <span id="viewDetailsContact" class="font-medium text-gray-900"></span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-500">Blood Group:</span>
              <span id="viewDetailsBlood" class="font-medium text-gray-900"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card Footer -->
    <div class="flex justify-end mt-6">
      <button id="okViewDetailsModal" class="px-6 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-200">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Reschedule Appointment Modal -->
<div id="rescheduleModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="rescheduleModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeRescheduleModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-xl font-bold mb-2">Reschedule Appointment</h2>
    <div class="mb-4 text-gray-600" id="reschedulePatientName"></div>
    <form id="rescheduleForm">
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">New Date</label>
        <input type="date" id="rescheduleDate" class="w-full border border-gray-300 rounded px-3 py-2" required />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">New Time</label>
        <input type="time" id="rescheduleTime" class="w-full border border-gray-300 rounded px-3 py-2" required />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Reason for Rescheduling</label>
        <textarea id="rescheduleReason" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Optional reason for rescheduling"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" id="cancelRescheduleBtn" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Reschedule</button>
      </div>
    </form>
  </div>
</div>

<!-- Cancel Appointment Modal -->
<div id="cancelModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="cancelModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeCancelModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-xl font-bold mb-4 text-red-600">Cancel Appointment</h2>
    <div class="mb-6 text-gray-700">Are you sure you want to cancel this appointment?</div>
    <div class="flex justify-end gap-2">
      <button id="cancelCancelBtn" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">No</button>
      <button id="confirmCancelBtn" class="px-4 py-2 rounded bg-red-600 text-white font-semibold">Yes, Cancel</button>
    </div>
  </div>
</div>

<!-- Add Doctor Modal -->
<div id="addDoctorModalOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div id="addDoctorModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
    <button id="closeAddDoctorModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-6 text-gray-800">Add Doctor</h2>
    <form id="addDoctorForm">
      <div class="mb-4">
        <label for="doctorName" class="block text-gray-700 text-sm font-semibold mb-2">Doctor</label>
        <input type="text" id="doctorName" name="name" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div class="mb-4">
          <label for="doctorSpecialty" class="block text-gray-700 text-sm font-semibold mb-2">Specialty</label>
          <input type="text" id="doctorSpecialty" name="specialty" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
        </div>
        <div class="mb-4">
          <label for="doctorAvailability" class="block text-gray-700 text-sm font-semibold mb-2">Availability</label>
          <input type="text" id="doctorAvailability" name="availability" placeholder="e.g., 9:00 AM - 5:00 PM" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
        </div>
      </div>
      <div class="flex justify-end mt-4">
        <button type="submit" class="px-8 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-200">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Add this right before the closing body tag -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
    <p id="alertMessage" class="text-center text-lg"></p>
    <div class="mt-4 flex justify-center">
      <button onclick="hideAlert()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">OK</button>
    </div>
  </div>
</div>

<!-- Doctor Profile Modal (View/Edit) -->
<div id="doctorProfileModalOverlay" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40 backdrop-blur-sm hidden">
  <div id="doctorProfileModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative z-60">
    <button id="closeDoctorProfileModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
    <h2 id="doctorProfileModalTitle" class="text-2xl font-bold mb-4">Doctor Profile</h2>
    <form id="doctorProfileForm">
      <div class="flex flex-col items-center mb-4">
        <div class="relative mb-2">
          <img id="doctorProfileImagePreview" src="" alt="Doctor Image" class="w-24 h-24 rounded-full object-cover border-2 border-gray-300" style="background:#f3f4f6;" />
          <label for="doctorProfileImage" class="absolute bottom-0 right-0 bg-blue-600 text-white rounded-full p-1 cursor-pointer" style="display:none;" id="doctorProfileImageEditIcon">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 13h3l8-8a2.828 2.828 0 00-4-4l-8 8v3h3z" /></svg>
            <input type="file" id="doctorProfileImage" name="image" accept="image/*" class="hidden" />
          </label>
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Name</label>
        <input type="text" id="doctorProfileName" name="name" class="w-full border border-gray-300 rounded px-3 py-2" required readonly />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Specialty</label>
        <input type="text" id="doctorProfileSpecialty" name="specialty" class="w-full border border-gray-300 rounded px-3 py-2" required readonly />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Availability</label>
        <input type="text" id="doctorProfileAvailability" name="availability" class="w-full border border-gray-300 rounded px-3 py-2" readonly />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Experience</label>
        <input type="text" id="doctorProfileExperience" name="experience" class="w-full border border-gray-300 rounded px-3 py-2" readonly />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Contact</label>
        <input type="text" id="doctorProfileContact" name="contact" class="w-full border border-gray-300 rounded px-3 py-2" readonly />
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1">Email</label>
        <input type="email" id="doctorProfileEmail" name="email" class="w-full border border-gray-300 rounded px-3 py-2" readonly />
      </div>
      <div class="flex justify-end gap-2 mt-6" id="doctorProfileEditActions" style="display:none;">
        <button type="button" id="cancelEditDoctorProfile" class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  const datePicker = document.getElementById("datePicker");
  const selectedDate = document.getElementById("selectedDate");
  const appointmentsList = document.getElementById("appointmentsList");
  const addBtn = document.getElementById("addBtn");
  const searchInput = document.getElementById("searchInput");

  // Initialize Flatpickr as a popup on the input
  flatpickr("#datePicker", {
    defaultDate: new Date(),
    monthSelectorType: 'static',
    onChange: function(selectedDates, dateStr, instance) {
      document.getElementById('datePicker').value = dateStr;
      // Reset pagination when changing dates
      currentAppointmentsPage = 1;
      // Update dashboard as before
      const formatted = selectedDates[0].toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      document.getElementById('selectedDate').textContent = formatted;
      const activeTab = document.querySelector('.tab.tab-active').getAttribute('data-tab');
      const searchTerm = document.getElementById('searchInput').value.trim();
      if (activeTab === 'appointmentsTab') {
        renderAppointmentsList(dateStr, searchTerm);
      } else if (activeTab === 'patientsTab') {
        fetchAndDisplayPatients(dateStr, searchTerm);
      }
    }
  });
  // Set today's date as default in the input
  const today = new Date();
  document.getElementById('datePicker').value = today.toISOString().split('T')[0];
  document.getElementById('selectedDate').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

  async function fetchAppointments(date, searchDoctorName = '') {
    try {
      const formattedDate = new Date(date).toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      });

      console.log('Fetching appointments for date:', formattedDate, 'with doctor filter:', searchDoctorName);

      const url = `/api/confirmations`;
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`Failed to fetch appointments: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Total appointments fetched:', data.length);
      
      // Log the first appointment in detail
      if (data.length > 0) {
        console.log('First appointment details:', JSON.stringify(data[0], null, 2));
      }

      // Filter appointments
      const filteredAppointments = data.filter(app => {
        if (!app.dateData?.date) {
          console.log('Appointment missing date data:', app);
          return false;
        }
        
        const appointmentDate = app.dateData.date.trim();
        const matchesDate = appointmentDate === formattedDate;
        
        // Get doctor name from the appointment data
        const appointmentDoctorName = app.doctorData?.name || app.doctorName || '';
        const matchesDoctor = !searchDoctorName || 
          (appointmentDoctorName && appointmentDoctorName.toLowerCase().includes(searchDoctorName.toLowerCase()));
        
        if (searchDoctorName && appointmentDoctorName) {
          console.log(`Checking doctor: "${appointmentDoctorName}" against search: "${searchDoctorName}" - matches: ${matchesDoctor}`);
        }
        
        return matchesDate && matchesDoctor;
      });

      console.log('Filtered appointments count:', filteredAppointments.length);
      console.log('Filtered appointments:', filteredAppointments);
      return filteredAppointments;
    } catch (error) {
      console.error('Error in fetchAppointments:', error);
      throw error;
    }
  }

  // Global variables for pagination
  let currentAppointmentsPage = 1;
  const appointmentsPerPage = 7;
  let allAppointmentsData = [];

  async function renderAppointmentsList(date, filterDoctor = "") {
    try {
      appointmentsList.innerHTML = `
        <div class="flex justify-center items-center p-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <span class="ml-2 text-gray-600">Loading appointments...</span>
        </div>
      `;

      const appointments = await fetchAppointments(date, filterDoctor);
      console.log('Appointments data:', appointments);
      
      // Store all appointments data for pagination
      allAppointmentsData = appointments;
      
      // Ensure current page is valid after filtering
      const maxPages = Math.ceil(appointments.length / appointmentsPerPage);
      if (currentAppointmentsPage > maxPages && maxPages > 0) {
        currentAppointmentsPage = maxPages;
      } else if (maxPages === 0) {
        currentAppointmentsPage = 1;
      }
      
      if (!appointments || appointments.length === 0) {
        const formattedDate = new Date(date).toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        appointmentsList.innerHTML = `
          <div class="p-4 text-center text-gray-500">
            <div class="mb-4">
              <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <p class="text-lg font-medium mb-2">No appointments found</p>
            <p class="text-sm">${formattedDate}</p>
            ${filterDoctor ? `<p class="text-sm mt-1">for Dr. ${filterDoctor}</p>` : ''}
          </div>
        `;
        return;
      }

      // Calculate pagination
      const totalPages = Math.ceil(appointments.length / appointmentsPerPage);
      const startIndex = (currentAppointmentsPage - 1) * appointmentsPerPage;
      const endIndex = startIndex + appointmentsPerPage;
      const currentPageAppointments = appointments.slice(startIndex, endIndex);

      // Table header
      let tableHTML = `
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow-sm">
            <thead>
              <tr class="bg-gray-50 text-gray-700 text-left">
                <th class="px-4 py-3">Patient</th>
                <th class="px-4 py-3">Doctor</th>
                <th class="px-4 py-3">Time</th>
                <th class="px-4 py-3">Status</th>
                <th class="px-4 py-3">Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

      // Table rows
      tableHTML += currentPageAppointments.map((app, idx) => {
        console.log('Processing appointment:', JSON.stringify(app, null, 2));

        // Get doctor name from the appointment data
        const doctorName = app.doctorData?.name || '';
        
        // Check if appointment is already canceled
        const isCanceled = app.status === 'canceled';

        return `
          <tr class="border-b hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3">
              <div class="font-semibold text-gray-900">${app.patientData?.name || 'N/A'}</div>
              <div class="text-xs text-gray-500">${app.patientData?.contact || ''}</div>
            </td>
            <td class="px-4 py-3">
              <div class="font-semibold text-blue-700">${doctorName}</div>
              <div class="text-xs text-gray-500">${app.doctorData?.specialty || ''}</div>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center gap-1">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>${app.dateData?.time || 'N/A'}</span>
              </div>
            </td>
            <td class="px-4 py-3">
              <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${app.status === 'pending' ? 'bg-gray-200 text-gray-700' : 
                app.status === 'canceled' ? 'bg-red-200 text-red-700' : 
                'bg-black text-white'}">
                ${app.status ? app.status : 'confirmed'}
              </span>
            </td>
            <td class="px-4 py-3 relative">
              <button class="action-btn text-xl focus:outline-none">...</button>
              <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
                <a href="#" class="view-details-btn block px-4 py-2 hover:bg-gray-100 text-gray-700" data-appointment='${JSON.stringify(app)}'>View Details</a>
                ${!isCanceled ? `<a href="#" class="edit-appointment-btn block px-4 py-2 hover:bg-gray-100 text-gray-700" data-appointment='${JSON.stringify(app)}'>Edit Appointment</a>` : ''}
                ${!isCanceled ? `<a href="#" class="reschedule-btn block px-4 py-2 hover:bg-gray-100 text-gray-700" data-appointment='${JSON.stringify(app)}'>Reschedule</a>` : ''}
                ${!isCanceled ? `<a href="#" class="cancel-btn block px-4 py-2 hover:bg-gray-100 text-red-600" data-appointment='${JSON.stringify(app)}'>Cancel Appointment</a>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');

      tableHTML += `</tbody></table></div>`;

      // Add pagination controls if needed
      if (totalPages > 1) {
        tableHTML += `
          <div class="flex justify-between items-center mt-6 px-4">
            <div class="text-sm text-gray-600">
              Showing ${startIndex + 1} to ${Math.min(endIndex, appointments.length)} of ${appointments.length} appointments
            </div>
            <div class="flex items-center space-x-2">
              <button onclick="changeAppointmentsPage(${currentAppointmentsPage - 1})" 
                class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200"
                ${currentAppointmentsPage === 1 ? 'disabled' : ''}>
                Previous
              </button>
              <span class="text-sm text-gray-600">
                Page ${currentAppointmentsPage} of ${totalPages}
              </span>
              <button onclick="changeAppointmentsPage(${currentAppointmentsPage + 1})" 
                class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200"
                ${currentAppointmentsPage === totalPages ? 'disabled' : ''}>
                Next
              </button>
            </div>
          </div>
        `;
      }

      appointmentsList.innerHTML = tableHTML;

    } catch (error) {
      console.error('Error in renderAppointmentsList:', error);
      appointmentsList.innerHTML = `
        <div class="p-4 text-center text-red-500">
          <p class="font-semibold">Error loading appointments</p>
          <p class="text-sm mt-2">${error.message || 'Please try again later'}</p>
          <button onclick="renderAppointmentsList('${date}', '${filterDoctor}')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
            Retry
          </button>
        </div>
      `;
    }
  }

  // Function to change appointments page
  function changeAppointmentsPage(newPage) {
    if (newPage < 1 || newPage > Math.ceil(allAppointmentsData.length / appointmentsPerPage)) {
      return;
    }
    
    currentAppointmentsPage = newPage;
    const currentDate = datePicker.value;
    const searchTerm = searchInput.value.trim();
    renderAppointmentsList(currentDate, searchTerm);
  }

  // Handle search input changes with debounce
  let searchTimeout;
  searchInput.addEventListener("input", () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const currentDate = datePicker.value;
      const searchTerm = searchInput.value.trim();
      console.log('Search term changed:', searchTerm);
      
      // Reset pagination when searching
      currentAppointmentsPage = 1;
      
      // Determine which tab is active
      const activeTab = document.querySelector('.tab.tab-active').getAttribute('data-tab');
      
      if (activeTab === 'appointmentsTab') {
        renderAppointmentsList(currentDate, searchTerm);
      } else if (activeTab === 'patientsTab') {
        fetchAndDisplayPatients(currentDate, searchTerm);
      }
    }, 300); 
  });

  
  searchInput.addEventListener("keyup", (e) => {
    if (e.key === "Escape") {
      searchInput.value = "";
      const currentDate = datePicker.value;
      const activeTab = document.querySelector('.tab.tab-active').getAttribute('data-tab');
      
      if (activeTab === 'appointmentsTab') {
        renderAppointmentsList(currentDate, "");
      } else if (activeTab === 'patientsTab') {
        fetchAndDisplayPatients(currentDate, "");
      }
    }
  });

  
  renderAppointmentsList(today);

  
const tabs = document.querySelectorAll(".tab");
const tabContents = document.querySelectorAll(".tab-content");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("tab-active", "tab-inactive"));
      tabs.forEach(t => t.classList.add("tab-inactive"));
      tab.classList.remove("tab-inactive");
      tab.classList.add("tab-active");

      const targetId = tab.getAttribute("data-tab");
      tabContents.forEach(c => c.classList.add("hidden"));
      document.getElementById(targetId).classList.remove("hidden");

      // Reset pagination when switching to appointments tab
      if (targetId === 'appointmentsTab') {
        currentAppointmentsPage = 1;
      }

      // Get current date and search term
      const date = datePicker.value;
      const searchTerm = searchInput.value.trim();

      // Update content based on active tab
      if (targetId === 'appointmentsTab') {
        renderAppointmentsList(date, searchTerm);
      } else if (targetId === 'patientsTab') {
        fetchAndDisplayPatients(date, searchTerm);
      }
    });
  });

  // Update the fetchAndDisplayPatients function to handle date filtering
  async function fetchAndDisplayPatients(date = null, searchTerm = '') {
    try {
      const response = await fetch('/api/confirmations');
      if (!response.ok) throw new Error('Failed to fetch patient data');
      
      const allAppointments = await response.json();
      const patientsListContainer = document.getElementById('patientsList');
      patientsListContainer.innerHTML = '<div class="text-center p-4">Loading patients...</div>';

      const formattedSelectedDate = date ? new Date(date).toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      }) : null;
      
      // 1. Group all non-canceled appointments by patient using a composite key (name + contact).
      const patientsMap = new Map();
      allAppointments.forEach(app => {
        // Ignore appointments that are canceled or have no patient name
        if (!app.patientData || !app.patientData.name || app.status === 'canceled') {
          return;
        }
        // Use a combination of name and contact for a more reliable unique key
        const patientKey = `${app.patientData.name}-${app.patientData.contact}`;
        if (!patientsMap.has(patientKey)) {
          patientsMap.set(patientKey, {
            details: app.patientData,
            appointments: []
          });
        }
        if (app.dateData && app.dateData.date) {
          patientsMap.get(patientKey).appointments.push({
            date: app.dateData.date,
            status: app.status || 'confirmed'
          });
        }
      });
      
      // 2. Filter the list of unique patients based on search term AND the selected date.
      const finalPatientList = [];
      for (const [patientKey, patientData] of patientsMap.entries()) {
        const patientName = patientData.details.name || '';
        const matchesSearch = !searchTerm || patientName.toLowerCase().includes(searchTerm.toLowerCase());

        // Date check: Only filter if a date is actually selected.
        const hasAppointmentOnDate = formattedSelectedDate 
          ? patientData.appointments.some(a => a.date === formattedSelectedDate)
          : true; // If no date is selected, this is always true.
        
        if (matchesSearch && hasAppointmentOnDate) {
          finalPatientList.push(patientData);
        }
      }

      if (finalPatientList.length === 0) {
        let message = 'No patients found';
        if (searchTerm) message += ` for "${searchTerm}"`;
        if (formattedSelectedDate) message += ` with appointments on ${new Date(date).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`;
        patientsListContainer.innerHTML = `<div class="text-center p-6 text-gray-500">${message}.</div>`;
        return;
      }

      // 3. Calculate upcoming and last visit for each patient and build HTML
      let patientsHTML = '';
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      finalPatientList.forEach(patient => {
        const sortedAppointments = patient.appointments
          .map(a => new Date(a.date))
          .sort((a, b) => a - b);
        
        const futureAppointments = sortedAppointments.filter(d => d >= today);
        const pastAppointments = sortedAppointments.filter(d => d < today);

        const upcomingDate = futureAppointments.length > 0
          ? futureAppointments[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
          : '<span class="text-gray-400">N/A</span>';
        
        const lastVisit = pastAppointments.length > 0
          ? pastAppointments[pastAppointments.length - 1].toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
          : '<span class="text-gray-400">N/A</span>';

        patientsHTML += `
          <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
            <!-- Patient -->
            <div class="col-span-3 flex items-center">
              <span class="font-semibold text-gray-800 px-3">${patient.details.name || 'N/A'}</span>
            </div>
            <!-- Age/Gender -->
            <div class="col-span-2 text-gray-600">${patient.details.age || 'N/A'} / ${patient.details.gender ? patient.details.gender.charAt(0) : 'N/A'}</div>
            <!-- Blood Group -->
            <div class="col-span-1 text-gray-600">${patient.details.blood || 'N/A'}</div>
            <!-- Contact -->
            <div class="col-span-2 text-gray-600">${patient.details.contact || 'N/A'}</div>
            <!-- Upcoming Date -->
            <div class="col-span-2 text-gray-600">${upcomingDate}</div>
            <!-- Last Visit -->
            <div class="col-span-2 text-gray-600">${lastVisit}</div>
          </div>
        `;
      });

      patientsListContainer.innerHTML = patientsHTML;

    } catch (error) {
      console.error('Error fetching patient data:', error);
      document.getElementById('patientsList').innerHTML = `
        <div class="p-4 text-center text-red-500">
          Error loading patient data. Please try again later.
        </div>
      `;
    }
  }

  let currentDoctor = null;

  
  function openAvailabilityModal(doctorName) {
    currentDoctor = doctorName;
    document.getElementById('availabilityModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
   
    document.getElementById('availabilityForm').reset();
  }

  // Close modal and remove blur
  function closeAvailabilityModal() {
    document.getElementById('availabilityModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    currentDoctor = null;
  }

  document.getElementById('cancelAvailability').onclick = closeAvailabilityModal;
  document.getElementById('closeAvailabilityModal').onclick = closeAvailabilityModal;
  document.getElementById('availabilityModalOverlay').onclick = function(e) {
    if (e.target === this) closeAvailabilityModal();
  };

  document.getElementById('availabilityForm').onsubmit = async function(e) {
    e.preventDefault();
    const date = document.getElementById('availabilityDate').value;
    const start = document.getElementById('availabilityStart').value;
    const end = document.getElementById('availabilityEnd').value;
    if (!currentDoctor) return;
    // Example payload
    const payload = {
      doctor: currentDoctor,
      date,
      start,
      end
    };
    try {
      
      const response = await fetch('/api/doctor-availability', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('Failed to save availability');
      
      closeAvailabilityModal();
     
    } catch (err) {
      alert('Error saving availability: ' + err.message);
    }
  };

  // Attach event listeners to all Manage Availability links/buttons
  function attachManageAvailabilityListeners() {
    document.querySelectorAll('.action-menu a').forEach(link => {
      if (link.textContent.trim() === 'Manage Availability') {
        link.onclick = function(e) {
          e.preventDefault();
          // Find doctor name from the row
          const row = link.closest('tr');
          let doctorName = row ? row.querySelector('td.font-semibold, td.font-medium')?.textContent.trim() : '';
          openAvailabilityModal(doctorName);
        };
      }
    });
  }
  
  attachManageAvailabilityListeners();
  

  function openAppointmentDetailsModal(app) {
    
    const doctorName = 
      app.doctorData?.name || 
      app.doctor?.name || 
      app.doctorName || 
      app.assignedDoctor?.name ||
      app.assigned_doctor?.name ||
      'Not Assigned';
    
    // Populate header information
    document.getElementById('viewDetailsPatient').textContent = app.patientData?.name || 'N/A';
    document.getElementById('viewDetailsDoctor').textContent = doctorName;
    document.getElementById('viewDetailsDateTime').textContent = `${app.dateData?.date || 'N/A'} at ${app.dateData?.time || 'N/A'}`;
    
    // Populate Doctor Information
    document.getElementById('viewDetailsDoctorName').textContent = doctorName;
    document.getElementById('viewDetailsDoctorSpecialty').textContent = app.doctorData?.specialty || 'N/A';
    
    // Populate Appointment Information
    document.getElementById('viewDetailsDate').textContent = app.dateData?.date || 'N/A';
    document.getElementById('viewDetailsTime').textContent = app.dateData?.time || 'N/A';
    document.getElementById('viewDetailsStatus').textContent = app.status || 'confirmed';
    
    // Populate Personal Details
    document.getElementById('viewDetailsPatientName').textContent = app.patientData?.name || 'N/A';
    document.getElementById('viewDetailsAge').textContent = app.patientData?.age || 'N/A';
    document.getElementById('viewDetailsGender').textContent = app.patientData?.gender || 'N/A';
    
    // Populate Contact Information
    document.getElementById('viewDetailsContact').textContent = app.patientData?.contact || 'N/A';
    document.getElementById('viewDetailsBlood').textContent = app.patientData?.blood || 'N/A';
    
    document.getElementById('viewDetailsModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }

  
  document.getElementById('closeViewDetailsModal').onclick = function() {
    document.getElementById('viewDetailsModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
  };

  document.getElementById('okViewDetailsModal').onclick = function() {
    document.getElementById('viewDetailsModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
  };

  document.getElementById('viewDetailsModalOverlay').onclick = function(e) {
    if (e.target === this) {
      document.getElementById('viewDetailsModalOverlay').classList.add('hidden');
      document.body.classList.remove('blurred-bg');
    }
  };

  
  let currentAppointmentForAssignment = null;

  async function loadDoctors() {
    try {
      const response = await fetch('/api/doctors');
      if (!response.ok) throw new Error('Failed to fetch doctors');
      const doctors = await response.json();
      
      const select = document.getElementById('doctorSelect');
      select.innerHTML = '<option value="">Choose a doctor...</option>' +
        doctors.map(doctor => `
          <option value="${doctor._id}">
            Dr. ${doctor.name} - ${doctor.specialty}
          </option>
        `).join('');
    } catch (error) {
      console.error('Error loading doctors:', error);
      alert('Failed to load doctors. Please try again.');
    }
  }

  function openAssignDoctorModal(appointment) {
    currentAppointmentForAssignment = appointment;
    document.getElementById('assignPatientName').textContent = appointment.patientData?.name || 'N/A';
    document.getElementById('assignDateTime').textContent = 
      `${appointment.dateData?.date || 'N/A'} at ${appointment.dateData?.time || 'N/A'}`;
    
    loadDoctors();
    document.getElementById('assignDoctorModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }

  function closeAssignDoctorModal() {
    document.getElementById('assignDoctorModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    currentAppointmentForAssignment = null;
  }

  
  document.getElementById('closeAssignDoctorModal').onclick = closeAssignDoctorModal;
  document.getElementById('cancelAssignDoctor').onclick = closeAssignDoctorModal;
  document.getElementById('assignDoctorModalOverlay').onclick = function(e) {
    if (e.target === this) closeAssignDoctorModal();
  };

  document.getElementById('assignDoctorForm').onsubmit = async function(e) {
    e.preventDefault();
    if (!currentAppointmentForAssignment) return;

    const doctorId = document.getElementById('doctorSelect').value;
    if (!doctorId) {
      alert('Please select a doctor');
      return;
    }

    try {
      const response = await fetch(`/api/appointments/${currentAppointmentForAssignment._id}/assign-doctor`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ doctorId })
      });

      if (!response.ok) throw new Error('Failed to assign doctor');

      
      const currentDate = datePicker.value;
      const searchTerm = searchInput.value.trim();
      await renderAppointmentsList(currentDate, searchTerm);

      closeAssignDoctorModal();
      alert('Doctor assigned successfully!');
    } catch (error) {
      console.error('Error assigning doctor:', error);
      alert('Failed to assign doctor. Please try again.');
    }
  };


  document.addEventListener('DOMContentLoaded', function() {
 
    const oldClickHandler = document.onclick;
    document.onclick = null;

    
    document.addEventListener('click', function(e) {
      
      if (e.target.classList.contains('action-btn')) {
        e.stopPropagation();
        const menus = document.querySelectorAll('.action-menu');
        menus.forEach(menu => menu.classList.add('hidden'));
        const menu = e.target.nextElementSibling;
        menu.classList.toggle('hidden');
      }
      
      
      if (e.target.classList.contains('view-details-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        openAppointmentDetailsModal(appointmentData);
        e.target.closest('.action-menu').classList.add('hidden');
      }
      
      // Handle Edit Appointment
      if (e.target.classList.contains('edit-appointment-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        
     
        console.log('Original appointment data:', appointmentData);
        console.log('Patient data from appointment:', appointmentData.patientData);
        console.log('Age value from appointment:', appointmentData.patientData?.age);

        // Create a properly structured appointment object with all required fields
        const editData = {
          _id: appointmentData._id,
          patientData: {
            name: appointmentData.patientData?.name || '',
            age: appointmentData.patientData?.age || '',
            gender: appointmentData.patientData?.gender || '',
            blood: appointmentData.patientData?.blood || '',
            contact: appointmentData.patientData?.contact || ''
          },
          doctorData: {
            _id: appointmentData.doctorData?._id || '',
            name: appointmentData.doctorData?.name || '',
            specialty: appointmentData.doctorData?.specialty || ''
          },
          dateData: {
            date: appointmentData.dateData?.date || '',
            time: appointmentData.dateData?.time || ''
          },
          status: appointmentData.status || 'pending'
        };

        // Log the formatted data for debugging
        console.log('Formatted edit data:', editData);
        
        // Save the formatted appointment data
        localStorage.setItem('editAppointment', JSON.stringify(editData));
        
        // Redirect to appointment page
        window.location.href = 'appointment.html?edit=1';
        e.target.closest('.action-menu').classList.add('hidden');
      }
      
      // Handle Reschedule
      if (e.target.classList.contains('reschedule-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        openRescheduleModal(appointmentData);
        e.target.closest('.action-menu').classList.add('hidden');
      }
      
      // Handle Cancel
      if (e.target.classList.contains('cancel-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const appointmentData = JSON.parse(e.target.getAttribute('data-appointment'));
        openCancelModal(appointmentData);
        e.target.closest('.action-menu').classList.add('hidden');
      }

      // Close all menus when clicking outside
      if (!e.target.closest('.action-menu') && !e.target.classList.contains('action-btn')) {
        document.querySelectorAll('.action-menu').forEach(menu => menu.classList.add('hidden'));
      }
    });
  });

  let rescheduleAppointmentData = null;
  let cancelAppointmentData = null;

  // Reschedule Modal Logic
  function openRescheduleModal(app) {
    rescheduleAppointmentData = app;
    document.getElementById('reschedulePatientName').textContent = `Reschedule appointment for ${app.patientData?.name || ''}`;
    // Pre-fill current date and time if available
    document.getElementById('rescheduleDate').value = app.dateData?.date ? new Date(app.dateData.date).toISOString().split('T')[0] : '';
    document.getElementById('rescheduleTime').value = app.dateData?.time || '';
    document.getElementById('rescheduleReason').value = '';
    document.getElementById('rescheduleModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }

  // Update reschedule form submission to actually reschedule
  document.getElementById('rescheduleForm').onsubmit = async function(e) {
    e.preventDefault();
    if (!rescheduleAppointmentData || !rescheduleAppointmentData._id) {
      alert('Error: Missing appointment ID.');
      return;
    }
    const newDate = document.getElementById('rescheduleDate').value;
    const newTime = document.getElementById('rescheduleTime').value;
    if (!newDate || !newTime) {
      alert('Please select both date and time.');
      return;
    }
    try {
      // Format date as MM/DD/YYYY to match backend expectations
      const formattedDate = new Date(newDate).toLocaleDateString('en-US', {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      });
      const response = await fetch(`/api/confirmations/${rescheduleAppointmentData._id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'reschedule',
          date: formattedDate,
          time: newTime
        })
      });
      if (!response.ok) throw new Error('Failed to reschedule appointment');
      closeRescheduleModal();
      showAlert('Appointment rescheduled successfully!');
      
      // Force refresh the appointments list after a short delay
      setTimeout(async () => {
        try {
          const currentDate = datePicker.value;
          const searchTerm = searchInput.value.trim();
          console.log('Refreshing appointments list after reschedule...');
          await renderAppointmentsList(currentDate, searchTerm);
          console.log('Appointments list refreshed successfully');
        } catch (refreshError) {
          console.error('Error refreshing appointments list:', refreshError);
          // If refresh fails, reload the page as fallback
          window.location.reload();
        }
      }, 500);
    } catch (err) {
      alert('Error rescheduling appointment: ' + err.message);
    }
  };

  function closeRescheduleModal() {
    document.getElementById('rescheduleModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    rescheduleAppointmentData = null;
  }
  document.getElementById('closeRescheduleModal').onclick = closeRescheduleModal;
  document.getElementById('cancelRescheduleBtn').onclick = closeRescheduleModal;
  document.getElementById('rescheduleModalOverlay').onclick = function(e) {
    if (e.target === this) closeRescheduleModal();
  };

  // Cancel Modal Logic
  function openCancelModal(app) {
    cancelAppointmentData = app;
    document.getElementById('cancelModalOverlay').classList.remove('hidden');
    document.body.classList.add('blurred-bg');
  }
  function closeCancelModal() {
    document.getElementById('cancelModalOverlay').classList.add('hidden');
    document.body.classList.remove('blurred-bg');
    cancelAppointmentData = null;
  }
  document.getElementById('closeCancelModal').onclick = closeCancelModal;
  document.getElementById('cancelCancelBtn').onclick = closeCancelModal;
  document.getElementById('cancelModalOverlay').onclick = function(e) {
    if (e.target === this) closeCancelModal();
  };
  document.getElementById('confirmCancelBtn').onclick = async function() {
    if (!cancelAppointmentData || !cancelAppointmentData._id) {
      alert('Error: Missing appointment ID.');
      return;
    }
    try {
      // Show loading state
      const confirmButton = document.getElementById('confirmCancelBtn');
      confirmButton.disabled = true;
      confirmButton.textContent = 'Canceling...';
      confirmButton.classList.add('opacity-75');

      // Make API call to cancel the appointment using PUT
      const response = await fetch(`/api/confirmations/${cancelAppointmentData._id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          action: 'cancel'
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to cancel appointment');
      }

      // Close the modal first
      closeCancelModal();

      // Show success message
      showAlert('Appointment cancelled successfully!');

      // Force refresh the appointments list after a short delay
      setTimeout(async () => {
        try {
          const currentDate = datePicker.value;
          const searchTerm = searchInput.value.trim();
          console.log('Refreshing appointments list after cancellation...');
          await renderAppointmentsList(currentDate, searchTerm);
          console.log('Appointments list refreshed successfully');
        } catch (refreshError) {
          console.error('Error refreshing appointments list:', refreshError);
          // If refresh fails, reload the page as fallback
          window.location.reload();
        }
      }, 500);

    } catch (error) {
      console.error('Error cancelling appointment:', error);
      alert('Error cancelling appointment: ' + error.message);
      
      // Reset button state
      const confirmButton = document.getElementById('confirmCancelBtn');
      confirmButton.disabled = false;
      confirmButton.textContent = 'Yes, Cancel';
      confirmButton.classList.remove('opacity-75');
    }
  };

  // Add Doctor Modal Logic
  const addDoctorBtn = document.getElementById('addDoctorBtn');
  const addDoctorModalOverlay = document.getElementById('addDoctorModalOverlay');
  
  if (addDoctorModalOverlay) {
      const closeAddDoctorModal = document.getElementById('closeAddDoctorModal');

      const openModal = () => {
        addDoctorModalOverlay.classList.remove('hidden');
        document.body.classList.add('blurred-bg');
      };

      const closeModal = () => {
        addDoctorModalOverlay.classList.add('hidden');
        document.body.classList.remove('blurred-bg');
        const form = document.getElementById('addDoctorForm');
        if(form) form.reset();
      };
      
      if(addDoctorBtn) {
          addDoctorBtn.addEventListener('click', openModal);
      }

      if(closeAddDoctorModal) {
          closeAddDoctorModal.addEventListener('click', closeModal);
      }

      addDoctorModalOverlay.addEventListener('click', (e) => {
        if (e.target === addDoctorModalOverlay) {
          closeModal();
        }
      });
      
      const addDoctorForm = document.getElementById('addDoctorForm');
      if(addDoctorForm) {
          addDoctorForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              alert('Backend functionality for adding a doctor needs to be implemented.');
              closeModal();
          });
      }
  }

  // Add these functions before the closing script tag
  function showAlert(message) {
    document.getElementById('alertMessage').textContent = message;
    document.getElementById('overlay').style.display = 'flex';
  }

  function hideAlert() {
    document.getElementById('overlay').style.display = 'none';
  }

  document.getElementById('signOutBtn').onclick = function() {
    if (confirm('Are you sure you want to sign out?')) {
      // Optionally clear session/local storage here
      window.location.href = 'login.html';
    }
  };

  // Doctor Profile Modal Logic
  let currentDoctorProfile = null;
  let isEditDoctorProfile = false;
  let doctorProfileImageFile = null;

  function openDoctorProfileModal(doctor, editMode = false) {
    currentDoctorProfile = doctor;
    isEditDoctorProfile = editMode;
    document.getElementById('doctorProfileModalTitle').textContent = editMode ? 'Edit Doctor Profile' : 'Doctor Profile';
    document.getElementById('doctorProfileName').value = doctor.name || '';
    document.getElementById('doctorProfileSpecialty').value = doctor.specialty || '';
    document.getElementById('doctorProfileAvailability').value = doctor.availability || '';
    document.getElementById('doctorProfileExperience').value = doctor.experience || '';
    document.getElementById('doctorProfileContact').value = doctor.contact || '';
    document.getElementById('doctorProfileEmail').value = doctor.email || '';
    doctorProfileImageFile = null;
    // Set image preview
    const imgPreview = document.getElementById('doctorProfileImagePreview');
    imgPreview.src = doctor.image || doctor.imageUrl || doctor.imageURL || doctor.img || '';
    imgPreview.style.display = imgPreview.src ? 'block' : 'none';
    // Show/hide image edit icon
    document.getElementById('doctorProfileImageEditIcon').style.display = editMode ? 'block' : 'none';
    // Set fields to readonly or editable
    [
      'doctorProfileName',
      'doctorProfileSpecialty',
      'doctorProfileAvailability',
      'doctorProfileExperience',
      'doctorProfileContact',
      'doctorProfileEmail'
    ].forEach(id => {
      document.getElementById(id).readOnly = !editMode;
    });
    document.getElementById('doctorProfileEditActions').style.display = editMode ? 'flex' : 'none';
    document.getElementById('doctorProfileModalOverlay').classList.remove('hidden');
    // Only blur the background, not the whole page
    document.body.classList.add('doctor-profile-blur-bg');
  }

  function closeDoctorProfileModal() {
    document.getElementById('doctorProfileModalOverlay').classList.add('hidden');
    document.body.classList.remove('doctor-profile-blur-bg');
    currentDoctorProfile = null;
    isEditDoctorProfile = false;
    doctorProfileImageFile = null;
  }
  document.getElementById('closeDoctorProfileModal').onclick = closeDoctorProfileModal;
  document.getElementById('cancelEditDoctorProfile').onclick = closeDoctorProfileModal;
  document.getElementById('doctorProfileModalOverlay').onclick = function(e) {
    if (e.target === this) closeDoctorProfileModal();
  };

  document.getElementById('doctorProfileImage').onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
      doctorProfileImageFile = file;
      const reader = new FileReader();
      reader.onload = function(ev) {
        document.getElementById('doctorProfileImagePreview').src = ev.target.result;
        document.getElementById('doctorProfileImagePreview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  };

  document.getElementById('doctorProfileForm').onsubmit = async function(e) {
    e.preventDefault();
    if (!currentDoctorProfile) return;
    // Gather updated data
    const updatedDoctor = {
      name: document.getElementById('doctorProfileName').value,
      specialty: document.getElementById('doctorProfileSpecialty').value,
      availability: document.getElementById('doctorProfileAvailability').value,
      experience: document.getElementById('doctorProfileExperience').value,
      contact: document.getElementById('doctorProfileContact').value,
      email: document.getElementById('doctorProfileEmail').value
    };
    try {
      let response;
      if (doctorProfileImageFile) {
        // Use FormData for image upload
        const formData = new FormData();
        Object.keys(updatedDoctor).forEach(key => formData.append(key, updatedDoctor[key]));
        formData.append('image', doctorProfileImageFile);
        response = await fetch(`/api/doctors/${currentDoctorProfile._id}`, {
          method: 'PUT',
          body: formData
        });
      } else {
        response = await fetch(`/api/doctors/${currentDoctorProfile._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedDoctor)
        });
      }
      if (!response.ok) throw new Error('Failed to update doctor profile');
      closeDoctorProfileModal();
      showAlert('Doctor profile updated successfully!');
      // Optionally refresh doctor list here
    } catch (err) {
      alert('Error saving doctor profile: ' + err.message);
    }
  };

  // Attach event listeners to View Profile and Edit Profile
  function attachDoctorProfileListeners() {
    document.querySelectorAll('.action-menu a').forEach(link => {
      if (link.textContent.trim() === 'View Profile') {
        link.onclick = function(e) {
          e.preventDefault();
          // Find doctor data from row
          const row = link.closest('.grid');
          const name = row.querySelector('.font-semibold')?.textContent.trim();
          const specialty = row.querySelectorAll('div')[1]?.textContent.trim();
          const availability = row.querySelectorAll('div')[3]?.textContent.trim();
          // Fetch more details from backend if needed
          fetch(`/api/doctors?name=${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(doctors => {
              const doctor = Array.isArray(doctors) ? doctors[0] : doctors;
              openDoctorProfileModal({
                _id: doctor._id,
                name: doctor.name,
                specialty: doctor.specialty,
                availability: doctor.availability || availability,
                experience: doctor.experience || '',
                contact: doctor.contact || '',
                email: doctor.email || '',
                image: doctor.image || ''
              }, false);
            })
            .catch(() => {
              // Fallback to row data if fetch fails
              openDoctorProfileModal({ name, specialty, availability }, false);
            });
        };
      }
      if (link.textContent.trim() === 'Edit Profile') {
        link.onclick = function(e) {
          e.preventDefault();
          // Find doctor data from row
          const row = link.closest('.grid');
          const name = row.querySelector('.font-semibold')?.textContent.trim();
          const specialty = row.querySelectorAll('div')[1]?.textContent.trim();
          const availability = row.querySelectorAll('div')[3]?.textContent.trim();
          // Fetch more details from backend if needed
          fetch(`/api/doctors?name=${encodeURIComponent(name)}`)
            .then(res => res.json())
            .then(doctors => {
              const doctor = Array.isArray(doctors) ? doctors[0] : doctors;
              openDoctorProfileModal({
                _id: doctor._id,
                name: doctor.name,
                specialty: doctor.specialty,
                availability: doctor.availability || availability,
                experience: doctor.experience || '',
                contact: doctor.contact || '',
                email: doctor.email || '',
                image: doctor.image || ''
              }, true);
            })
            .catch(() => {
              // Fallback to row data if fetch fails
              openDoctorProfileModal({ name, specialty, availability }, true);
            });
        };
      }
    });
  }
  attachDoctorProfileListeners();
</script>

</body>
</html>