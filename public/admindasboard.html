<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - MediCare</title>
    <link rel="icon" type="image/png" href="favicon.png" />
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <style>
        .flatpickr-calendar {
            border-radius: 16px !important;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08) !important;
            border: none !important;
            width: 320px !important;
            background: #fff !important;
            font-family: "Segoe UI", Arial, sans-serif;
        }

        .flatpickr-months {
            background: #fff !important;
            color: #222 !important;
            border-radius: 16px 16px 0 0 !important;
            padding: 12px 0 0 0 !important;
            margin-bottom: 0 !important;
        }

        .flatpickr-current-month {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 1.3em !important;
            font-weight: 700 !important;
            color: #222 !important;
            height: 40px !important;
            margin-bottom: 0 !important;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months,
        .flatpickr-current-month .numInputWrapper {
            color: #222 !important;
            font-weight: 700 !important;
        }

        .flatpickr-day {
            color: #222 !important;
            font-weight: 500 !important;
            background: transparent !important;
            border-radius: 50% !important;
            border: none !important;
            transition: background 0.2s, color 0.2s;
            margin: 2px 0 !important;
        }

        .flatpickr-day.selected,
        .flatpickr-day.today {
            background: #1677ff !important;
            color: #fff !important;
            border-radius: 50% !important;
        }

        .flatpickr-day:hover,
        .flatpickr-day:focus {
            background: #e6f0ff !important;
            color: #1677ff !important;
        }

        .flatpickr-weekdays {
            background: #fff !important;
            color: #bdbdbd !important;
            font-weight: 600 !important;
            border: none !important;
        }

        .flatpickr-weekday {
            color: #bdbdbd !important;
            font-weight: 600 !important;
            border: none !important;
        }

        .flatpickr-day.disabled,
        .flatpickr-day.nextMonthDay,
        .flatpickr-day.prevMonthDay {
            color: #e0e0e0 !important;
            background: transparent !important;
            cursor: not-allowed !important;
        }

        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            color: #bdbdbd !important;
            fill: #bdbdbd !important;
            top: 16px !important;
        }

        .tab-active {
            background-color: white;
            color: #1f2937;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            border-radius: 0.375rem;
        }

        .tab-inactive {
            background-color: transparent;
            color: #4b5563;
        }

        .tab-inactive:hover {
            color: #1f2937;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 0.375rem;
        }

        .doctor-row {
            cursor: pointer;
            background-color: white;
            color: #4b5563;
            border-bottom: 1px solid #e5e7eb;
        }

        .doctor-row.active {
            background-color: #f3f4f6;
            color: black;
        }

        .blurred-bg {
            position: relative;
        }

        .blurred-bg::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 40;
            backdrop-filter: blur(6px);
        }

        .blurred-bg>*:not(#viewDetailsModalOverlay):not(#appointmentDetailsModalOverlay):not(#availabilityModalOverlay):not(#rescheduleModalOverlay):not(#cancelModalOverlay):not(#addDoctorModalOverlay):not(#patientDetailsModalOverlay):not(#successModalOverlay):not(#viewDoctorProfileModalOverlay):not(#editDoctorProfileModalOverlay):not(#toast) {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }

        #viewDetailsModalOverlay,
        #appointmentDetailsModalOverlay,
        #availabilityModalOverlay,
        #rescheduleModalOverlay,
        #cancelModalOverlay,
        #addDoctorModalOverlay,
        #patientDetailsModalOverlay,
        #editDoctorProfileModalOverlay {
            z-index: 50;
        }

        body {
            overflow-y: hidden;
        }

        #patientDetailsModal .grid {
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        #patientDetailsModal .font-semibold {
            color: #6b7280;
        }

        #patientDetailsModal .text-gray-900 {
            font-weight: 500;
        }

        .blurred-bg .flatpickr-calendar {
            filter: none !important;
            backdrop-filter: none !important;
            pointer-events: auto !important;
            user-select: auto !important;
        }

        .flatpickr-day.today:not(.selected) {
            background: #f3f4f6 !important;
            color: #222 !important;
            border-radius: 50% !important;
            border: none !important;
        }

        .flatpickr-current-month .numInputWrapper,
        .flatpickr-current-month .flatpickr-year {
            display: none !important;
        }

        .flatpickr-current-month {
            justify-content: center !important;
        }

        #availabilityModal {
            border-radius: 1.25rem !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
            padding: 2rem !important;
            background: #fff !important;
            font-family: "Segoe UI", Arial, sans-serif;
        }

        #availabilityModal h2 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }

        #availabilityModal input[type="text"] {
            font-size: 1.125rem;
            border-radius: 0.75rem;
        }

        #availabilityModal button[type="submit"] {
            background: #2563eb;
            color: #fff;
            font-size: 1.125rem;
            border-radius: 0.75rem;
        }

        #availabilityModal button[type="button"] {
            font-size: 1.125rem;
            border-radius: 0.75rem;
        }

        .action-menu {
            position: fixed !important;
            z-index: 9999 !important;
            right: auto;
            margin-top: 0;
        }

        .bg-white.p-6.rounded-lg.shadow,
        .px-20 {
            overflow: visible !important;
        }

        .overflow-x-auto {
            overflow-y: visible !important;
        }

        #closeViewDetailsModal,
        #closeCancelModal {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <script>
        if (!localStorage.getItem("admin_jwt")) {
            window.location.href = "login.html";
        }
    </script>

    <nav class="bg-white shadow py-3 px-[110px]">
        <div class="flex justify-between items-center w-full">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <h1 class="text-xl font-bold text-blue-600">MediCare</h1>
            </div>
            <div class="flex items-center">
                <div class="flex items-center gap-2">
                    <div id="userAvatar"
                        class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-black font-bold text-lg">
                    </div>
                    <span id="userName" class="font-bold text-sm text-black"></span>
                    <div class="mr-2 font-bold text-sm text-black cursor-pointer flex items-center gap-1"
                        id="userDropdownToggle">
                        <svg width="24px" height="24px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <rect x="0" fill="none" width="24" height="24" />
                            <g>
                                <path d="M7 10l5 5 5-5" />
                            </g>
                        </svg>
                    </div>
                    <div id="userDropdownMenu"
                        class="absolute right-0 mt-32 w-44 bg-white border border-gray-200 rounded shadow-md hidden z-50">
                        <ul class="py-1 text-sm text-gray-700">
                            <li>
                                <a href=""
                                    class="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 transition-colors duration-150">
                                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M16.5 7.063C16.5 10.258 14.57 13 12 13c-2.572 0-4.5-2.742-4.5-5.938C7.5 3.868 9.16 2 12 2s4.5 1.867 4.5 5.063zM4.102 20.142C4.487 20.6 6.145 22 12 22c5.855 0 7.512-1.4 7.898-1.857a.416.416 0 0 0 .09-.317C19.9 18.944 19.106 15 12 15s-7.9 3.944-7.989 4.826a.416.416 0 0 0 .091.317z"
                                            fill="#000000" />
                                    </svg>
                                    <span>Profile</span>
                                </a>
                            </li>
                            <li>
                                <button onclick="showLogoutModal()"
                                    class="w-full flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-gray-100 transition-colors duration-150">

                                    <svg width="20px" height="20px" viewBox="0 0 15 15" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M1 1L8 1V2L2 2L2 13H8V14H1L1 1ZM10.8536 4.14645L14.1932 7.48614L10.8674 11.0891L10.1326 10.4109L12.358 8L4 8V7L12.2929 7L10.1464 4.85355L10.8536 4.14645Z"
                                            fill="#ff0000" />
                                    </svg>
                                    <span>Logout</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
    </nav>

    <div class="p-8">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
            <div>
                <h2 class="text-2xl font-semibold px-20">Admin Dashboard</h2>
                <div id="addAdmin" class="text-lg text-blue-500"></div>
                <p class="text-gray-500 px-20">Manage appointments, doctors, and patients</p>
            </div>
            <div class="flex items-center gap-4 px-20">
                <div class="relative w-60">
                    <img src="/search.webp" alt="Search"
                        class="absolute left-2 top-1/2 transform -translate-y-1/2 w-5 h-5 pointer-events-none" />
                    <input type="text" id="searchInput" placeholder="Search"
                        class="pl-8 py-[20px] h-12 rounded w-full bg-white border border-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 text-gray-900 font-semibold placeholder-gray-500 placeholder:text-lg" />
                </div>

                <div class="relative w-60 mt-5">
                    <div id="datePickerDisplay"
                        class="flex items-center justify-center w-full py-[20px] h-12 rounded bg-white border border-gray-800 cursor-pointer focus:ring-2 focus:ring-gray-400 select-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <rect x="3" y="4" width="18" height="18" rx="2" fill="#e5e7eb" />
                            <path stroke="#9ca3af" stroke-width="2" d="M8 2v4M16 2v4M3 10h18" />
                        </svg>
                        <span id="datePickerText" class="text-gray-900 font-semibold">2025-06-23</span>
                    </div>
                    <input type="text" id="datePicker" style="position: absolute; left: -9999px" readonly
                        autocomplete="off" />
                </div>
            </div>
        </div>

        <div class="px-20 mt-4">
            <div class="bg-gray-200 p-1 rounded-lg flex items-center mb-6">
                <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-active"
                    data-tab="appointmentsTab">Appointments</button>
                <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-inactive"
                    data-tab="doctorsTab">Doctors</button>
                <button class="tab flex-1 text-center py-1.5 font-semibold transition-colors duration-200 tab-inactive"
                    data-tab="patientsTab">Patients</button>
            </div>
        </div>
        <div class="px-20">
            <div class="bg-white p-6 rounded-xl shadow">
                <div id="appointmentsTab" class="tab-content">
                    <div class="flex items-center space-x-4 mb-4" id="appointmentsFilterBar">
                        <label for="appointmentStatusFilter" class="font-semibold text-gray-900 text-base"> Show:
                        </label>
                        <div class="relative">
                            <select id="appointmentStatusFilter"
                                class="block w-56 appearance-none rounded-lg border border-gray-300 bg-white px-4 py-2 pr-10 text-sm font-medium text-gray-800 shadow-sm transition-all duration-150 ease-in-out focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400 hover:border-gray-400">
                                <option value="all">All Appointments</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="rescheduled">Rescheduled</option>
                                <option value="cancelled">Cancelled</option>
                            </select>

                            <div class="pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-semibold" id="appointmentsTitle">Today's Appointments</h3>
                            <p class="text-gray-500" id="selectedDate">No date selected</p>
                        </div>
                        <a href="appointment.html"><button id="addBtn"
                                class="bg-black text-white px-4 py-1 rounded font-semibold">+ Add
                                Appointment</button></a>
                    </div>
                    <div id="appointmentsList"></div>
                </div>

                <div id="doctorsTab" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl font-semibold">Doctors</h3>
                            <p class="text-gray-500">Manage doctor profiles and schedules</p>
                        </div>
                        <!-- <button id="addDoctorBtn" class="bg-black text-white px-4 py-1 rounded font-semibold">+ Add
                            Doctor</button> -->
                    </div>

                    <div
                        class="hidden md:grid grid-cols-12 gap-4 px-4 py-3 text-left text-sm font-bold bg-gray-50 text-gray-800 border-b">
                        <div class="col-span-3">Doctor</div>
                        <div class="col-span-3">Specialization</div>

                        <div class="col-span-3">Today's Appointments</div>
                        <div class="col-span-3">Availability</div>
                        <!-- <div class="col-span-2">Actions</div> -->
                    </div>

                    <div id="doctorsList" class="space-y-2 mt-2"></div>

                    <div id="doctorsPagination" class="flex justify-center items-center space-x-2 mt-4 hidden">
                        <button id="prevDoctorsPage"
                            class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200">Previous</button>
                        <span id="doctorsPageInfo" class="text-sm text-gray-600"></span>
                        <button id="nextDoctorsPage"
                            class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200"">Next</button>
                    </div>
                </div>
         <div id="patientsTab" class="tab-content hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold">Patients List</h3>
                                    <p class="text-gray-500">View and manage patient records</p>
                                </div>
                            </div>

                            <div id="patientsHeader"
                                class="grid grid-cols-12 gap-4 px-4 py-3 text-left text-sm font-bold bg-gray-50 text-gray-800 border-b"
                                style="display: none">
                                <div class="col-span-3">Patient</div>
                                <div class="col-span-2">Age/Gender</div>
                                <div class="col-span-1">Blood</div>
                                <div class="col-span-2">Contact</div>
                                <div class="col-span-2">Appointment Date</div>
                                <div class="col-span-2">Last Visit</div>
                            </div>

                            <div id="patientsList" class="space-y-2 mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="appointmentDetailsModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="appointmentDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
                <button id="closeAppointmentDetailsModal"
                    class="absolute top-4 right-4 text-red-500 hover:text-red-700 text-2xl">&times;</button>

                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Viewing Details</h2>
                    <div class="mt-4 text-lg font-semibold text-blue-600" id="modalAppointmentPatientName"></div>
                    <div class="mt-2 text-md font-medium text-gray-600" id="modalDoctorName"></div>
                    <div class="mt-2 text-sm text-gray-500" id="modalDateTime"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500">Age:</span>
                            <span id="modalAge" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500">Gender:</span>
                            <span id="modalGender" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500">Blood Group:</span>
                            <span id="modalBlood" class="font-medium text-gray-900"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500">Contact:</span>
                            <span id="modalContact" class="font-medium text-gray-900"></span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button id="closeAppointmentDetailsBtn"
                        class="px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors duration-200">Close</button>
                </div>
            </div>
        </div>

        <div id="assignDoctorModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="assignDoctorModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
                <button id="closeAssignDoctorModal"
                    class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-2xl">&times;</button>
                <h2 class="text-2xl font-bold mb-4">Assign Doctor</h2>
                <div class="mb-4">
                    <p class="text-gray-600 mb-2">Patient: <span id="assignPatientName" class="font-semibold"></span>
                    </p>
                    <p class="text-gray-600 mb-4">Appointment: <span id="assignDateTime" class="font-semibold"></span>
                    </p>
                </div>
                <form id="assignDoctorForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Select Doctor</label>
                        <select id="doctorSelect" class="w-full border border-gray-300 rounded px-3 py-2" required>
                            <option value="">Choose a doctor...</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" id="cancelAssignDoctor"
                            class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Assign
                            Doctor</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="viewDetailsModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="viewDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-2xl relative">
                <button id="closeViewDetailsModal"
                    class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-2xl">&times;</button>

                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Appointment Details</h2>
                    <div class="mt-4 text-2xl font-semibold text-blue-600" id="viewDetailsPatient"></div>
                    <div class="mt-2 text-md font-medium text-gray-600" id="viewDetailsDoctor"></div>
                    <div class="mt-2 text-sm text-gray-500" id="viewDetailsDateTime"></div>
                </div>

                <div class="bg-gray-50 rounded-lg p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border rounded-lg p-4 bg-white">
                            <h3 class="text-gray-800 font-semibold text-lg mb-3">Doctor Information</h3>
                            <div class="space-y-2">
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Name:</span>
                                    <span id="viewDetailsDoctorName" class="font-medium text-gray-900"></span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Specialty:</span>
                                    <span id="viewDetailsDoctorSpecialty" class="font-medium text-gray-900"></span>
                                </div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-4 bg-white">
                            <h3 class="text-gray-800 font-semibold text-lg mb-3">Appointment Information</h3>
                            <div class="space-y-2">
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Date:</span>
                                    <span id="viewDetailsDate" class="font-medium text-gray-900"></span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Time:</span>
                                    <span id="viewDetailsTime" class="font-medium text-gray-900"></span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Status:</span>
                                    <span id="viewDetailsStatus" class="font-medium text-gray-900"></span>
                                </div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-4 bg-white">
                            <h3 class="text-gray-800 font-semibold text-lg mb-3">Personal Details</h3>
                            <div class="space-y-2">
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Name:</span>
                                    <span id="viewDetailsPatientName" class="font-medium text-gray-900"></span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Age:</span>
                                    <span id="viewDetailsAge" class="font-medium text-gray-900"></span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Gender:</span>
                                    <span id="viewDetailsGender" class="font-medium text-gray-900"></span>
                                </div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-4 bg-white">
                            <h3 class="text-gray-800 font-semibold text-lg mb-3">Contact Information</h3>
                            <div class="space-y-2">
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Phone:</span>
                                    <span id="viewDetailsContact" class="font-medium text-gray-900"></span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-gray-500">Blood Group:</span>
                                    <span id="viewDetailsBlood" class="font-medium text-gray-900"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button id="okViewDetailsModal"
                        class="px-6 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors duration-200">Close</button>
                </div>
            </div>
        </div>

        <div id="rescheduleModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="rescheduleModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
                <button id="closeRescheduleModal"
                    class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-2">Reschedule Appointment</h2>
                <div class="mb-4 text-gray-600" id="reschedulePatientName"></div>
                <form id="rescheduleForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-1">New Date</label>
                        <div id="rescheduleCalendarContainer"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-1">New Time</label>
                        <div id="rescheduleTimeSlotsContainer"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-1">Reason for Rescheduling</label>
                        <textarea id="rescheduleReason" class="w-full border border-gray-300 rounded px-3 py-2"
                            placeholder="Optional reason for rescheduling"></textarea>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" id="cancelRescheduleBtn"
                            class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">Cancel</button>
                        <button type="submit" id="confirmRescheduleBtn"
                            class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Confirm</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="cancelModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="cancelModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
                <button id="closeCancelModal"
                    class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-2xl">&times;</button>
                <h2 class="text-xl text-center font-bold mb-4 text-red-600">Cancel Appointment</h2>
                <div class="mb-6 text-gray-700">Are you sure you want to cancel this appointment?</div>
                <div class="flex justify-between gap-2">
                    <button id="cancelCancelBtn"
                        class="px-4 py-2 rounded border border-gray-300 bg-white text-black font-semibold">No</button>
                    <button id="confirmCancelBtn" class="px-4 py-2 rounded bg-red-600 text-white font-semibold">Yes,
                        Cancel</button>
                </div>
            </div>
        </div>

        <!-- <div id="addDoctorModalOverlay"
    class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div id="addDoctorModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative overflow-y-auto max-h-[90vh]">

        <button id="closeAddDoctorModal"
            class="absolute top-4 right-4 text-red-500 hover:text-red-700 text-2xl">&times;</button>
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Add Doctor</h2>
       <form id="addDoctorForm">
        <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="doctorFirstName" class="block text-gray-700 text-sm font-semibold mb-2">First Name</label>
                    <input type="text" id="doctorFirstName" name="firstName"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        required />
                </div>
                <div>
                    <label for="doctorLastName" class="block text-gray-700 text-sm font-semibold mb-2">Last Name</label>
                    <input type="text" id="doctorLastName" name="lastName"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        required />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="doctorSpecialty" class="block text-gray-700 text-sm font-semibold mb-2">Specialization</label>
                    <select id="doctorSpecialty" name="specialty"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        required>
                    </select>
                </div>
                <div>
                    <label for="doctorExperience" class="block text-gray-700 text-sm font-semibold mb-2">Experience</label>
                    <input type="text" id="doctorExperience" name="experience"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-semibold mb-2">Qualification</label>
                <input type="text" name="qualification"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    placeholder="e.g., Mbbs,Phd..." required />
            </div>
            <div class="mb-4">
                <label for="doctorAvailability" class="block text-gray-700 text-sm font-semibold mb-2">Availability</label>
                <input type="text" id="doctorAvailability" name="availability"
                    class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    placeholder="e.g., 9:00 AM - 5:00 PM" required />
            </div>
            <div id="doctorErrorMsg" style="display: none; color: red; margin-top: 8px"></div>
            <div class="flex justify-end mt-4">
                <button type="submit"
                    class="px-8 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors duration-200">
                    Add
                </button>
            </div>
        </form>
    </div>
</div> -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
                <p id="alertMessage" class="text-center text-lg"></p>
                <div class="mt-4 flex justify-center">
                    <button onclick="hideAlert()"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">OK</button>
                </div>
            </div>
        </div>

        <div id="patientDetailsModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="patientDetailsModal" class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative">
                <button id="closePatientDetailsModal"
                    class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-2xl">&times;</button>
                <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">Patient Details</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="font-semibold text-gray-600">Name</div>
                    <div id="modalPatientName" class="text-gray-900"></div>
                    <div class="font-semibold text-gray-600">Age/Gender</div>
                    <div id="modalPatientAgeGender" class="text-gray-900"></div>
                    <div class="font-semibold text-gray-600">Blood</div>
                    <div id="modalPatientBlood" class="text-gray-900"></div>
                    <div class="font-semibold text-gray-600">Contact</div>
                    <div id="modalPatientContact" class="text-gray-900"></div>

                    <div class="font-semibold text-gray-600">Appointment Date</div>
                    <div id="modalPatientUpcoming" class="text-gray-900"></div>

                    <div class="font-semibold text-gray-600">Last Visit</div>
                    <div id="modalPatientLastVisit" class="text-gray-900"></div>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="closePatientDetailsBtn"
                        class="px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors duration-200">Close</button>
                </div>
            </div>
        </div>

        <div id="viewDoctorProfileModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="viewDoctorProfileModal" class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg relative">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Doctor Profile</h2>
                <div class="sm:col-span-2 flex flex-col items-center mb-2">
                    <label class="text-sm font-semibold text-gray-600 block mb-2">Profile Photo</label>
                    <div style="position: relative; width: 96px; height: 96px; margin-bottom: 0.5rem">
                        <img src="" id="profileDoctorImage" alt=""
                            class="w-24 h-24 rounded-full object-cover border shadow"
                            style="position: absolute; top: 0; left: 0;" />
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Name</p>
                        <p id="profileDoctorName" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Specialization</p>
                        <p id="profileDoctorSpecialty" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Experience</p>
                        <p id="profileDoctorExperience" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Availability</p>
                        <p id="profileDoctorAvailability" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                    <div id="profileDoctorAgeWrapper" class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Age</p>
                        <p id="profileDoctorAge" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                    <div id="profileDoctorGenderWrapper" class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Gender</p>
                        <p id="profileDoctorGender" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                    <div id="profileDoctorPhoneWrapper" class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Phone Number</p>
                        <p id="profileDoctorPhone" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Qualification</p>
                        <p id="profileDoctorQualification" class="text-gray-800 font-semibold text-base break-words">
                        </p>
                    </div>
                    <div id="profileDoctorAddressWrapper" class="sm:col-span-2 bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Address</p>
                        <p id="profileDoctorAddress" class="text-gray-800 font-semibold text-base truncate"></p>
                    </div>
                </div>

                <div class="flex justify-center mt-6">
                    <button id="closeViewDoctorProfileBtn"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">Close</button>
                </div>
            </div>
        </div>

        <div id="editDoctorProfileModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg max-h-screen overflow-y-auto relative">
                <button id="closeEditDoctorProfileModal"
                    class="absolute top-4 right-4 text-red-500 hover:text-red-700 text-2xl">&times;</button>
                <h2 class="text-xl font-bold text-center mb-4 text-gray-800">Edit Doctor Profile</h2>

                <form id="editDoctorForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="sm:col-span-2 flex flex-col items-center mb-2">
                        <label class="text-sm font-semibold text-gray-600 block mb-2">Profile Photo</label>
                        <div style="position: relative; width: 96px; height: 96px; margin-bottom: 0.5rem">
                            <img id="editDoctorPhotoPreview" src="" alt=""
                                class="w-24 h-24 rounded-full object-cover border shadow"
                                style="display:none;position: absolute; top: 0; left: 0;z-index:2;" />
                            <div id="editDoctorDefaultIcon" style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 96px;
                                    height: 96px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    border-radius: 50%;
                                    background: #f3f4f6;
                                    z-index:1;
                                ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2" fill="none" />
                                    <path stroke="currentColor" stroke-width="2" d="M4 20c0-4 4-7 8-7s8 3 8 7"
                                        fill="none" />
                                </svg>
                            </div>
                        </div>
                        <!-- <input type="file" id="editDoctorPhoto" accept="image/*" class="hidden" />
                        <button type="button" onclick="document.getElementById('editDoctorPhoto').click()"
                            class="px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 text-xs font-medium">
                            Choose Photo
                        </button> -->
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Name</label>
                        <input type="text" id="editDoctorName" name="name"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500" required />
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Specialization</label>
                        <select id="editDoctorSpecialization" name="specialty"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500" required>
                        </select>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Experience</label>
                        <input type="text" id="editDoctorExperience" name="experience"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500" />
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Availability</label>
                        <input type="text" id="editDoctorAvailability" name="availability"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500" />
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Age</label>
                        <input type="number" id="editDoctorAge" name="age"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500" min="1"
                            max="120" />
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Gender</label>
                        <select id="editDoctorGender" name="gender"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Phone Number</label>
                        <input type="tel" id="editDoctorPhone" name="phone"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"
                            pattern="^[6-9][0-9]{9}$" maxlength="10"
                            title="Phone number must be 10 digits and start with 6, 7, 8, or 9.">
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Qualification</label>
                        <input type="text" id="editDoctorQualification" name="qualification"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500" />
                    </div>

                    <div class="sm:col-span-2 bg-gray-50 p-3 rounded-lg shadow-sm">
                        <label class="text-sm font-medium text-gray-600 mb-1 block">Address</label>
                        <textarea id="editDoctorAddress" name="address"
                            class="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"
                            rows="2"></textarea>
                    </div>

                    <div class="sm:col-span-2 flex justify-between pt-3 gap-3">
                        <button type="button" id="cancelEditDoctorBtn"
                            class="w-1/2 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 font-semibold hover:bg-gray-100">Cancel</button>
                        <button type="submit"
                            class="w-1/2 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="successModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg shadow-lg p-8 w-[400px] min-h-[220px] flex flex-col items-center">
                <div class="mb-4">
                    <div class="flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mx-auto">
                        <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" stroke-width="3"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                </div>
                <div id="successModalMessage" class="text-center text-lg font-semibold mb-6 text-gray-800"></div>
                <button id="successModalOkBtn"
                    class="w-full py-2 rounded bg-blue-600 text-white text-lg font-bold hover:bg-blue-700 transition-colors duration-200">OK</button>
            </div>
        </div>

        <div id="availabilityModalOverlay"
            class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div id="availabilityModal" class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg relative">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Manage Availability</h2>
                <p id="manageDoctorName" class="text-lg font-semibold text-gray-800 mb-4 text-center"></p>

                <form id="availabilityForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm col-span-2">
                        <p class="text-gray-500 text-sm mb-1">Select Date</p>
                        <input type="text" id="availabilityDate" name="date"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="MM/DD/YYYY" required readonly />
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">Start Time</p>
                        <input type="text" id="availabilityStart" name="start"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md text-center text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="10:00 AM" required />
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <p class="text-gray-500 text-sm mb-1">End Time</p>
                        <input type="text" id="availabilityEnd" name="end"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md text-center text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="05:00 PM" required />
                    </div>

                    <div class="col-span-2 flex justify-center gap-4 mt-4">
                        <button type="button" id="cancelAvailability"
                            class="px-6 py-2 bg-white border border-gray-300 text-black rounded-lg font-semibold hover:bg-gray-100 transition">Cancel</button>
                        <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">Save</button>
                    </div>
                </form>

                <button id="closeAvailabilityModal"
                    class="absolute top-4 right-4 text-red-500 hover:text-red-700 text-2xl">&times;</button>
            </div>
        </div>
        <footer class="w-full bg-white shadow py-4 mt-8 fixed bottom-0 left-0 z-30 flex items-center justify-center">
            <div class="text-gray-500 font-semibold">medicare@2000</div>
            <!-- <div class="flex items-center gap-3">
            <button id="lightThemeBtn" title="Light Theme"
                style="background:none;border:none;outline:none;cursor:pointer;padding:0;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5" />
                    <line x1="12" y1="1" x2="12" y2="3" />
                    <line x1="12" y1="21" x2="12" y2="23" />
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                    <line x1="1" y1="12" x2="3" y2="12" />
                    <line x1="21" y1="12" x2="23" y2="12" />
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                </svg>
            </button>
            <button id="darkThemeBtn" title="Dark Theme"
                style="background:none;border:none;outline:none;cursor:pointer;padding:0;">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z" />
                </svg>
            </button>
        </div> -->
        </footer>
        <script>
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.body.classList.add('bg-gray-900', 'text-white');
                    document.body.classList.remove('bg-gray-100', 'text-gray-900');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.classList.remove('bg-gray-900', 'text-white');
                    document.body.classList.add('bg-gray-100', 'text-gray-900');
                }
            }
            function getSavedTheme() {
                return localStorage.getItem('theme') || 'light';
            }
            function setTheme(theme) {
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            }
            document.getElementById('lightThemeBtn').onclick = function () { setTheme('light'); };
            document.getElementById('darkThemeBtn').onclick = function () { setTheme('dark'); };

            applyTheme(getSavedTheme());
        </script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script>
            const datePicker = document.getElementById("datePicker");
            const selectedDate = document.getElementById("selectedDate");
            const appointmentsList = document.getElementById("appointmentsList");
            const addBtn = document.getElementById("addBtn");
            const searchInput = document.getElementById("searchInput");

            flatpickr("#datePicker", {
                dateFormat: "Y-m-d",
                allowInput: false,
                defaultDate: new Date(),

                static: true,
                onReady: function (selectedDates, dateStr, instance) {
                    const monthElem = instance.calendarContainer.querySelector(".flatpickr-current-month");
                    if (monthElem) {
                        const yearInput = monthElem.querySelector(".numInputWrapper");
                        if (yearInput) yearInput.style.display = "none";

                        const yearDropdown = monthElem.querySelector(".flatpickr-yearDropdown-years");
                        if (yearDropdown) yearDropdown.style.display = "none";

                        const yearSpan = monthElem.querySelector(".flatpickr-year");
                        if (yearSpan) yearSpan.style.display = "none";

                        monthElem.style.justifyContent = "center";

                        const monthName = monthElem.querySelector(".cur-month");
                        if (monthName) {
                            monthName.style.fontWeight = "bold";
                            monthName.style.fontSize = "1.3em";
                        }
                    }
                },
                onChange: function (selectedDates, dateStr, instance) {
                    const displayText = selectedDates[0]?.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" }) || "";
                    document.getElementById("datePickerText").textContent = displayText;
                    document.getElementById("datePicker").value = dateStr;

                    if (document.getElementById("selectedDate")) {
                        document.getElementById("selectedDate").textContent = displayText;
                    }

                    const activeTab = document.querySelector(".tab.tab-active").getAttribute("data-tab");
                    if (activeTab === "doctorsTab") {
                        fetchAndDisplayDoctors(dateStr);
                    }

                    if (activeTab === "appointmentsTab") {
                        renderAppointmentsList(dateStr, searchInput.value.trim());
                    }

                    if (activeTab === "patientsTab") {
                        fetchAndDisplayPatients(dateStr, searchInput.value.trim());
                    }
                },
            });
            document.getElementById("datePickerDisplay").addEventListener("click", function () {
                console.log("[Flatpickr] datePickerDisplay clicked");
                if (document.getElementById("datePicker")._flatpickr) {
                    document.getElementById("datePicker")._flatpickr.open();
                    console.log("[Flatpickr] Calendar opened");
                } else {
                    console.error("[Flatpickr] Flatpickr instance not found!");
                }
            });

            document.getElementById("datePicker").style.color = "transparent";

            const today = new Date();
            document.getElementById("datePicker").value = today.toISOString().split("T")[0];
            document.getElementById("selectedDate").textContent = today.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
            document.getElementById("datePickerText").textContent = today.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });

            async function fetchAppointments(date, searchDoctorName = "", status = "all", specialty = "") {
                try {
                    const formattedDate = new Date(date).toLocaleDateString("en-US", {
                        month: "numeric",
                        day: "numeric",
                        year: "numeric",
                    });

                    let url = "/api/confirmations";
                    if (status && status !== "all") {
                        url += `?status=${encodeURIComponent(status)}`;
                    }
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch appointments: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.length > 0) {
                        console.log("First appointment details:", JSON.stringify(data[0], null, 2));
                    }

                    const filteredAppointments = data.filter((app) => {
                        if (!app.dateData?.date) {
                            console.log("Appointment missing date data:", app);
                            return false;
                        }

                        const appointmentDate = app.dateData.date.trim();
                        const matchesDate = appointmentDate === formattedDate;

                        const appointmentDoctorName = app.doctorData?.name || app.doctorName || "";
                        const matchesDoctor = !searchDoctorName || (appointmentDoctorName && appointmentDoctorName.toLowerCase().includes(searchDoctorName.toLowerCase()));

                        if (searchDoctorName && appointmentDoctorName) {
                            console.log(`Checking doctor: "${appointmentDoctorName}" against search: "${searchDoctorName}" - matches: ${matchesDoctor}`);
                        }

                        return matchesDate && matchesDoctor;
                    });

                    console.log("Filtered appointments count:", filteredAppointments.length);
                    console.log("Filtered appointments:", filteredAppointments);
                    return filteredAppointments;
                } catch (error) {
                    console.error("Error in fetchAppointments:", error);
                    throw error;
                }
            }
            let currentAppointmentsPage = 1;
            const appointmentsPerPage = 5;
            let allAppointmentsData = [];
            let currentPatientsPage = 1;
            const patientsPerPage = 5;
            let allPatientsData = [];

            async function renderAppointmentsList(date, filterDoctor = "", statusFilter = "all", specialty = "") {
                console.log("renderAppointmentsList called with statusFilter:", statusFilter);
                try {
                    appointmentsList.innerHTML = `
        <div class=\"flex justify-center items-center p-4\">
          <div class=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500\"></div>
          <span class=\"ml-2 text-gray-600\">Loading appointments...</span>
        </div>
      `;

                    const appointments = await fetchAppointments(date, filterDoctor, statusFilter, specialty);
                    let filteredAppointments = appointments;

                    const uniqueStatuses = [...new Set(appointments.map((app) => app.status))];
                    console.log("All unique status values in appointments:", uniqueStatuses);
                    console.log("Status filter selected:", statusFilter);

                    if (statusFilter !== "all") {
                        filteredAppointments = appointments.filter((app) => {
                            const appointmentStatus = app.status || "confirmed";

                            let matches = false;
                            if (statusFilter.toLowerCase() === "cancelled") {
                                matches = appointmentStatus.toLowerCase() === "cancelled" || appointmentStatus.toLowerCase() === "canceled";
                            } else {
                                matches = appointmentStatus.toLowerCase() === statusFilter.toLowerCase();
                            }

                            console.log(`Appointment status: "${appointmentStatus}" vs filter: "${statusFilter}" - matches: ${matches}`);
                            return matches;
                        });
                        console.log(`Filtered appointments for status "${statusFilter}":`, filteredAppointments.length);
                    }
                    allAppointmentsData = filteredAppointments;
                    const totalPages = Math.ceil(filteredAppointments.length / appointmentsPerPage);
                    if (currentAppointmentsPage > totalPages && totalPages > 0) {
                        currentAppointmentsPage = totalPages;
                    } else if (totalPages === 0) {
                        currentAppointmentsPage = 1;
                    }

                    if (!filteredAppointments || filteredAppointments.length === 0) {
                        const formattedDate = new Date(date).toLocaleDateString("en-US", {
                            weekday: "long",
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        });
                        appointmentsList.innerHTML = `
          <div class=\"p-4 text-center text-gray-500\">
            <div class=\"mb-4\">
              <svg class=\"w-12 h-12 mx-auto text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">
                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />
              </svg>
            </div>
            <p class=\"text-lg font-medium mb-2\">No appointments found</p>
            <p class=\"text-sm\">${formattedDate}</p>
            ${filterDoctor ? `<p class=\"text-sm mt-1\">for Dr. ${filterDoctor}</p>` : ""}
          </div>
        `;
                        return;
                    }

                    filteredAppointments = filteredAppointments.slice().sort((a, b) => {
                        const parseTime = (t) => {
                            if (!t) return 0;

                            const [time, modifier] = t.split(" ");
                            let [hours, minutes] = time.split(":").map(Number);
                            if (modifier && modifier.toUpperCase() === "PM" && hours !== 12) hours += 12;
                            if (modifier && modifier.toUpperCase() === "AM" && hours === 12) hours = 0;
                            return hours * 60 + minutes;
                        };
                        return parseTime(a.dateData?.time) - parseTime(b.dateData?.time);
                    });

                    const startIndex = (currentAppointmentsPage - 1) * appointmentsPerPage;
                    const endIndex = startIndex + appointmentsPerPage;
                    const currentPageAppointments = filteredAppointments.slice(startIndex, endIndex);

                    let tableHTML = `
        <div class=\"overflow-x-auto\">
          <table class=\"min-w-full bg-white rounded-lg shadow-sm\">
            <thead>
              <tr class=\"bg-gray-50 text-gray-700 text-left\">
                <th class=\"px-4 py-3\">Patient</th>
                <th class=\"px-4 py-3\">Doctor</th>
                <th class=\"px-4 py-3\">Time</th>
                <th class=\"px-4 py-3\">Status</th>
                <th class=\"px-4 py-3\">Actions</th>
              </tr>
            </thead>
            <tbody>
    `;

                    tableHTML += currentPageAppointments
                        .map((app, idx) => {
                            const doctorName = app.doctorData?.name || "";
                            const isCanceled = app.status === "canceled" || app.status === "cancelled";
                            const isRescheduled = app.status === "rescheduled";

                            let statusLabel = `<span class=\"inline-block px-3 py-1 rounded-full text-xs font-semibold bg-green-200 text-green-700\">Confirmed</span>`;
                            if (isRescheduled) {
                                statusLabel = `<span class=\"inline-block px-3 py-1 rounded-full text-xs font-semibold bg-yellow-200 text-yellow-800\">Rescheduled</span>`;
                            } else if (isCanceled) {
                                statusLabel = `<span class=\"inline-block px-3 py-1 rounded-full text-xs font-semibold bg-red-200 text-red-700\">Cancelled</span>`;
                            }
                            return `
          <tr class=\"border-b hover:bg-gray-50 transition-colors\">
            <td class=\"px-4 py-3\">
              <div class=\"font-semibold text-gray-900\">${app.patientData?.name || "N/A"}</div>
              <div class=\"text-xs text-gray-500\">${app.patientData?.contact || ""}</div>
            </td>
            <td class=\"px-4 py-3\">
              <div class=\"font-semibold text-blue-700\">${doctorName}</div>
              <div class=\"text-xs text-gray-500\">${app.doctorData?.specialty || ""}</div>
            </td>
            <td class=\"px-4 py-3\">
              <div class=\"flex items-center gap-1\">
                <svg class=\"w-4 h-4 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" /></svg>
                <span>${app.dateData?.time || "N/A"}</span>
              </div>
            </td>
            <td class=\"px-4 py-3\">
              ${statusLabel}
            </td>
            <td class=\"px-4 py-3 relative\">
              <button class=\"action-btn text-xl focus:outline-none\">...</button>
              <div class=\"action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20\">
                <a href=\"#\" class=\"view-details-btn block px-4 py-2 hover:bg-gray-100 text-gray-700\" data-appointment='${JSON.stringify(app)}'>View details</a>
                ${!isCanceled ? `<a href=\"#\" class=\"edit-appointment-btn block px-4 py-2 hover:bg-gray-100 text-gray-700\" data-appointment='${JSON.stringify(app)}'>Edit Appointment</a>` : ""}
                ${!isCanceled ? `<a href=\"#\" class=\"reschedule-btn block px-4 py-2 hover:bg-gray-100 text-gray-700\" data-appointment='${JSON.stringify(app)}'>Reschedule</a>` : ""}
                ${!isCanceled ? `<a href=\"#\" class=\"cancel-btn block px-4 py-2 hover:bg-gray-100 text-red-600\" data-appointment='${JSON.stringify(app)}'>Cancel Appointment</a>` : ""}
              </div>
            </td>
          </tr>
        `;
                        })
                        .join("");

                    tableHTML += `</tbody></table></div>`;

                    if (totalPages > 1) {
                        tableHTML += `
          <div class=\"flex justify-between items-center mt-6 px-4\">
            <div class=\"text-sm text-gray-600\">
              Showing ${startIndex + 1} to ${Math.min(endIndex, filteredAppointments.length)} of ${filteredAppointments.length} appointments
            </div>
            <div class=\"flex items-center space-x-2\">
              <button onclick=\"changeAppointmentsPage(${currentAppointmentsPage - 1})\" 
                class=\"px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200\"
                ${currentAppointmentsPage === 1 ? "disabled" : ""}>
                Previous
              </button>
              <span class=\"text-sm text-gray-600\">
                Page ${currentAppointmentsPage} of ${totalPages}
              </span>
              <button onclick=\"changeAppointmentsPage(${currentAppointmentsPage + 1})\" 
                class=\"px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200\"
                ${currentAppointmentsPage === totalPages ? "disabled" : ""}>
                Next
              </button>
            </div>
          </div>
        `;
                    }

                    appointmentsList.innerHTML = tableHTML;
                } catch (error) {
                    console.error("Error in renderAppointmentsList:", error);
                    appointmentsList.innerHTML = `
        <div class=\"p-4 text-center text-red-500\">
          <p class=\"font-semibold\">Error loading appointments</p>
          <p class=\"text-sm mt-2\">${error.message || "Please try again later"}</p>
          <button onclick=\"renderAppointmentsList('${date}', '${filterDoctor}', '${statusFilter}')\" class=\"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600\">
            Retry
          </button>
        </div>
      `;
                }
            }

            function changeAppointmentsPage(newPage) {
                const totalPages = Math.ceil(allAppointmentsData.length / appointmentsPerPage);
                if (newPage < 1 || newPage > totalPages) return;
                currentAppointmentsPage = newPage;

                const date = document.getElementById("datePicker").value;
                const searchTerm = document.getElementById("searchInput").value.trim();
                const status = document.getElementById("appointmentStatusFilter") ? document.getElementById("appointmentStatusFilter").value : "all";
                renderAppointmentsList(date, searchTerm, status);
            }

            let searchTimeout;
            searchInput.addEventListener("input", () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const currentDate = datePicker.value;
                    const searchTerm = searchInput.value.trim();
                    const status = document.getElementById("appointmentStatusFilter") ? document.getElementById("appointmentStatusFilter").value : "all";
                    console.log("Search term changed:", searchTerm);
                    currentAppointmentsPage = 1;
                    currentPatientsPage = 1;

                    const activeTab = document.querySelector(".tab.tab-active").getAttribute("data-tab");

                    if (activeTab === "appointmentsTab") {
                        renderAppointmentsList(currentDate, searchTerm, status);
                    } else if (activeTab === "patientsTab") {
                        fetchAndDisplayPatients(currentDate, searchTerm);
                    }
                }, 300);
            });

            searchInput.addEventListener("keyup", (e) => {
                if (e.key === "Escape") {
                    searchInput.value = "";
                    const currentDate = datePicker.value;
                    const status = document.getElementById("appointmentStatusFilter") ? document.getElementById("appointmentStatusFilter").value : "all";
                    const activeTab = document.querySelector(".tab.tab-active").getAttribute("data-tab");

                    if (activeTab === "appointmentsTab") {
                        renderAppointmentsList(currentDate, "", status);
                    } else if (activeTab === "patientsTab") {
                        fetchAndDisplayPatients(currentDate, "");
                    }
                }
            });

            renderAppointmentsList(today, "", document.getElementById("appointmentStatusFilter") ? document.getElementById("appointmentStatusFilter").value : "all");

            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("reschedule-btn")) {
                    e.preventDefault();
                    const appointment = JSON.parse(e.target.dataset.appointment);
                    window.selectedAppointment = appointment;
                    document.getElementById("rescheduleModalOverlay").classList.remove("hidden");
                }
            });

            const tabs = document.querySelectorAll(".tab");
            const tabContents = document.querySelectorAll(".tab-content");

            tabs.forEach((tab) => {
                tab.addEventListener("click", () => {
                    tabs.forEach((t) => t.classList.remove("tab-active", "tab-inactive"));
                    tabs.forEach((t) => t.classList.add("tab-inactive"));
                    tab.classList.remove("tab-inactive");
                    tab.classList.add("tab-active");

                    const targetId = tab.getAttribute("data-tab");
                    tabContents.forEach((c) => c.classList.add("hidden"));
                    document.getElementById(targetId).classList.remove("hidden");

                    if (targetId === "appointmentsTab") {
                        currentAppointmentsPage = 1;
                    } else if (targetId === "patientsTab") {
                        currentPatientsPage = 1;
                    }

                    const date = datePicker.value;
                    const searchTerm = searchInput.value.trim();
                    const status = document.getElementById("appointmentStatusFilter") ? document.getElementById("appointmentStatusFilter").value : "all";

                    if (targetId === "appointmentsTab") {
                        renderAppointmentsList(date, searchTerm, status);
                    } else if (targetId === "patientsTab") {
                        fetchAndDisplayPatients(date, searchTerm);
                    } else if (targetId === "doctorsTab") {
                        fetchAndDisplayDoctors(date);
                    }
                });
            });

            async function fetchAndDisplayPatients(date = null, searchTerm = "") {
                try {
                    const response = await fetch("/api/confirmations");
                    if (!response.ok) throw new Error("Failed to fetch patient data");

                    const allAppointments = await response.json();
                    const patientsListContainer = document.getElementById("patientsList");
                    const patientsHeader = document.getElementById("patientsHeader");
                    patientsListContainer.innerHTML = '<div class="text-center p-4">Loading patients...</div>';

                    const formattedSelectedDate = date
                        ? new Date(date).toLocaleDateString("en-US", {
                            month: "numeric",
                            day: "numeric",
                            year: "numeric",
                        })
                        : null;

                    const patientsMap = new Map();
                    allAppointments.forEach((app) => {
                        if (!app.patientData || !app.patientData.name) {
                            return;
                        }
                        const patientKey = `${app.patientData.name}-${app.patientData.contact}`;
                        if (!patientsMap.has(patientKey)) {
                            patientsMap.set(patientKey, {
                                details: app.patientData,
                                appointments: [],
                            });
                        }
                        if (app.dateData && app.dateData.date) {
                            patientsMap.get(patientKey).appointments.push({
                                date: app.dateData.date,
                                status: app.status || "confirmed",
                            });
                        }
                    });

                    const finalPatientList = [];
                    for (const [patientKey, patientData] of patientsMap.entries()) {
                        const patientName = patientData.details.name || "";
                        const matchesSearch = !searchTerm || patientName.toLowerCase().includes(searchTerm.toLowerCase());

                        const hasAppointmentOnDate = formattedSelectedDate ? patientData.appointments.some((a) => a.date === formattedSelectedDate) : true;

                        if (matchesSearch && hasAppointmentOnDate) {
                            finalPatientList.push(patientData);
                        }
                    }

                    allPatientsData = finalPatientList;

                    currentPatientsPage = 1;

                    if (finalPatientList.length === 0) {
                        if (patientsHeader) {
                            patientsHeader.style.display = "none";
                        }

                        let message = "No patients found";
                        if (searchTerm) message += ` for "${searchTerm}"`;
                        if (formattedSelectedDate) message += ` with appointments on ${new Date(date).toLocaleDateString("en-US", { month: "long", day: "numeric" })}`;
                        patientsListContainer.innerHTML = `
          <div class="p-4 text-center text-gray-500">
            <div class="mb-4">
              <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
            <p class="text-lg font-medium mb-2">No patients found</p>
            <p class="text-sm">${message}</p>
          </div>
        `;
                        return;
                    }
                    if (patientsHeader) {
                        patientsHeader.style.display = "grid";
                    }

                    renderPatientsListWithPagination();
                } catch (error) {
                    console.error("Error fetching patient data:", error);

                    const patientsHeader = document.getElementById("patientsHeader");
                    if (patientsHeader) {
                        patientsHeader.style.display = "none";
                    }
                    document.getElementById("patientsList").innerHTML = `
        <div class="p-4 text-center text-red-500">
          <p class="font-semibold">Error loading patient data</p>
          <p class="text-sm mt-2">${error.message || "Please try again later"}</p>
          <button onclick="fetchAndDisplayPatients('${date}', '${searchTerm}')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
            Retry
          </button>
        </div>
      `;
                }
            }

            function renderPatientsListWithPagination() {
                const patientsListContainer = document.getElementById("patientsList");
                const patientsHeader = document.getElementById("patientsHeader");

                if (patientsHeader) {
                    patientsHeader.style.display = "none";
                }
                if (!allPatientsData || allPatientsData.length === 0) {
                    patientsListContainer.innerHTML = '<div class="p-4 text-center text-gray-500">No patients found</div>';
                    return;
                }

                if (patientsHeader) {
                    patientsHeader.style.display = "grid";
                }

                const totalPages = Math.ceil(allPatientsData.length / patientsPerPage);
                const startIndex = (currentPatientsPage - 1) * patientsPerPage;
                const endIndex = startIndex + patientsPerPage;
                const currentPagePatients = allPatientsData.slice(startIndex, endIndex);

                let patientsHTML = "";
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                currentPagePatients.forEach((patient) => {
                    const sortedAppointments = patient.appointments.map((a) => new Date(a.date)).sort((a, b) => a - b);

                    const futureAppointments = sortedAppointments.filter((d) => d >= today);
                    const pastAppointments = sortedAppointments.filter((d) => d < today);

                    const upcomingDate =
                        futureAppointments.length > 0
                            ? futureAppointments[0].toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
                            : '<span class="text-gray-400">N/A</span>';

                    const lastVisit =
                        pastAppointments.length > 0
                            ? pastAppointments[pastAppointments.length - 1].toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })
                            : '<span class="text-gray-400">N/A</span>';

                    const allCancelled =
                        patient.appointments.length > 0 && patient.appointments.every((a) => (a.status || "").toLowerCase() === "canceled" || (a.status || "").toLowerCase() === "cancelled");

                    patientsHTML += `
        <div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
          <div class="col-span-3 flex items-center">
            <div class="w-8 h-8 bg-gray-200 rounded-full mr-4 flex-shrink-0 cursor-pointer patient-placeholder" 
              data-patient='${JSON.stringify({
                        name: patient.details.name || "N/A",
                        age: patient.details.age || "N/A",
                        gender: patient.details.gender || "N/A",
                        blood: patient.details.blood || "N/A",
                        contact: patient.details.contact || "N/A",
                        upcomingDate: upcomingDate.replace(/<[^>]+>/g, ""),
                        lastVisit: lastVisit.replace(/<[^>]+>/g, ""),
                    })}'
            ></div>
            <div>
              <div class="font-semibold ${allCancelled ? "text-red-600" : "text-gray-800"}">${patient.details.name || "N/A"}</div>
              <div class="text-xs text-gray-500">PAT-${patient.details.contact ? String(patient.details.contact).slice(-4) : "0000"}</div>
            </div>
          </div>
          <!-- Age/Gender -->
          <div class="col-span-2 text-gray-600">${patient.details.age || "N/A"} / ${patient.details.gender ? patient.details.gender.charAt(0) : "N/A"}</div>
          <!-- Blood Group -->
          <div class="col-span-1 text-gray-600">${patient.details.blood || "N/A"}</div>
          <!-- Contact -->
          <div class="col-span-2 text-gray-600">${patient.details.contact || "N/A"}</div>
          <!-- Upcoming Date -->
          <div class="col-span-2 text-gray-600">${upcomingDate}</div>
          <div class="col-span-2 text-gray-600">${lastVisit}</div>
        </div>
      `;
                });

                if (totalPages > 1) {
                    patientsHTML += `
        <div class="flex justify-between items-center mt-6 px-4">
          <div class="text-sm text-gray-600">
            Showing ${startIndex + 1} to ${Math.min(endIndex, allPatientsData.length)} of ${allPatientsData.length} patients
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="changePatientsPage(${currentPatientsPage - 1})" 
              class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200"
              ${currentPatientsPage === 1 ? "disabled" : ""}>
              Previous
            </button>
            <span class="text-sm text-gray-600">
              Page ${currentPatientsPage} of ${totalPages}
            </span>
            <button onclick="changePatientsPage(${currentPatientsPage + 1})" 
              class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-blue-500 hover:text-white hover:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100 disabled:hover:text-gray-600 disabled:hover:border-gray-300 transition-colors duration-200"
              ${currentPatientsPage === totalPages ? "disabled" : ""}>
              Next
            </button>
          </div>
        </div>
      `;
                }

                patientsListContainer.innerHTML = patientsHTML;
            }

            function changePatientsPage(newPage) {
                if (newPage < 1 || newPage > Math.ceil(allPatientsData.length / patientsPerPage)) {
                    return;
                }

                currentPatientsPage = newPage;
                renderPatientsListWithPagination();
            }
            window.changePatientsPage = changePatientsPage;

            let currentDoctor = null;
            let currentDoctorId = null;

            async function openAvailabilityModal(doctor) {
                if (!doctor || !doctor._id) return;
                currentDoctor = doctor;
                currentDoctorId = doctor._id;
                document.getElementById("availabilityModalOverlay").classList.remove("hidden");
                document.body.classList.add("blurred-bg");
                document.getElementById("availabilityForm").reset();
                const today = new Date();
                availabilityDatePicker.setDate(today, true);
                fetchAndFillAvailabilityForDate(today.toISOString().split("T")[0]);
            }

            function closeAvailabilityModal() {
                document.getElementById("availabilityModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
                currentDoctor = null;
                currentDoctorId = null;
                document.getElementById("availabilityForm").reset();
            }

            document.getElementById("cancelAvailability").onclick = closeAvailabilityModal;
            document.getElementById("closeAvailabilityModal").onclick = closeAvailabilityModal;

            const availabilityDateInput = document.getElementById("availabilityDate");
            const availabilityDatePicker = flatpickr(availabilityDateInput, {
                dateFormat: "Y-m-d",
                allowInput: false,
                static: true,
                defaultDate: new Date(),
                onChange: function (selectedDates, dateStr) {
                    fetchAndFillAvailabilityForDate(dateStr);
                },
            });

            flatpickr("#availabilityStart", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",
                time_24hr: false,
                allowInput: false,
                static: true,
            });
            flatpickr("#availabilityEnd", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",
                time_24hr: false,
                allowInput: false,
                static: true,
            });

            async function fetchAndFillAvailabilityForDate(dateStr) {
                if (!currentDoctorId) return;
                try {
                    const res = await fetch(`/api/doctors/${currentDoctorId}/availability?date=${dateStr}`);
                    if (res.ok) {
                        const data = await res.json();
                        document.getElementById("availabilityStart").value = data.start || "";
                        document.getElementById("availabilityEnd").value = data.end || "";
                    } else {
                        document.getElementById("availabilityStart").value = "";
                        document.getElementById("availabilityEnd").value = "";
                    }
                } catch (err) {
                    document.getElementById("availabilityStart").value = "";
                    document.getElementById("availabilityEnd").value = "";
                }
            }

            document.getElementById("availabilityForm").onsubmit = async function (e) {
                e.preventDefault();
                const date = document.getElementById("availabilityDate").value;
                const start = document.getElementById("availabilityStart").value;
                const end = document.getElementById("availabilityEnd").value;
                if (!currentDoctorId) return;
                try {
                    const response = await fetch(`/api/doctors/${currentDoctorId}/availability`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ date, start, end }),
                    });
                    console.log("currentDoctorId", currentDoctorId, date, start, end);
                    if (!response.ok) {
                        showToast("Failed to save availability", "error");
                        return;
                    }
                    showToast("Availability saved successfully!", "success");

                    closeAvailabilityModal();

                    const datePicker = document.getElementById("datePicker");
                    if (datePicker) {
                        await fetchAndDisplayDoctors(datePicker.value);
                    } else {
                        await fetchAndDisplayDoctors();
                    }
                } catch (err) {
                    showToast("Error saving availability: " + err.message, 'error');
                }
            };

            function openAppointmentDetailsModal(app) {
                const doctorName = app.doctorData?.name || app.doctor?.name || app.doctorName || app.assignedDoctor?.name || app.assigned_doctor?.name || "Not Assigned";

                document.getElementById("viewDetailsPatient").textContent = app.patientData?.name || "N/A";
                document.getElementById("viewDetailsDoctor").textContent = doctorName;
                document.getElementById("viewDetailsDateTime").textContent = `${app.dateData?.date || "N/A"} at ${app.dateData?.time || "N/A"}`;

                document.getElementById("viewDetailsDoctorName").textContent = doctorName;
                document.getElementById("viewDetailsDoctorSpecialty").textContent = app.doctorData?.specialty || "N/A";

                document.getElementById("viewDetailsDate").textContent = app.dateData?.date || "N/A";
                document.getElementById("viewDetailsTime").textContent = app.dateData?.time || "N/A";
                document.getElementById("viewDetailsStatus").textContent = app.status || "confirmed";

                document.getElementById("viewDetailsPatientName").textContent = app.patientData?.name || "N/A";
                document.getElementById("viewDetailsAge").textContent = app.patientData?.age || "N/A";
                document.getElementById("viewDetailsGender").textContent = app.patientData?.gender || "N/A";

                document.getElementById("viewDetailsContact").textContent = app.patientData?.contact || "N/A";
                document.getElementById("viewDetailsBlood").textContent = app.patientData?.blood || "N/A";

                document.getElementById("viewDetailsModalOverlay").classList.remove("hidden");
                document.body.classList.add("blurred-bg");
            }

            document.getElementById("closeViewDetailsModal").onclick = function () {
                document.getElementById("viewDetailsModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
            };

            document.getElementById("okViewDetailsModal").onclick = function () {
                document.getElementById("viewDetailsModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
            };

            let currentAppointmentForAssignment = null;

            async function loadDoctors() {
                try {
                    const response = await fetch("/api/doctors");
                    if (!response.ok) throw new Error("Failed to fetch doctors");
                    const doctors = await response.json();

                    const select = document.getElementById("doctorSelect");
                    select.innerHTML =
                        '<option value="">Choose a doctor...</option>' +
                        doctors
                            .map(
                                (doctor) => `
          <option value="${doctor._id}">
            Dr. ${doctor.name} - ${doctor.specialty}
          </option>
        `
                            )
                            .join("");
                } catch (error) {
                    console.error("Error loading doctors:", error);
                    showToast("Failed to load doctors. Please try again.", 'error');
                }
            }

            function openAssignDoctorModal(appointment) {
                currentAppointmentForAssignment = appointment;
                document.getElementById("assignPatientName").textContent = appointment.patientData?.name || "N/A";
                document.getElementById("assignDateTime").textContent = `${appointment.dateData?.date || "N/A"} at ${appointment.dateData?.time || "N/A"}`;

                loadDoctors();
                document.getElementById("assignDoctorModalOverlay").classList.remove("hidden");
                document.body.classList.add("blurred-bg");
            }

            function closeAssignDoctorModal() {
                document.getElementById("assignDoctorModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
                currentAppointmentForAssignment = null;
            }

            document.getElementById("closeAssignDoctorModal").onclick = closeAssignDoctorModal;
            document.getElementById("cancelAssignDoctor").onclick = closeAssignDoctorModal;

            document.getElementById("assignDoctorForm").onsubmit = async function (e) {
                e.preventDefault();
                if (!currentAppointmentForAssignment) return;

                const doctorId = document.getElementById("doctorSelect").value;
                if (!doctorId) {
                    showToast("Please select a doctor", 'warning');
                    return;
                }

                try {
                    const response = await fetch(`/api/appointments/${currentAppointmentForAssignment._id}/assign-doctor`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ doctorId }),
                    });

                    if (!response.ok) throw new Error("Failed to assign doctor");

                    const currentDate = datePicker.value;
                    const searchTerm = searchInput.value.trim();
                    await renderAppointmentsList(currentDate, searchTerm);

                    closeAssignDoctorModal();
                    showToast("Doctor assigned successfully!", 'success');
                } catch (error) {
                    console.error("Error assigning doctor:", error);
                    showToast("Failed to assign doctor. Please try again.", 'error');
                }
            };

            document.addEventListener("DOMContentLoaded", function () {
                const oldClickHandler = document.onclick;
                document.onclick = null;

                const activeTab = document.querySelector(".tab.tab-active").getAttribute("data-tab");
                const currentDate = datePicker.value;
                const searchTerm = searchInput.value.trim();

                if (activeTab === "doctorsTab") {
                    fetchAndDisplayDoctors(currentDate);
                }

                document.addEventListener("click", function (e) {
                    if (e.target.classList.contains("action-btn")) {
                        e.stopPropagation();
                        const menus = document.querySelectorAll(".action-menu");
                        menus.forEach((menu) => menu.classList.add("hidden"));
                        const menu = e.target.nextElementSibling;
                        menu.classList.toggle("hidden");
                    }

                    if (e.target.classList.contains("view-details-btn")) {
                        e.preventDefault();
                        e.stopPropagation();
                        const appointmentData = JSON.parse(e.target.getAttribute("data-appointment"));
                        openAppointmentDetailsModal(appointmentData);
                        e.target.closest(".action-menu").classList.add("hidden");
                    }

                    if (e.target.classList.contains("edit-appointment-btn")) {
                        e.preventDefault();
                        e.stopPropagation();
                        const appointmentData = JSON.parse(e.target.getAttribute("data-appointment"));

                        if (!appointmentData._id) {
                            showToast("Error: Appointment ID missing. Cannot edit this appointment.", 'error');
                            return;
                        }

                        if (appointmentData.doctorData) delete appointmentData.doctorData._id;
                        if (appointmentData.patientData) delete appointmentData.patientData._id;
                        if (appointmentData.dateData) delete appointmentData.dateData._id;

                        localStorage.setItem("editAppointment", JSON.stringify(appointmentData));
                        window.location.href = `appointment.html?edit=1&id=${appointmentData._id}`;
                        e.target.closest(".action-menu").classList.add("hidden");
                    }

                    if (e.target.classList.contains("reschedule-btn")) {
                        e.preventDefault();
                        e.stopPropagation();
                        const appointmentData = JSON.parse(e.target.getAttribute("data-appointment"));
                        openRescheduleModal(appointmentData);
                        e.target.closest(".action-menu").classList.add("hidden");
                    }

                    if (e.target.classList.contains("cancel-btn")) {
                        e.preventDefault();
                        e.stopPropagation();
                        const appointmentData = JSON.parse(e.target.getAttribute("data-appointment"));
                        openCancelModal(appointmentData);
                        e.target.closest(".action-menu").classList.add("hidden");
                    }

                    if (!e.target.closest(".action-menu") && !e.target.classList.contains("action-btn")) {
                        document.querySelectorAll(".action-menu").forEach((menu) => menu.classList.add("hidden"));
                    }
                });
            });

            let rescheduleAppointmentData = null;
            let cancelAppointmentData = null;

            let rescheduleSelectedDate = null;
            let rescheduleSelectedTime = null;

            function openRescheduleModal(app) {
                rescheduleAppointmentData = app;
                document.getElementById("reschedulePatientName").textContent = `Reschedule appointment for ${app.patientData?.name || ""}`;
                document.getElementById("rescheduleReason").value = "";
                document.getElementById("rescheduleModalOverlay").classList.remove("hidden");
                document.body.classList.add("blurred-bg");

                renderRescheduleCalendar(app);
            }

            function closeRescheduleModal() {
                document.getElementById("rescheduleModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
                rescheduleAppointmentData = null;
                rescheduleSelectedDate = null;
                rescheduleSelectedTime = null;
            }
            document.getElementById("closeRescheduleModal").onclick = closeRescheduleModal;
            document.getElementById("cancelRescheduleBtn").onclick = closeRescheduleModal;

            async function renderRescheduleCalendar(app) {
                const container = document.getElementById("rescheduleCalendarContainer");
                container.innerHTML = "";
                const today = new Date();
                let currentMonth = today.getMonth();
                let currentYear = today.getFullYear();
                let selectedDate = null;
                let doctorName = app.doctorData?.name || app.doctorName || "";

                function renderCalendar(month, year) {
                    container.innerHTML = "";
                    const monthName = new Date(year, month).toLocaleString("default", { month: "long" });
                    const header = document.createElement("div");
                    header.className = "flex justify-between items-center mb-2";
                    header.innerHTML = `
        <button type="button" class="px-2 py-1 text-gray-600 hover:bg-gray-100 rounded" id="reschedulePrevMonth">&lt;</button>
        <span class="font-semibold">${monthName} ${year}</span>
        <button type="button" class="px-2 py-1 text-gray-600 hover:bg-gray-100 rounded" id="rescheduleNextMonth">&gt;</button>
      `;
                    container.appendChild(header);
                    const daysRow = document.createElement("div");
                    daysRow.className = "grid grid-cols-7 text-center text-xs text-gray-600 mb-1";
                    daysRow.innerHTML = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map((d) => `<div>${d}</div>`).join("");
                    container.appendChild(daysRow);
                    const daysGrid = document.createElement("div");
                    daysGrid.className = "grid grid-cols-7 gap-1";

                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let i = 0; i < firstDay; i++) {
                        daysGrid.appendChild(document.createElement("div"));
                    }
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateObj = new Date(year, month, day);
                        const dateStr = `${month + 1}/${day}/${year}`;
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "calendar-day h-8 w-8 flex items-center justify-center rounded-full font-medium";
                        btn.textContent = day;
                        if (dateObj < today) {
                            btn.classList.add("text-gray-300", "cursor-not-allowed");
                            btn.disabled = true;
                        } else {
                            btn.classList.add("bg-green-100", "text-gray-800", "hover:bg-green-200", "cursor-pointer");
                            btn.onclick = () => {
                                rescheduleSelectedDate = dateStr;
                                selectedDate = dateStr;
                                renderRescheduleTimeSlots(doctorName, dateStr);
                                Array.from(daysGrid.children).forEach((c) => c.classList.remove("selected", "bg-green-500", "text-white"));
                                btn.classList.add("selected", "bg-green-500", "text-white");
                            };
                        }
                        daysGrid.appendChild(btn);
                    }
                    container.appendChild(daysGrid);
                    document.getElementById("reschedulePrevMonth").onclick = () => {
                        if (month > today.getMonth() || year > today.getFullYear()) {
                            if (month === 0) {
                                currentMonth = 11;
                                currentYear--;
                            } else {
                                currentMonth--;
                            }
                            renderCalendar(currentMonth, currentYear);
                        }
                    };
                    document.getElementById("rescheduleNextMonth").onclick = () => {
                        if (month < today.getMonth() + 2 || year > today.getFullYear()) {
                            if (month === 11) {
                                currentMonth = 0;
                                currentYear++;
                            } else {
                                currentMonth++;
                            }
                            renderCalendar(currentMonth, currentYear);
                        }
                    };
                }
                renderCalendar(currentMonth, currentYear);
            }

            async function renderRescheduleTimeSlots(doctorName, dateStr) {
                const container = document.getElementById("rescheduleTimeSlotsContainer");
                container.innerHTML = '<div class="text-gray-500">Loading time slots...</div>';

                let slots = [];
                try {
                    const response = await fetch(`/api/confirmations/booked-slots?doctorName=${encodeURIComponent(doctorName)}&date=${encodeURIComponent(dateStr)}`);
                    const data = await response.json();
                    const bookedTimes = data.bookedTimes || [];

                    slots = ["9:00 AM", "9:30 AM", "10:00 AM", "10:30 AM", "11:00 AM", "11:30 AM", "12:00 PM", "12:30 PM", "2:00 PM", "2:30 PM", "3:00 PM", "3:30 PM", "4:00 PM"];
                    container.innerHTML = "";
                    slots.forEach((time) => {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "time-slot p-2 m-1 border rounded";
                        btn.textContent = time;
                        if (bookedTimes.includes(time)) {
                            btn.classList.add("bg-red-100", "text-red-600", "cursor-not-allowed");
                            btn.disabled = true;
                        } else {
                            btn.classList.add("bg-green-100", "hover:bg-green-200", "cursor-pointer");
                            btn.onclick = () => {
                                rescheduleSelectedTime = time;
                                Array.from(container.children).forEach((c) => c.classList.remove("selected", "bg-green-500", "text-white"));
                                btn.classList.add("selected", "bg-green-500", "text-white");
                            };
                        }
                        container.appendChild(btn);
                    });
                } catch (e) {
                    container.innerHTML = '<div class="text-red-500">Failed to load time slots.</div>';
                }
            }

            document.getElementById("rescheduleForm").onsubmit = async function (e) {
                e.preventDefault();
                if (!rescheduleAppointmentData || !rescheduleAppointmentData._id) {
                    showToast("Error: Missing appointment ID.", 'error');
                    return;
                }
                if (!rescheduleSelectedDate || !rescheduleSelectedTime) {
                    showToast("Please select both date and time.", 'warning');
                    return;
                }
                try {
                    const formattedDate = rescheduleSelectedDate;
                    const response = await fetch(`/api/confirmations/${rescheduleAppointmentData._id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            action: "reschedule",
                            date: formattedDate,
                            time: rescheduleSelectedTime,
                            reason: document.getElementById("rescheduleReason").value,
                        }),
                    });
                    if (!response.ok) throw new Error("Failed to reschedule appointment");
                    closeRescheduleModal();
                    showSuccessModal("Appointment rescheduled successfully!", "Appointment rescheduled successfully!", "success");
                    try {
                        const currentDate = datePicker.value;
                        const searchTerm = searchInput.value.trim();
                        const status = document.getElementById("appointmentStatusFilter") ? document.getElementById("appointmentStatusFilter").value : "all";
                        await renderAppointmentsList(currentDate, searchTerm, status);
                    } catch (refreshError) {
                        window.location.reload();
                    }
                } catch (err) {
                    showToast("Error rescheduling appointment: " + err.message, 'error');
                }
            };

            function openCancelModal(app) {
                cancelAppointmentData = app;
                document.getElementById("cancelModalOverlay").classList.remove("hidden");
                document.body.classList.add("blurred-bg");

                const confirmButton = document.getElementById("confirmCancelBtn");
                confirmButton.disabled = false;
                confirmButton.textContent = "Yes, Cancel";
                confirmButton.classList.remove("opacity-75");
            }

            function closeCancelModal() {
                document.getElementById("cancelModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
                cancelAppointmentData = null;

                const confirmButton = document.getElementById("confirmCancelBtn");
                confirmButton.disabled = false;
                confirmButton.textContent = "Yes, Cancel";
                confirmButton.classList.remove("opacity-75");
            }

            document.getElementById("closeCancelModal").onclick = closeCancelModal;
            document.getElementById("cancelCancelBtn").onclick = closeCancelModal;

            document.getElementById("confirmCancelBtn").onclick = async function () {
                if (!cancelAppointmentData || !cancelAppointmentData._id) {
                    showToast("Error: Missing appointment ID.", 'error');
                    return;
                }
                const confirmButton = document.getElementById("confirmCancelBtn");
                confirmButton.disabled = true;
                confirmButton.textContent = "Canceling...";
                confirmButton.classList.add("opacity-75");
                try {
                    const response = await fetch(`/api/confirmations/${cancelAppointmentData._id}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            action: "cancel",
                        }),
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Failed to cancel appointment");
                    }
                    closeCancelModal();
                    showSuccessModal("Appointment cancelled successfully!", "Appointment cancelled successfully!", "success");
                    try {
                        const currentDate = datePicker.value;
                        const searchTerm = searchInput.value.trim();
                        await renderAppointmentsList(currentDate, searchTerm);
                    } catch (refreshError) {
                        window.location.reload();
                    }
                } catch (error) {
                    showToast("Error cancelling appointment: " + error.message, 'error');
                    confirmButton.disabled = false;
                    confirmButton.textContent = "Yes, Cancel";
                    confirmButton.classList.remove("opacity-75");
                }
            };

            // const addDoctorBtn = document.getElementById("addDoctorBtn");
            // const addDoctorModalOverlay = document.getElementById("addDoctorModalOverlay");

            // if (addDoctorModalOverlay) {
            //     const closeAddDoctorModal = document.getElementById("closeAddDoctorModal");

            //     const openModal = () => {
            //         addDoctorModalOverlay.classList.remove("hidden");
            //         document.body.classList.add("blurred-bg");
            //     };

            //     const closeModal = () => {
            //         addDoctorModalOverlay.classList.add("hidden");
            //         document.body.classList.remove("blurred-bg");
            //         const form = document.getElementById("addDoctorForm");
            //         if (form) form.reset();
            //     };

            //     if (addDoctorBtn) {
            //         addDoctorBtn.addEventListener("click", openModal);
            //     }

            //     if (closeAddDoctorModal) {
            //         closeAddDoctorModal.addEventListener("click", closeModal);
            //     }

            //     const addDoctorForm = document.getElementById("addDoctorForm");
            //     if (addDoctorForm) {
            //         addDoctorForm.addEventListener("submit", async (e) => {
            //             e.preventDefault();
            //             const formData = new FormData(addDoctorForm);
            //             const firstName = formData.get("firstName")?.trim() || "";
            //             const lastName = formData.get("lastName")?.trim() || "";
            //             const fullName = `Dr. ${firstName} ${lastName}`.replace(/\s+/g, " ").trim().toLowerCase();

            //             try {
            //                 const res = await fetch("/api/doctors");
            //                 const existingDoctors = await res.json();

            //                 const isDuplicate = existingDoctors.some((doc) => {
            //                     const existingName = (doc.name || "").replace(/\s+/g, " ").trim().toLowerCase();
            //                     return existingName === fullName;
            //                 });

            //                 if (isDuplicate) {
            //                     showDoctorError("Doctor already exists: duplicate name.");
            //                     return;
            //                 }
            //             } catch (err) {
            //                 showToast("Error checking existing doctors.", 'error');
            //                 return;
            //             }

            //             const doctorData = {
            //                 firstName,
            //                 lastName,
            //                 name: `Dr. ${firstName} ${lastName}`,
            //                 specialty: formData.get("specialty"),
            //                 experience: formData.get("experience"),
            //                 qualification: formData.get("qualification"),
            //                 availability: formData.get("availability"),
            //             };

            //             try {
            //                 const response = await fetch("/api/doctors", {
            //                     method: "POST",
            //                     headers: { "Content-Type": "application/json" },
            //                     body: JSON.stringify(doctorData),
            //                 });

            //                 if (!response.ok) {
            //                     const errorData = await response.json();
            //                     showToast(errorData.error || "Failed to add doctor.", 'error');
            //                     return;
            //                 }

            //                 showSuccessModal("Doctor added successfully!", "Doctor added successfully!", "success");
            //                 closeModal();
            //                 await fetchAndDisplayDoctors();
            //             } catch (error) {
            //                 showToast("Error adding doctor: " + (error.message || "Unknown error"), 'error');
            //             }
            //         });
            //     }
            // }
            async function fetchAndDisplayDoctors() {
                const res = await fetch("/api/doctors");
                const doctors = await res.json();

            }

            function showDoctorError(msg) {
                const errorDiv = document.getElementById("doctorErrorMsg");
                if (!errorDiv) return;
                if (msg) {
                    errorDiv.textContent = msg;
                    errorDiv.style.display = "block";
                } else {
                    errorDiv.textContent = "";
                    errorDiv.style.display = "none";
                }
            }

            let pendingToast = null;
            function showSuccessModal(message, toastMessage = null, toastType = 'success') {
                document.getElementById("successModalMessage").textContent = message;
                document.getElementById("successModalOverlay").classList.remove("hidden");
                document.body.classList.add("blurred-bg");
                pendingToast = toastMessage ? { message: toastMessage, type: toastType } : null;
            }
            function hideSuccessModal() {
                document.getElementById("successModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
                if (pendingToast) {
                    showToast(pendingToast.message, pendingToast.type);
                    pendingToast = null;
                }
            }
            document.getElementById("successModalOkBtn").onclick = hideSuccessModal;
            document.getElementById("successModalOverlay").onclick = function (e) {
                if (e.target === this) hideSuccessModal();
            };

            // document.getElementById("signOutBtn").onclick = function () {
            //     if (confirm("Are you sure you want to sign out?")) {
            //         localStorage.clear();
            //         window.location.href = "login.html";
            //     }
            // };

            function openPatientDetailsModal(patient) {
                let name = patient.name || (patient.details && patient.details.name) || "N/A";
                let age = patient.age || (patient.details && patient.details.age) || "N/A";
                let gender = patient.gender || (patient.details && patient.details.gender) || "N/A";
                let blood = patient.blood || (patient.details && patient.details.blood) || "N/A";
                let contact = patient.contact || (patient.details && patient.details.contact) || "N/A";
                document.getElementById("modalPatientName").textContent = name;
                document.getElementById("modalPatientAgeGender").textContent = `${age} / ${gender}`;
                document.getElementById("modalPatientBlood").textContent = blood;
                document.getElementById("modalPatientContact").textContent = contact;
                document.getElementById("modalPatientUpcoming").textContent = patient.upcomingDate || "N/A";
                document.getElementById("modalPatientLastVisit").textContent = patient.lastVisit || "N/A";
                document.getElementById("patientDetailsModalOverlay").classList.remove("hidden");
                document.body.classList.add("blurred-bg");
            }

            function closePatientDetailsModal() {
                document.getElementById("patientDetailsModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
            }

            document.getElementById("closePatientDetailsModal").onclick = closePatientDetailsModal;
            document.getElementById("closePatientDetailsBtn").onclick = closePatientDetailsModal;

            document.getElementById("patientsList").addEventListener("click", function (e) {
                if (e.target.classList.contains("patient-placeholder")) {
                    const patientData = JSON.parse(e.target.getAttribute("data-patient"));
                    console.log("Patient data for modal:", patientData);
                    openPatientDetailsModal(patientData);
                }
            });

            let allDoctors = [];
            let currentDoctorsPage = 1;
            const doctorsPerPage = 5;
            let todaysAppointmentsCountMap = {};

            async function fetchAndDisplayDoctors(currentDate) {
                try {
                    const response = await fetch("/api/doctors");
                    if (!response.ok) {
                        throw new Error("Failed to fetch doctors");
                    }
                    allDoctors = await response.json();

                    allDoctors.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                    currentDoctorsPage = 1;

                    const appointmentsRes = await fetch("/api/confirmations");
                    const allAppointments = appointmentsRes.ok ? await appointmentsRes.json() : [];

                    const formattedDate = new Date(currentDate).toLocaleDateString("en-US", {
                        month: "numeric",
                        day: "numeric",
                        year: "numeric",
                    });

                    todaysAppointmentsCountMap = {};
                    allAppointments.forEach((app) => {
                        if (app.dateData && app.dateData.date === formattedDate && app.status !== "canceled" && app.status !== "cancelled") {
                            const doctorName = app.doctorData?.name || app.doctorName || "";
                            if (doctorName) {
                                todaysAppointmentsCountMap[doctorName] = (todaysAppointmentsCountMap[doctorName] || 0) + 1;
                            }
                        }
                    });
                    renderDoctorsPage();
                } catch (error) {
                    console.error("Error fetching doctors:", error);
                }
            }
            function addDoctorToList(newDoctor) {
                allDoctors.unshift(newDoctor);
                currentDoctorsPage = 1;

                renderDoctorsPage();
            }
            async function renderDoctorsPage() {
                const doctorsList = document.getElementById("doctorsList");
                const paginationContainer = document.getElementById("doctorsPagination");
                if (!doctorsList) return;
                const totalPages = Math.ceil(allDoctors.length / doctorsPerPage);
                const startIndex = (currentDoctorsPage - 1) * doctorsPerPage;
                const endIndex = startIndex + doctorsPerPage;
                const currentDoctors = allDoctors.slice(startIndex, endIndex);
                doctorsList.innerHTML = "";
                const selectedDate = document.getElementById("datePicker").value;

                const availabilityPromises = currentDoctors.map(async (doctor) => {
                    let displayAvailability = doctor.availability || "Available";
                    try {
                        const res = await fetch(`/api/doctors/${doctor._id}/availability?date=${selectedDate}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.start && data.end) {
                                displayAvailability = `${data.start} - ${data.end}`;
                            }
                        }
                    } catch (err) { }
                    return displayAvailability;
                });
                const availabilities = await Promise.all(availabilityPromises);
                currentDoctors.forEach((doctor, idx) => {
                    let infoLine = "";
                    if (doctor.experience && doctor.qualification) {
                        infoLine = `${doctor.experience} yrs exp.  ${doctor.qualification}`;
                    } else if (doctor.experience) {
                        infoLine = `${doctor.experience} yrs exp.`;
                    } else if (doctor.qualification) {
                        infoLine = `${doctor.qualification}`;
                    }
                    let count = 0;
                    const doctorName = doctor.name;
                    if (todaysAppointmentsCountMap && doctorName in todaysAppointmentsCountMap) {
                        count = todaysAppointmentsCountMap[doctorName];
                    }
                    doctorsList.innerHTML += `
<div class="grid grid-cols-12 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
  <div class="col-span-3 flex items-center">
    <div class="w-8 h-8 rounded-full mr-4 flex-shrink-0 overflow-hidden bg-gray-200 doctor-photo-placeholder" data-doctor-id="${doctor._id}" data-doctor-index="${startIndex + idx
                        }" style="cursor:pointer;">
      ${doctor.image
                            ? `<img src="${doctor.image.startsWith("/uploads/") ? doctor.image : "/uploads/" + doctor.image}" alt="${doctor.name}" class="w-full h-full object-cover" />`
                            : `<img src="/default.jpg" alt="No Photo" class="w-full h-full object-cover opacity-50" />`
                        }
    </div>
 <div>
      <div class="font-semibold text-gray-800 ${doctor.isDeleted ? 'line-through text-gray-300' : ''}">${doctor.name}</div>
      <div class="text-xs text-gray-500 ${doctor.isDeleted ? 'line-through text-gray-300' : ''}">${infoLine}</div>
    </div>
  </div>
  <div class="col-span-3 text-gray-600 ${doctor.isDeleted ? 'line-through text-gray-300' : ''}">${doctor.specialty || "General Medicine"}</div>
  <div class="col-span-3 text-gray-600 ml-16  ${doctor.isDeleted ? 'line-through text-gray-300' : ''}">${count}</div>
  <div class="col-span-3 text-gray-600 ${doctor.isDeleted ? 'line-through text-gray-300' : ''}">${availabilities[idx]}</div>
  
</div>
`;

// <div class="col-span-2 relative">
//     <button class="action-btn text-xl">...</button>
//   ${doctor.isDeleted ? `
//         <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
//           <button onclick="openRestoreDoctorModal('${doctor._id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Restore</button>
//         </div>
//       ` : `
    
//     <div class="action-menu hidden absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-md shadow-lg py-1 z-20">
//       <a href="#" class="view-profile-btn block px-4 py-2 hover:bg-gray-100 text-gray-700" data-doctor='${JSON.stringify(doctor)}'>View Profile</a>
//       <a href="#" class="edit-doctor-profile-btn block px-4 py-2 hover:bg-gray-100 text-gray-700" data-doctor='${JSON.stringify(doctor)}'>Edit Profile</a>
//       <a href="#" class="manage-availability-btn block px-4 py-2 hover:bg-gray-100 text-gray-700" data-doctor='${JSON.stringify(doctor)}'>Manage Availability</a>
//       <button onclick="openDeleteDoctorModal('${doctor._id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Delete</button>
//     </div>
//       `}
//   </div>
                    document.querySelectorAll('.manage-availability-btn').forEach(button => {
                        button.addEventListener('click', function (e) {
                            e.preventDefault();
                            const doctor = JSON.parse(this.dataset.doctor);
                            const doctorNameDisplay = document.getElementById('manageDoctorName');
                            doctorNameDisplay.textContent = ` ${doctor.name} (${doctor.specialty || "General Medicine"})`;
                            document.getElementById('availabilityModalOverlay').classList.remove('hidden');
                            document.getElementById('closeAvailabilityModal')?.addEventListener('click', () => {
                                document.getElementById('availabilityModalOverlay').classList.add('hidden');
                            });
                        });
                    });
                });
                updateDoctorsPagination(totalPages);
            }

            function updateDoctorsPagination(totalPages) {
                const paginationContainer = document.getElementById("doctorsPagination");
                const prevButton = document.getElementById("prevDoctorsPage");
                const nextButton = document.getElementById("nextDoctorsPage");
                const pageInfo = document.getElementById("doctorsPageInfo");
                if (!paginationContainer) return;
                if (totalPages > 1) {
                    paginationContainer.classList.remove("hidden");
                } else {
                    paginationContainer.classList.add("hidden");
                }
                pageInfo.textContent = `Page ${currentDoctorsPage} of ${totalPages}`;
                prevButton.disabled = currentDoctorsPage === 1;
                nextButton.disabled = currentDoctorsPage === totalPages;
            }
            document.addEventListener("DOMContentLoaded", function () {
                const prevButton = document.getElementById("prevDoctorsPage");
                const nextButton = document.getElementById("nextDoctorsPage");

                if (prevButton) {
                    prevButton.addEventListener("click", () => {
                        if (currentDoctorsPage > 1) {
                            currentDoctorsPage--;
                            renderDoctorsPage();
                        }
                    });
                }

                if (nextButton) {
                    nextButton.addEventListener("click", () => {
                        const totalPages = Math.ceil(allDoctors.length / doctorsPerPage);
                        if (currentDoctorsPage < totalPages) {
                            currentDoctorsPage++;
                            renderDoctorsPage();
                        }
                    });
                }
            });

            flatpickr("#rescheduleDate", {
                dateFormat: "Y-m-d",
            });

            function renderPatientsListFromData(patients) {
                if (!patients || patients.length === 0) {
                    patientsList.innerHTML = `
        <div class="p-4 text-center text-gray-500">
          <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="text-lg font-medium mb-2">No patients found</p>
          <p class="text-sm">No patients found with appointments on ${formattedDate}</p>
        </div>
      `;
                    return;
                }
                let tableHTML = `
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-700 text-left">
              <th class="px-4 py-3">Patient</th>
              <th class="px-4 py-3">Age/Gender</th>
              <th class="px-4 py-3">Blood</th>
              <th class="px-4 py-3">Contact</th>
              <th class="px-4 py-3">Upcoming Date</th>
              <th class="px-4 py-3">Last Visit</th>
            </tr>
          </thead>
          <tbody>
         
          </tbody>
        </table>
      </div>
    `;
                patientsList.innerHTML = tableHTML;
            }
            testPatientsPagination();
            if (document.getElementById("appointmentStatusFilter")) {
                document.getElementById("appointmentStatusFilter").addEventListener("change", function () {
                    const status = this.value;
                    const currentDate = datePicker.value;
                    const searchTerm = searchInput.value.trim();
                    console.log("Dropdown changed", status);
                    renderAppointmentsList(currentDate, searchTerm, status);
                });
            }

            let currentDoctorForEdit = null;

            function openEditDoctorModal(doctor) {
                currentDoctorForEdit = doctor;
                document.getElementById("editDoctorName").value = doctor.name || "";
                document.getElementById("editDoctorSpecialization").value = doctor.specialty || "";
                document.getElementById("editDoctorExperience").value = doctor.experience || "";
                document.getElementById("editDoctorQualification").value = doctor.qualification || "";
                document.getElementById("editDoctorAvailability").value = doctor.availability || "";
                document.getElementById("editDoctorAge").value = doctor.age || "";
                document.getElementById("editDoctorGender").value = doctor.gender || "";
                document.getElementById("editDoctorPhone").value = doctor.phone || "";
                document.getElementById("editDoctorAddress").value = doctor.address || "";
                const photoPreview = document.getElementById("editDoctorPhotoPreview");
                const defaultIcon = document.getElementById("editDoctorDefaultIcon");
                if (doctor.image) {
                    photoPreview.src = `http://localhost:3022${doctor.image}`;
                    photoPreview.style.display = "block";
                    defaultIcon.style.display = "none";
                } else {
                    photoPreview.src = "";
                    photoPreview.style.display = "none";
                    defaultIcon.style.display = "flex";
                }
                document.getElementById("editDoctorProfileModalOverlay").classList.remove("hidden");
            }

            function closeEditDoctorModal() {
                document.getElementById("editDoctorProfileModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
                currentDoctorForEdit = null;
            }

            document.getElementById("closeEditDoctorModal").onclick = closeEditDoctorModal;
            document.getElementById("editDoctorModalOverlay").onclick = function (e) {
                if (e.target === this) closeEditDoctorModal();
            };

            document.getElementById("doctorsList").addEventListener("click", function (e) {
                if (e.target.classList.contains("edit-doctor-profile-btn")) {
                    e.preventDefault();
                    const doctor = JSON.parse(e.target.getAttribute("data-doctor"));
                    openEditDoctorModal(doctor);
                    e.target.closest(".action-menu").classList.add("hidden");
                }
            });
            if (document.getElementById("doctorsList")) {
                document.getElementById("doctorsList").addEventListener("click", function (e) {
                    if (e.target.classList.contains("doctor-photo-placeholder")) {
                        const idx = e.target.getAttribute("data-doctor-index");
                        const input = document.querySelector(`.doctor-photo-input[data-doctor-index="${idx}"]`);
                        if (input) input.click();
                    }
                });
                document.getElementById("doctorsList").addEventListener("change", function (e) {
                    if (e.target.classList.contains("doctor-photo-input")) {
                        const idx = e.target.getAttribute("data-doctor-index");
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (ev) {
                                allDoctors[idx].photoUrl = ev.target.result;
                                renderDoctorsPage();
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                });
            }

            flatpickr("#availabilityDate", {
                dateFormat: "m/d/Y",
                allowInput: false,
                static: true,
            });
            flatpickr("#availabilityStart", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",
                time_24hr: false,
                allowInput: false,
                static: true,
            });
            flatpickr("#availabilityEnd", {
                enableTime: true,
                noCalendar: true,
                dateFormat: "h:i K",
                time_24hr: false,
                allowInput: false,
                static: true,
            });

            document.getElementById("rescheduleForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const appointmentId = window.selectedAppointment?._id;
                const newDate = document.querySelector("#rescheduleCalendarContainer input")?.value;
                const newTime = document.querySelector("#rescheduleTimeSlotsContainer input")?.value;

                if (!appointmentId || !newDate || !newTime) {
                    showToast("Please select both date and time.", 'warning');
                    return;
                }

                try {
                    const response = await fetch(`/api/confirmations/${appointmentId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            action: "reschedule",
                            date: newDate,
                            time: newTime,
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showToast("Appointment successfully rescheduled!", 'success');
                        document.getElementById("rescheduleModalOverlay").classList.add("hidden");

                        const date = document.getElementById("datePicker").value;
                        const status = document.getElementById("appointmentStatusFilter").value;
                        renderAppointmentsList(date, searchInput.value.trim(), status);
                    } else {
                        throw new Error(result.error || "Failed to reschedule appointment");
                    }
                } catch (err) {
                    showToast("Error rescheduling appointment: " + err.message, 'error');
                }
            });

            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("reschedule-btn")) {
                    e.preventDefault();
                    const appointment = JSON.parse(e.target.dataset.appointment);
                    window.selectedAppointment = appointment;
                    document.getElementById("rescheduleModalOverlay").classList.remove("hidden");
                }
            });

            document.addEventListener("DOMContentLoaded", function () {
                const statusFilter = document.getElementById("appointmentStatusFilter");
                if (statusFilter) {
                    statusFilter.addEventListener("change", function () {
                        const status = this.value;
                        const currentDate = datePicker.value;
                        const searchTerm = searchInput.value.trim();
                        console.log("Dropdown changed", status);
                        renderAppointmentsList(currentDate, searchTerm, status);
                    });
                }
            });

            let currentDoctorForEditProfile = null;
            if (document.getElementById("doctorsList")) {
                document.getElementById("doctorsList").addEventListener("click", function (e) {
                    if (e.target.classList.contains("edit-doctor-profile-btn")) {
                        e.preventDefault();
                        const doctor = JSON.parse(e.target.getAttribute("data-doctor"));
                        currentDoctorForEditProfile = doctor;
                        document.getElementById("editDoctorName").value = doctor.name || "";
                        populateSpecialtyDropdown("editDoctorSpecialization");
                        document.getElementById("editDoctorSpecialization").value = (doctor.specialty || "");
                        document.getElementById("editDoctorExperience").value = doctor.experience || "";
                        document.getElementById("editDoctorQualification").value = doctor.qualification || "";
                        document.getElementById("editDoctorAvailability").value = doctor.availability || "";
                        document.getElementById("editDoctorAge").value = doctor.age || "";
                        document.getElementById("editDoctorGender").value = doctor.gender || "";
                        document.getElementById("editDoctorPhone").value = doctor.phone || "";
                        document.getElementById("editDoctorAddress").value = doctor.address || "";
                        document.getElementById("editDoctorProfileModalOverlay").classList.remove("hidden");
                        document.body.classList.add("blurred-bg");
                        e.target.closest(".action-menu").classList.add("hidden");
                    }
                });
            }
            document.getElementById("closeEditDoctorProfileModal").onclick = closeEditDoctorProfileModal;
            document.getElementById("editDoctorProfileModalOverlay").onclick = function (e) {
                if (e.target === this) closeEditDoctorProfileModal();
            };
            function closeEditDoctorProfileModal() {
                document.getElementById("editDoctorProfileModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
                currentDoctorForEditProfile = null;
            }
            document.getElementById("editDoctorForm").onsubmit = async function (e) {
                e.preventDefault();
                if (!currentDoctorForEditProfile || !currentDoctorForEditProfile._id) {
                    showToast("No doctor selected for editing.", 'warning');
                    return;
                }
                const formData = new FormData();
                formData.append("name", document.getElementById("editDoctorName").value);
                formData.append("specialty", document.getElementById("editDoctorSpecialization").value);
                formData.append("experience", document.getElementById("editDoctorExperience").value);
                formData.append("qualification", document.getElementById("editDoctorQualification").value);
                formData.append("availability", document.getElementById("editDoctorAvailability").value);
                formData.append("age", document.getElementById("editDoctorAge").value);
                formData.append("gender", document.getElementById("editDoctorGender").value);
                formData.append("phone", document.getElementById("editDoctorPhone").value);
                formData.append("address", document.getElementById("editDoctorAddress").value);
                const photoInput = document.getElementById("editDoctorPhoto");
                if (photoInput.files && photoInput.files[0]) {
                    formData.append("photo", photoInput.files[0]);
                }
                try {
                    const response = await fetch(`/api/doctors/${currentDoctorForEditProfile._id}`, {
                        method: "PUT",
                        body: formData,
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || "Failed to update doctor");
                    }
                    closeEditDoctorProfileModal();
                    await fetchAndDisplayDoctors(document.getElementById("datePicker").value);
                    showToast("Doctor profile updated successfully!", 'success');
                } catch (err) {
                    console.error("Error updating doctor:", err);
                    showToast("Error updating doctor: " + err.message, 'error');
                }
            };

            document.getElementById("editDoctorPhoto").addEventListener("change", function (event) {
                const file = event.target.files[0];
                const photoPreview = document.getElementById("editDoctorPhotoPreview");
                const defaultIcon = document.getElementById("editDoctorDefaultIcon");
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        photoPreview.src = e.target.result;
                        photoPreview.style.display = "block";
                        defaultIcon.style.display = "none";
                    };
                    reader.readAsDataURL(file);
                } else {
                    photoPreview.src = "";
                    photoPreview.style.display = "none";
                    defaultIcon.style.display = "flex";
                }
            });
        </script>
        <script>
            console.log("[DEBUG] Script loaded at end of HTML");
            document.addEventListener("DOMContentLoaded", function () {
                const qualificationGrid = document.getElementById("qualificationGrid");

                qualificationGrid.addEventListener("click", function (e) {
                    if (e.target && e.target.id === "addQualificationBtn") {
                        const newField = document.createElement("div");
                        newField.className = "flex items-center gap-2 mt-2";

                        newField.innerHTML = `
                <input
                    type="text"
                    name="qualification"
                    class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    placeholder="e.g., Cardiology"
                    required
                />
                <button
                    type="button"
                    class="removeQualificationBtn w-[42px] h-[42px] bg-red-600 hover:bg-red-700 text-white rounded-lg text-lg font-bold flex items-center justify-center"
                    title="Remove"
                >
                    &minus;
                </button>
            `;

                        qualificationGrid.appendChild(newField);
                    }

                    if (e.target && e.target.classList.contains("removeQualificationBtn")) {
                        const row = e.target.closest("div");
                        if (row) {
                            qualificationGrid.removeChild(row);
                        }
                    }
                });
            });

            document.addEventListener("DOMContentLoaded", function () {
                const qualificationGrid = document.getElementById("qualificationGrid");

                qualificationGrid.addEventListener("click", function (e) {
                    if (e.target.closest(".addQualificationBtn")) {
                        const newRow = document.createElement("div");
                        newRow.className = "flex items-center gap-2 mt-2";

                        newRow.innerHTML = `
        <input
          type="text"
          name="qualification"
          class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none"
          placeholder="e.g., Neurology"
          required
        />
        <button
          type="button"
          class="removeQualificationBtn w-[42px] h-[42px] bg-red-600 hover:bg-red-700 text-white rounded-lg text-lg font-bold flex items-center justify-center"
          title="Remove"
        >
          &minus;
        </button>
      `;
                        qualificationGrid.appendChild(newRow);
                    }

                    if (e.target.closest(".removeQualificationBtn")) {
                        const row = e.target.closest("div");
                        if (row) row.remove();
                    }
                });
            });
        </script>

        <script>
            if (document.getElementById("doctorsList")) {
                document.getElementById("doctorsList").addEventListener("click", function (e) {
                    if (e.target.classList.contains("view-profile-btn")) {
                        e.preventDefault();
                        const doctor = JSON.parse(e.target.getAttribute("data-doctor"));
                        document.getElementById("profileDoctorName").textContent = doctor.name || "";
                        document.getElementById("profileDoctorSpecialty").textContent = doctor.specialty || "";
                        document.getElementById("profileDoctorExperience").textContent = doctor.experience || "";
                        document.getElementById("profileDoctorQualification").textContent = doctor.qualification || "";
                        document.getElementById("profileDoctorAvailability").textContent = doctor.availability || "";
                        document.getElementById("profileDoctorAge").textContent = doctor.age || "";
                        document.getElementById("profileDoctorGender").textContent = doctor.gender || "";
                        document.getElementById("profileDoctorPhone").textContent = doctor.phone || "";
                        document.getElementById("profileDoctorAddress").textContent = doctor.address || "";
                        document.getElementById("profileDoctorImage").src = doctor.image || "/default.jpg";
                        document.getElementById("viewDoctorProfileModalOverlay").classList.remove("hidden");
                        const ageWrapper = document.getElementById('profileDoctorAgeWrapper');
                        const ageElement = document.getElementById('profileDoctorAge');
                        if (doctor.age) {
                            ageElement.textContent = doctor.age;
                            ageWrapper.classList.remove("hidden");
                        } else {
                            ageElement.textContent = '';
                            ageWrapper.classList.add("hidden");
                        }

                        const genderWrapper = document.getElementById('profileDoctorGenderWrapper');
                        const genderElement = document.getElementById('profileDoctorGender');
                        if (doctor.gender) {
                            genderElement.textContent = doctor.gender;
                            genderWrapper.classList.remove("hidden");
                        } else {
                            genderElement.textContent = '';
                            genderWrapper.classList.add("hidden");
                        }

                        const phoneWrapper = document.getElementById('profileDoctorPhoneWrapper');
                        const phoneElement = document.getElementById('profileDoctorPhone');
                        if (doctor.phone) {
                            phoneElement.textContent = doctor.phone;
                            phoneWrapper.classList.remove("hidden");
                        } else {
                            phoneElement.textContent = '';
                            phoneWrapper.classList.add("hidden");
                        }
                        const addressWrapper = document.getElementById('profileDoctorAddressWrapper');
                        const addressElement = document.getElementById('profileDoctorAddress');
                        if (doctor.address) {
                            addressElement.textContent = doctor.address;
                            addressWrapper.classList.remove("hidden");
                        } else {
                            addressElement.textContent = '';
                            addressWrapper.classList.add("hidden");
                        }
                        document.body.classList.add("blurred-bg");
                        e.target.closest(".action-menu").classList.add("hidden");
                    }
                });
            }
            document.getElementById("closeViewDoctorProfileModal").onclick = closeViewDoctorProfileModal;
            document.getElementById("closeViewDoctorProfileBtn").onclick = closeViewDoctorProfileModal;

            function closeViewDoctorProfileModal() {
                document.getElementById("viewDoctorProfileModalOverlay").classList.add("hidden");
                document.body.classList.remove("blurred-bg");
            }
        </script>
        <script>
            if (document.getElementById("doctorsList")) {
                document.getElementById("doctorsList").addEventListener("click", function (e) {
                    if (e.target.classList.contains("manage-availability-btn")) {
                        e.preventDefault();
                        const doctor = JSON.parse(e.target.getAttribute("data-doctor"));
                        openAvailabilityModal(doctor);
                        e.target.closest(".action-menu").classList.add("hidden");
                    }
                });
            }
        </script>

        <script>
            console.log("[DEBUG] Script loaded at end of HTML");
            document.addEventListener("DOMContentLoaded", function () {
                const statusFilter = document.getElementById("appointmentStatusFilter");
                console.log("Attaching event to:", statusFilter);
                if (statusFilter) {
                    statusFilter.addEventListener("change", function () {
                        const status = this.value;
                        const currentDate = datePicker.value;
                        const searchTerm = searchInput.value.trim();
                        console.log("Dropdown changed", status);
                        renderAppointmentsList(currentDate, searchTerm, status);
                    });
                }
            });
        </script>

        <script>
            function setupActionMenus() {
                document.querySelectorAll(".action-btn").forEach((btn) => {
                    btn.onclick = function (e) {
                        document.querySelectorAll(".action-menu").forEach((menu) => menu.classList.add("hidden"));
                        const menu = btn.nextElementSibling;
                        if (menu) {
                            const rect = btn.getBoundingClientRect();

                            menu.style.visibility = "hidden";
                            menu.style.display = "block";
                            menu.style.top = "-9999px";
                            menu.style.left = "-9999px";

                            const menuHeight = menu.offsetHeight;
                            let top = rect.top + window.scrollY;

                            if (rect.bottom + menuHeight > window.innerHeight) {
                                top = rect.top + window.scrollY - menuHeight;

                                if (top < window.scrollY) {
                                    top = window.scrollY;
                                }
                            }
                            let left = rect.left + window.scrollX;

                            menu.style.top = top + "px";
                            menu.style.left = left + "px";
                            menu.style.visibility = "visible";
                            menu.style.display = "block";
                            menu.classList.remove("hidden");
                        }
                        e.stopPropagation();
                    };
                });
                document.addEventListener("click", function () {
                    document.querySelectorAll(".action-menu").forEach((menu) => menu.classList.add("hidden"));
                });
            }

            function openEditDoctorModal(doctor) {
                document.getElementById("editDoctorName").value = doctor.name || "";
                document.getElementById("editDoctorSpecialization").value = doctor.specialty || "";
                document.getElementById("editDoctorExperience").value = doctor.experience || "";
                document.getElementById("editDoctorAvailability").value = doctor.availability || "";
                document.getElementById("editDoctorQualification").value = doctor.qualification || "";
                document.getElementById("editDoctorPhotoPreview").src = doctor.image ? `http://localhost:3022${doctor.image}` : "/default.jpg";
                document.getElementById("editDoctorProfileModalOverlay").classList.remove("hidden");
                const photoPreview = document.getElementById("editDoctorPhotoPreview");
                const defaultIcon = document.getElementById("editDoctorDefaultIcon");
                if (doctor.image) {
                    photoPreview.src = `http://localhost:3022${doctor.image}`;
                    photoPreview.style.display = "block";
                    defaultIcon.style.display = "none";
                } else {
                    photoPreview.src = "";
                    photoPreview.style.display = "none";
                    defaultIcon.style.display = "flex";
                }
                document.getElementById("editDoctorProfileModalOverlay").classList.remove("hidden");
            }

            document.getElementById("closeEditDoctorProfileModal").addEventListener("click", () => {
                document.getElementById("editDoctorProfileModalOverlay").classList.add("hidden");
            });
            document.getElementById("cancelEditDoctorBtn").addEventListener("click", () => {
                document.getElementById("editDoctorProfileModalOverlay").classList.add("hidden");
            });

            document.getElementById("editDoctorPhoto").addEventListener("change", function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById("editDoctorPhotoPreview").src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("edit-doctor-profile-btn")) {
                    e.preventDefault();
                    const doctorData = JSON.parse(e.target.dataset.doctor);
                    openEditDoctorModal(doctorData);
                }
            });
        </script>
        <script>
            console.log("[DEBUG] Script loaded at end of HTML");
            document.addEventListener("DOMContentLoaded", function () {
                var closeBtn = document.getElementById("closeViewDoctorProfileBtn");
                if (closeBtn) {
                    closeBtn.onclick = closeViewDoctorProfileModal;
                }
            });
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                let currentDoctorForEditProfile = null;

                if (document.getElementById("doctorsList")) {
                    document.getElementById("doctorsList").addEventListener("click", function (e) {
                        if (e.target.classList.contains("edit-doctor-profile-btn")) {
                            e.preventDefault();
                            const doctor = JSON.parse(e.target.getAttribute("data-doctor"));
                            currentDoctorForEditProfile = doctor;

                            document.getElementById("editDoctorName").value = doctor.name || "";
                            document.getElementById("editDoctorSpecialization").value = doctor.specialty || "";
                            document.getElementById("editDoctorExperience").value = doctor.experience || "";
                            document.getElementById("editDoctorQualification").value = doctor.qualification || "";
                            document.getElementById("editDoctorAvailability").value = doctor.availability || "";
                            document.getElementById("editDoctorAge").value = doctor.age || "";
                            document.getElementById("editDoctorGender").value = doctor.gender || "";
                            document.getElementById("editDoctorPhone").value = doctor.phone || "";
                            document.getElementById("editDoctorAddress").value = doctor.address || "";

                            document.getElementById("editDoctorProfileModalOverlay").classList.remove("hidden");
                            document.body.classList.add("blurred-bg");
                            e.target.closest(".action-menu").classList.add("hidden");
                        }
                    });
                }

                function closeEditDoctorProfileModal() {
                    document.getElementById("editDoctorProfileModalOverlay").classList.add("hidden");
                    document.body.classList.remove("blurred-bg");
                    currentDoctorForEditProfile = null;
                }
                if (document.getElementById("closeEditDoctorProfileModal")) {
                    document.getElementById("closeEditDoctorProfileModal").onclick = closeEditDoctorProfileModal;
                }
                if (document.getElementById("cancelEditDoctorBtn")) {
                    document.getElementById("cancelEditDoctorBtn").onclick = closeEditDoctorProfileModal;
                }

                if (document.getElementById("editDoctorForm")) {
                    document.getElementById("editDoctorForm").onsubmit = async function (e) {
                        e.preventDefault();

                        if (!currentDoctorForEditProfile || !currentDoctorForEditProfile._id) {
                            showToast("No doctor selected for editing.", 'warning');
                            return;
                        }

                        const formData = new FormData();
                        formData.append("name", document.getElementById("editDoctorName").value);
                        formData.append("specialty", document.getElementById("editDoctorSpecialization").value);
                        formData.append("experience", document.getElementById("editDoctorExperience").value);
                        formData.append("qualification", document.getElementById("editDoctorQualification").value);
                        formData.append("availability", document.getElementById("editDoctorAvailability").value);
                        formData.append("age", document.getElementById("editDoctorAge").value);
                        formData.append("gender", document.getElementById("editDoctorGender").value);
                        formData.append("phone", document.getElementById("editDoctorPhone").value);
                        formData.append("address", document.getElementById("editDoctorAddress").value);

                        // const photoInput = document.getElementById("editDoctorPhoto");
                        // if (photoInput.files.length > 0) {
                        //     formData.append("photo", photoInput.files[0]);
                        // }

                        try {
                            const response = await fetch(`/api/doctors/${currentDoctorForEditProfile._id}`, {
                                method: "PUT",
                                body: formData,
                            });

                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                throw new Error(errorData.error || "Failed to update doctor");
                            }

                            closeEditDoctorProfileModal();
                            await fetchAndDisplayDoctors(document.getElementById("datePicker").value);
                            showToast("Doctor profile updated successfully!", 'success');
                        } catch (err) {
                            console.error("Error updating doctor:", err);
                            showToast("Error updating doctor: " + err.message, 'error');
                        }
                    };
                }

                // if (document.getElementById("editDoctorPhoto")) {
                //     document.getElementById("editDoctorPhoto").addEventListener("change", function (event) {
                //         const file = event.target.files[0];
                //         if (file) {
                //             const reader = new FileReader();
                //             reader.onload = function (e) {
                //                 document.getElementById("editDoctorPhotoPreview").src = e.target.result;
                //             };
                //             reader.readAsDataURL(file);
                //         }
                //     });
                // }
            });
        </script>
        <script>
            document.getElementById("doctorsList").addEventListener("click", function (e) {
                if (e.target.closest(".doctor-photo-placeholder")) {
                    const photoDiv = e.target.closest(".doctor-photo-placeholder");
                    const doctorId = photoDiv.getAttribute("data-doctor-id");
                    const idx = photoDiv.getAttribute("data-doctor-index");
                    const doctor = allDoctors[parseInt(idx)];
                    const imgTag = photoDiv.querySelector("img");
                    const imageUrl = imgTag ? imgTag.getAttribute("src") : "/default.jpg";
                    if (imageUrl.includes("default.jpg")) {
                        const fileInput = document.getElementById("doctorPhotoInput");
                        fileInput.value = "";
                        fileInput.onchange = function (event) {
                            const file = event.target.files[0];
                            if (file) {
                                const formData = new FormData();
                                formData.append("photo", file);
                                fetch(`/api/doctors/${doctorId}`, {
                                    method: "PUT",
                                    body: formData,
                                })
                                    .then((res) => res.json())
                                    .then((data) => {
                                        if (data.image) {
                                            allDoctors[parseInt(idx)].image = "/uploads/" + data.image;
                                            renderDoctorsPage();
                                        } else {
                                            showToast("Upload failed", 'error');
                                        }
                                    })
                                    .catch(() => showToast("Upload error", 'error'));
                            }
                        };
                        fileInput.click();
                    } else {
                        const modal = document.getElementById("doctorPhotoModal");
                        const modalImg = document.getElementById("doctorPhotoModalImg");
                        modalImg.src = imageUrl;
                        modal.style.display = "flex";
                        modal.onclick = function () {
                            modal.style.display = "none";
                        };
                    }
                }
            });
        </script>
        <script>
            const editDoctorPhone = document.getElementById("editDoctorPhone");
            if (editDoctorPhone) {
                editDoctorPhone.addEventListener("input", function () {
                    let value = this.value.replace(/\D/g, "");

                    if (value.length === 1 && !/[6-9]/.test(value[0])) {
                        value = "";
                    }

                    if (value.length > 10) value = value.slice(0, 10);
                    this.value = value;
                });
                editDoctorPhone.addEventListener("paste", function (e) {
                    e.preventDefault();
                    const text = (e.originalEvent || e).clipboardData.getData("text/plain");
                    let cleaned = text.replace(/\D/g, "").slice(0, 10);
                    if (cleaned.length > 0 && !/[6-9]/.test(cleaned[0])) cleaned = "";
                    this.value = cleaned;
                });
            }

            const editDoctorForm = document.getElementById("editDoctorForm");
            if (editDoctorForm) {
                editDoctorForm.addEventListener("submit", function (e) {
                    const phone = editDoctorPhone.value;
                    const phonePattern = /^[6-9][0-9]{9}$/;
                    if (!phonePattern.test(phone)) {
                        showToast("Phone number must be 10 digits and start with 6, 7, 8, or 9.", 'warning');
                        editDoctorPhone.focus();
                        e.preventDefault();
                        return false;
                    }
                });
            }
            function setActiveTab(tabName) {
                localStorage.setItem('adminDashboardActiveTab', tabName);
            }
            function getActiveTab() {
                return localStorage.getItem('adminDashboardActiveTab') || 'appointmentsTab';
            }

            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    setActiveTab(this.getAttribute('data-tab'));
                });
            });

            document.addEventListener('DOMContentLoaded', function () {
                const activeTab = getActiveTab();
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.getAttribute('data-tab') === activeTab) {
                        tab.classList.add('tab-active');
                        tab.classList.remove('tab-inactive');
                    } else {
                        tab.classList.remove('tab-active');
                        tab.classList.add('tab-inactive');
                    }
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    if (content.id === activeTab) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });

                const date = datePicker.value;
                const searchTerm = searchInput.value.trim();
                const status = document.getElementById('appointmentStatusFilter') ? document.getElementById('appointmentStatusFilter').value : 'all';
                if (activeTab === 'appointmentsTab') {
                    renderAppointmentsList(date, searchTerm, status);
                } else if (activeTab === 'patientsTab') {
                    fetchAndDisplayPatients(date, searchTerm);
                } else if (activeTab === 'doctorsTab') {
                    fetchAndDisplayDoctors(date);
                }
            });

        </script>

        <script>
            const userName = localStorage.getItem("name");
            document.getElementById("userName").textContent = userName;
        </script>
        <script>
            const dropdownToggle = document.getElementById("userDropdownToggle");
            const dropdownMenu = document.getElementById("userDropdownMenu");

            dropdownToggle.addEventListener("click", () => {
                dropdownMenu.classList.toggle("hidden");
            });

            document.addEventListener("click", (event) => {
                if (!dropdownToggle.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.add("hidden");
                }
            });
        </script>
        <script>
            function showLogoutModal() {
                document.getElementById("logoutModal")?.classList.remove("hidden");
                document.getElementById("blurredBg")?.classList.remove("hidden");

            }

            function closeModals() {
                document.getElementById("logoutModal")?.classList.add("hidden");
                document.getElementById("deleteDoctorModal")?.classList.add("hidden");
                document.getElementById("restoreDoctorModal")?.classList.add("hidden");
                document.getElementById("blurredBg")?.classList.add("hidden");
                selectedDoctorId = null;
                selectedRestoreDoctorId = null;
            }
        </script>

        <script>
            function getInitials(name) {
                if (!name) return "";
                const parts = name.trim().split(" ");
                if (parts.length === 1) return parts[0][0].toUpperCase();
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            const AdminName = localStorage.getItem("name") || "admin";
            document.getElementById("userName").textContent = userName;
            document.getElementById("userAvatar").textContent = getInitials(userName);
        </script>
        <script>
            async function logout() {
                try {
                    const token = localStorage.getItem('admin_jwt');
                    const res = await fetch("/api/admin/logout", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ token }),
                    });
                    const result = await res.json();
                    if (res.ok) {
                        localStorage.clear();
                        window.location.href = "login.html";
                    } else {
                        showToast(result.error, 'error');
                    }
                } catch (err) {
                    showToast("Error: " + err.message, 'error');
                }
            };
        </script>

        <div id="blurredBg" class="hidden fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm z-40"></div>

        <div id="deleteDoctorModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
            <div class="bg-white p-6 rounded shadow-lg w-full max-w-sm text-center">
                <p class="mb-8 text-gray-600">Are you sure you want to delete?</p>
                <div class="flex justify-center gap-4">
                    <button onclick="closeModals()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                    <button onclick="confirmDeleteDoctor()"
                        class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
                </div>
            </div>
        </div>
        <div id="restoreDoctorModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
            <div class="bg-white p-6 rounded shadow-lg w-full max-w-sm text-center">
                <p class="mb-8 text-gray-600">Are you sure you want to restore?</p>
                <div class="flex justify-center gap-4">
                    <button onclick="closeModals()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                    <button onclick="confirmRestoreDoctor()"
                        class="px-4 py-2 bg-red-600 text-white rounded">Restore</button>
                </div>
            </div>
        </div>
        <div id="blurredBg" class="fixed inset-0 bg-white/30 backdrop-blur-sm hidden z-40"></div>
        <div id="logoutModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden z-50">
            <div class="bg-white p-6 rounded shadow-lg w-full max-w-sm text-center">
                <h2 class="text-xl font-semibold mb-4">Logout</h2>
                <p class="mb-4 text-gray-600">Are you sure you want to logout?</p>
                <div class="flex justify-center gap-4">
                    <button onclick="closeModals()" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded">Logout</button>
                </div>
            </div>
        </div>
        <div id="adminProfileModal"
            class="fixed inset-0 bg-gray-100 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl p-8 relative">
                <button id="closeAdminProfileModal"
                    class="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-2xl">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Profile & Settings</h2>
                <div class="flex items-center gap-4 mb-6">
                    <div
                        class="w-14 h-14 rounded-full bg-gray-200 flex items-center justify-center text-2xl font-bold text-gray-600">
                        <span id="adminProfileInitials"></span>
                    </div>
                    <div class="flex-1">
                        <input id="adminProfileNameTop"
                            class="text-xl font-semibold text-gray-900 bg-transparent border-none outline-none w-full"
                            readonly />
                    </div>
                    <button id="editProfileBtn"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 font-medium">Edit</button>
                </div>
                <div class="bg-gray-50 rounded-xl p-6">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-500 text-xs mb-1">Name</label>
                            <input id="adminProfileName"
                                class="w-full border border-gray-200 rounded-lg px-3 py-2 bg-gray-100 text-gray-800 font-medium"
                                readonly />
                        </div>
                        <div>
                            <label class="block text-gray-500 text-xs mb-1">Date of Joining</label>
                            <input id="adminProfileJoined"
                                class="w-full border border-gray-200 rounded-lg px-3 py-2 bg-gray-100 text-gray-800 font-medium"
                                disabled />
                        </div>
                        <div>
                            <label class="block text-gray-500 text-xs mb-1">Email</label>
                            <input id="adminProfileEmail"
                                class="w-full border border-gray-200 rounded-lg px-3 py-2 bg-gray-100 text-gray-800 font-medium"
                                readonly />
                        </div>
                        <div>
                            <label class="block text-gray-500 text-xs mb-1">Contact Number</label>
                            <input id="adminProfileContact"
                                class="w-full border border-gray-200 rounded-lg px-3 py-2 bg-gray-100 text-gray-800 font-medium"
                                readonly />
                        </div>
                    </div>
                    <div id="editProfileActions" class="flex gap-3 mt-6 hidden">
                        <button id="cancelProfileBtn"
                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-400">Cancel</button>
                        <button id="saveProfileBtn"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Save</button>

                    </div>
                </div>
                <div class="flex justify-end mt-8">
                    <button id="closeAdminProfileBtn"
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">Close</button>
                </div>
            </div>
        </div>
        <script>
            const profileLink = document.querySelector('#userDropdownMenu a[href=""]');
            const adminProfileModal = document.getElementById('adminProfileModal');
            const closeAdminProfileModal = document.getElementById('closeAdminProfileModal');
            const closeAdminProfileBtn = document.getElementById('closeAdminProfileBtn');
            const adminProfileNameTop = document.getElementById('adminProfileNameTop');
            const adminProfileInitials = document.getElementById('adminProfileInitials');
            const adminProfileName = document.getElementById('adminProfileName');
            const adminProfileJoined = document.getElementById('adminProfileJoined');
            const adminProfileEmail = document.getElementById('adminProfileEmail');
            const adminProfileContact = document.getElementById('adminProfileContact');
            adminProfileContact.addEventListener('keydown', function (e) {
                const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'];
                if (allowedKeys.includes(e.key)) return;

                if (!/^[0-9]$/.test(e.key)) {
                    e.preventDefault();
                    return;
                }

                if (this.value.length >= 10) {
                    e.preventDefault();
                    return;
                }

                if (this.value.length === 0 && !/[6-9]/.test(e.key)) {
                    e.preventDefault();
                    return;
                }
            });
            const editProfileBtn = document.getElementById('editProfileBtn');
            const editProfileActions = document.getElementById('editProfileActions');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelProfileBtn = document.getElementById('cancelProfileBtn');
            let currentAdminId = null;
            let originalName = '';
            let originalEmail = '';
            let originalContact = '';

            function setProfileInitials(name) {
                if (!name || typeof name !== 'string' || !name.trim()) { adminProfileInitials.textContent = ''; return; }
                const parts = name.trim().split(' ');
                adminProfileInitials.textContent = parts.length > 1 ? (parts[0][0] + parts[1][0]).toUpperCase() : name[0].toUpperCase();
            }

            if (profileLink && adminProfileModal) {
                profileLink.addEventListener('click', async function (e) {
                    e.preventDefault();
                    const name = localStorage.getItem('name') || '';
                    adminProfileNameTop.value = name;
                    setProfileInitials(name);
                    try {
                        const token = localStorage.getItem('admin_jwt');
                        const res = await fetch('/api/admin/getAdminProfile', {
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                        });
                        if (res.ok) {
                            const data = await res.json();
                            adminProfileName.value = data.admin.username || '';
                            adminProfileNameTop.value = data.admin.username || '';
                            adminProfileJoined.value = data.admin.createdAt ? new Date(data.admin.createdAt).toLocaleDateString() : '';
                            adminProfileEmail.value = data.admin.email || '';
                            adminProfileContact.value = data.admin.contact || '';
                            originalName = adminProfileName.value;
                            originalEmail = adminProfileEmail.value;
                            originalContact = adminProfileContact.value;
                            currentAdminId = data.admin._id;
                        } else {
                            adminProfileName.value = 'N/A';
                            adminProfileNameTop.value = 'N/A';
                            adminProfileJoined.value = 'N/A';
                            adminProfileEmail.value = 'N/A';
                            adminProfileContact.value = 'N/A';
                            originalName = 'N/A';
                            originalEmail = 'N/A';
                            originalContact = 'N/A';
                            currentAdminId = null;
                        }
                    } catch {
                        adminProfileName.value = 'N/A';
                        adminProfileNameTop.value = 'N/A';
                        adminProfileJoined.value = 'N/A';
                        adminProfileEmail.value = 'N/A';
                        adminProfileContact.value = 'N/A';
                        originalName = 'N/A';
                        originalEmail = 'N/A';
                        originalContact = 'N/A';
                        currentAdminId = null;
                    }
                    adminProfileName.readOnly = true;
                    adminProfileNameTop.readOnly = true;
                    adminProfileEmail.readOnly = true;
                    adminProfileContact.readOnly = true;
                    adminProfileJoined.disabled = true;
                    editProfileActions.classList.add('hidden');
                    adminProfileModal.classList.remove('hidden');
                });
            }
            if (closeAdminProfileModal) closeAdminProfileModal.onclick = () => adminProfileModal.classList.add('hidden');
            if (closeAdminProfileBtn) closeAdminProfileBtn.onclick = () => adminProfileModal.classList.add('hidden');

            if (editProfileBtn) {
                editProfileBtn.onclick = function () {
                    adminProfileName.readOnly = false;
                    adminProfileNameTop.readOnly = false;
                    adminProfileEmail.readOnly = false;
                    adminProfileContact.readOnly = false;
                    adminProfileJoined.disabled = true;
                    adminProfileName.classList.remove('bg-gray-100');
                    adminProfileNameTop.classList.remove('bg-gray-100');
                    adminProfileEmail.classList.remove('bg-gray-100');
                    adminProfileContact.classList.remove('bg-gray-100');
                    editProfileActions.classList.remove('hidden');
                    editProfileBtn.disabled = false;
                };
            }
            if (cancelProfileBtn) {
                cancelProfileBtn.onclick = function () {
                    adminProfileName.value = originalName;
                    adminProfileNameTop.value = originalName;
                    adminProfileEmail.value = originalEmail;
                    adminProfileContact.value = originalContact;
                    adminProfileName.readOnly = true;
                    adminProfileNameTop.readOnly = true;
                    adminProfileEmail.readOnly = true;
                    adminProfileContact.readOnly = true;
                    adminProfileJoined.disabled = true;
                    adminProfileName.classList.add('bg-gray-100');
                    adminProfileNameTop.classList.add('bg-gray-100');
                    adminProfileEmail.classList.add('bg-gray-100');
                    adminProfileContact.classList.add('bg-gray-100');
                    editProfileActions.classList.add('hidden');
                    editProfileBtn.disabled = false;
                };
            }
            if (saveProfileBtn) {
                saveProfileBtn.onclick = async function () {
                    const newName = adminProfileName.value.trim();
                    const newEmail = adminProfileEmail.value.trim();
                    const newContact = adminProfileContact.value.trim();
                    if (!newName) {
                        showToast('Please enter a name.', 'error');
                        return;
                    }
                    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(newEmail)) {
                        showToast('Please enter a valid email address.', 'error');
                        return;
                    }
                    if (!/^[6-9][0-9]{9}$/.test(newContact)) {
                        showToast('Please enter a valid 10-digit mobile number starting with 6-9.', 'error');
                        return;
                    }
                    if (!currentAdminId) {
                        showToast('Admin not loaded.', 'error');
                        return;
                    }
                    try {
                        const token = localStorage.getItem('admin_jwt');
                        const res = await fetch('/api/admin/updateProfile', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ id: currentAdminId, username: newName, email: newEmail, contact: newContact })
                        });
                        if (res.ok) {

                            const refreshed = await fetch('/api/admin/getAdminProfile', { headers: { 'Authorization': `Bearer ${token}` } });
                            if (refreshed.ok) {
                                const data = await refreshed.json();
                                adminProfileName.value = data.admin.username || '';
                                adminProfileNameTop.value = data.admin.username || '';
                                adminProfileJoined.value = data.admin.createdAt ? new Date(data.admin.createdAt).toLocaleDateString() : '';
                                adminProfileEmail.value = data.admin.email || '';
                                adminProfileContact.value = data.admin.contact || '';
                                originalName = adminProfileName.value;
                                originalEmail = adminProfileEmail.value;
                                originalContact = adminProfileContact.value;
                                if (data.admin.username) localStorage.setItem('name', data.admin.username);
                                if (data.admin.email) localStorage.setItem('email', data.admin.email);
                                if (data.admin.contact) localStorage.setItem('contact', data.admin.contact);
                                document.getElementById("userName").textContent = newName;
                                document.getElementById("userAvatar").textContent = getInitials(newName);
                                adminProfileModal.classList.add('hidden');
                                let adminsList = [];
                                try {
                                    adminsList = JSON.parse(localStorage.getItem('adminsList') || '[]');
                                } catch { }
                                if (Array.isArray(adminsList)) {
                                    const idx = adminsList.findIndex(a => a._id === data._id);
                                    if (idx !== -1) {
                                        adminsList[idx].username = data.username;
                                        adminsList[idx].email = data.email;
                                        adminsList[idx].contact = data.contact;
                                        localStorage.setItem('adminsList', JSON.stringify(adminsList));
                                    }
                                }
                            }
                            adminProfileName.readOnly = true;
                            adminProfileNameTop.readOnly = true;
                            adminProfileEmail.readOnly = true;
                            adminProfileContact.readOnly = true;
                            adminProfileJoined.disabled = true;
                            adminProfileName.classList.add('bg-gray-100');
                            adminProfileNameTop.classList.add('bg-gray-100');
                            adminProfileEmail.classList.add('bg-gray-100');
                            adminProfileContact.classList.add('bg-gray-100');
                            editProfileActions.classList.add('hidden');
                            editProfileBtn.disabled = false;
                            showToast('Profile updated successfully!', 'success');
                        } else {
                            const errData = await res.json().catch(() => ({}));
                            showToast(errData.error || 'Failed to update profile.', 'error');
                        }
                    } catch {
                        showToast('Failed to update profile.', 'error');
                    }
                };
            }
        </script>

        <div id="toast"
            class="fixed bottom-4 right-4 z-50 hidden px-6 py-4 rounded-lg font-semibold text-white bg-green-600 shadow-lg transition-all">
        </div>

        <script>
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'fixed bottom-4 right-20 z-50 px-6 py-4 rounded-lg font-semibold text-white shadow-lg space-y-3 transition-all';
                toast.classList.add(type === 'success' ? 'bg-green-600' : 'bg-red-600');
                toast.classList.remove('hidden');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 2000);
            }
        </script>
        <script>
            const specialties = [
                "Cardiology", "Neurology", "Dermatology", "Pediatrics", "Orthopedics", "Radiology",
                "Psychiatry", "ENT", "Gastroenterology", "Oncology", "Anesthesiology", "Pathology",
                "Pulmonology", "Urology", "Nephrology", "Ophthalmology", "General Surgery",
                "Plastic Surgery", "Diabetology", "Rheumatology", "Hematology", "Infectious Disease",
                "Endocrinology", "Obstetrics & Gynecology", "Family Medicine"
            ];

            function populateSpecialtyDropdown(selectId) {
                const select = document.getElementById(selectId);
                if (!select) return;

                select.innerHTML = "";

                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = "Select Specialty";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                specialties.forEach(spec => {
                    const option = document.createElement("option");
                    option.value = spec;
                    option.textContent = spec;
                    select.appendChild(option);
                });
            }
            populateSpecialtyDropdown("doctorSpecialty");
            populateSpecialtyDropdown("addDoctorSpecialization");
            populateSpecialtyDropdown("editDoctorSpecialization");
        </script>
        <script>
            document.addEventListener("click", function () {
                document.querySelectorAll(".action-menu").forEach((menu) => menu.classList.add("hidden"));
            });

            let selectedDoctorId = null;
            function openDeleteDoctorModal(doctorId) {
                selectedDoctorId = doctorId;
                document.getElementById('deleteDoctorModal').classList.remove('hidden');
                document.getElementById('blurredBg').classList.remove('hidden');
                e.target.closest(".action-menu").classList.add("hidden");
            }
            async function confirmDeleteDoctor() {
                if (!selectedDoctorId) return;
                const token = localStorage.getItem("admin_jwt");
                if (!token) {
                    showToast("You are not authorized. Please log in again.", "error");
                    return;
                }
                try {
                    const res = await fetch(`/api/doctors/${selectedDoctorId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`,
                        },
                        body: JSON.stringify({ doctorId: selectedDoctorId, isDeleted: true }),
                    });

                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.message || "Failed to delete admin");
                        showToast(errData.message || "Failed to delete admin", "error")
                    }
                    showToast("Doctor deleted successfully", "success");
                    document.getElementById("deleteDoctorModal")?.classList.add("hidden");
                    document.getElementById("blurredBg")?.classList.add("hidden");
                    closeModals();
                    fetchAndDisplayDoctors();

                } catch (err) {
                    showToast("Delete failed: " + err.message, "error")
                }
            }
        </script>
        <script>
            let selectedRestoreDoctorId = null;
            function openRestoreDoctorModal(doctorId) {
                selectedRestoreDoctorId = doctorId;
                document.getElementById('restoreDoctorModal').classList.remove('hidden');
                document.getElementById('blurredBg').classList.remove('hidden');
                e.target.closest(".action-menu").classList.add("hidden");
            }
            async function confirmRestoreDoctor() {
                if (!selectedRestoreDoctorId) return;
                const token = localStorage.getItem("admin_jwt");
                if (!token) {
                    showToast("You are not authorized. Please log in again.", "error")
                    return;
                }
                try {
                    const res = await fetch(`/api/doctors/${selectedRestoreDoctorId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`,
                        },
                        body: JSON.stringify({ doctorId: selectedRestoreDoctorId, isDeleted: false }),
                    });

                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.message || "Failed to restore admin");
                        showToast(errData.message || "Failed to restore admin", "error")
                    }
                    showToast('Doctor restored successfully', "success");
                    document.getElementById("restoreDoctorModal")?.classList.add("hidden");
                    document.getElementById("blurredBg")?.classList.add("hidden");
                    fetchAndDisplayDoctors();

                } catch (err) {
                    showToast("Restore failed: " + err.message, "error")
                }
            }
        </script>
</body>

</html>